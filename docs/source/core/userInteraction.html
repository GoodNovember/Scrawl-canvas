<!DOCTYPE html>

<html>
<head>
  <title>Core user interaction</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="random-seed.html">
                  ./source/core/random-seed.js
                </a>
              
                
                <a class="source" href="snippets.html">
                  ./source/core/snippets.js
                </a>
              
                
                <a class="source" href="userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/conicGradient.html">
                  ./source/factory/conicGradient.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/crescent.html">
                  ./source/factory/crescent.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/filterEngine-bluenoiseData.html">
                  ./source/factory/filterEngine-bluenoiseData.js
                </a>
              
                
                <a class="source" href="../factory/filterEngine.html">
                  ./source/factory/filterEngine.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/lineSpiral.html">
                  ./source/factory/lineSpiral.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="../factory/net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="../factory/noiseAsset.html">
                  ./source/factory/noiseAsset.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="../factory/particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="../factory/particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="../factory/particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="../factory/particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rawAsset.html">
                  ./source/factory/rawAsset.js
                </a>
              
                
                <a class="source" href="../factory/rdAsset.html">
                  ./source/factory/rdAsset.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetAdvancedFunctionality.html">
                  ./source/mixin/assetAdvancedFunctionality.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="core-user-interaction">Core user interaction</h1>
<p>A set of functions that are closely tied to the <a href="./document.html">core/document.js</a> functionality, and a couple of additional coder convenience functions.</p>
<p>Scrawl-canvas adds some event listeners (mouse movement, screen resize, scrolling) to the window object. These help maintain a centralizerd mouse/touch cursor tracking facility that updates here and then cascades and localizes to artefacts (stacks, canvases and element wrapper objects) which need to keep track of a <strong>local, immediately updated mouse/touch coordinate</strong>.</p>
<p>Checks to see if events have occurred happen once per requestAnimationFrame tick - this is to choke the more eager event listeners which can, at times, fire thousands of times a second.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> library <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./library.js&quot;</span>;
<span class="hljs-keyword">import</span> { xt, xta, isa_dom, isa_fn, isa_boolean, isa_obj, λ<span class="hljs-literal">null</span>, Ωempty, mergeDiscard } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utilities.js&quot;</span>;
<span class="hljs-keyword">import</span> { addListener, addNativeListener, removeListener, removeNativeListener } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./events.js&quot;</span>;

<span class="hljs-keyword">import</span> { makeAnimation } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../factory/animation.js&quot;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p><code>Exported array</code> (to modules). DOM element wrappers subscribe for updates by adding themselves to the <strong>uiSubscribedElements</strong> array. When an event fires, the updated data will be pushed to them automatically</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> uiSubscribedElements = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Local boolean flags. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> trackMouse = <span class="hljs-literal">false</span>,
    mouseChanged = <span class="hljs-literal">false</span>,
    viewportChanged = <span class="hljs-literal">false</span>,
    prefersContrastChanged = <span class="hljs-literal">false</span>,
    prefersReducedMotionChanged = <span class="hljs-literal">false</span>,
    prefersDarkColorSchemeChanged = <span class="hljs-literal">false</span>,
    prefersReduceTransparencyChanged = <span class="hljs-literal">false</span>,
    prefersReduceDataChanged = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p><code>Exported object</code> (to modules and the scrawl object). The <strong>currentCorePosition</strong> object holds the <strong>global</strong> mouse cursor position, alongside browser view dimensions and scroll position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> currentCorePosition = {
    <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollX</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollY</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">w</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">h</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;mouse&#x27;</span>,
    <span class="hljs-attr">prefersReducedMotion</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersDarkColorScheme</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersReduceTransparency</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersContrast</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">prefersReduceData</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">rawTouches</span>: [],
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h3 id="accessibility-preferences">Accessibility preferences</h3>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>contrastMediaQuery</strong> - real-time check on the <code>prefers-reduced-motion</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> contrastMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-contrast: more)&quot;</span>);

contrastMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">let</span> res = contrastMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersContrast</span> !== res) {

        currentCorePosition.<span class="hljs-property">prefersContrast</span> = res;
        prefersContrastChanged = <span class="hljs-literal">true</span>;
    }
});
currentCorePosition.<span class="hljs-property">prefersContrast</span> = contrastMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p><strong>reducedMotionMediaQuery</strong> - real-time check on the <code>prefers-reduced-motion</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedMotionMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-motion: reduce)&quot;</span>);

reducedMotionMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">let</span> res = reducedMotionMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> !== res) {

        currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> = res;
        prefersReducedMotionChanged = <span class="hljs-literal">true</span>;
    }
});
currentCorePosition.<span class="hljs-property">prefersReducedMotion</span> = reducedMotionMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p><strong>colorSchemeMediaQuery</strong> - real-time check on the <code>prefers-color-scheme</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> colorSchemeMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-color-scheme: dark)&quot;</span>);

colorSchemeMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">let</span> res = colorSchemeMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> !== res) {

        currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> = res;
        prefersDarkColorSchemeChanged = <span class="hljs-literal">true</span>;
    }
});
currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span> = colorSchemeMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p><strong>reducedTransparencyMediaQuery</strong> - real-time check on the <code>prefers-reduced-transparency</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedTransparencyMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-transparency: reduce)&quot;</span>);

reducedTransparencyMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">let</span> res = reducedTransparencyMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> !== res) {

        currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> = res;
        prefersReduceTransparencyChanged = <span class="hljs-literal">true</span>;
    }
});
currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span> = reducedTransparencyMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p><strong>reducedDataMediaQuery</strong> - real-time check on the <code>prefers-reduced-data</code> user preference, as set for the device or OS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> reducedDataMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">&quot;(prefers-reduced-data: reduce)&quot;</span>);

reducedDataMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-keyword">let</span> res = reducedDataMediaQuery.<span class="hljs-property">matches</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">prefersReduceData</span> !== res) {

        currentCorePosition.<span class="hljs-property">prefersReduceData</span> = res;
        prefersReduceDataChanged = <span class="hljs-literal">true</span>;
    }
});
currentCorePosition.<span class="hljs-property">prefersReduceData</span> = reducedDataMediaQuery.<span class="hljs-property">matches</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <h3 id="watch-for-browser-window-resize-or-device-rotation-which-trigger-changes-in-the-viewport-dimensions">Watch for browser window resize, or device rotation, which trigger changes in the viewport dimensions</h3>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p><strong>resizeAction</strong> function - to check if a view resize has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> resizeAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

    <span class="hljs-keyword">let</span> w = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>,
        h = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientHeight</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">w</span> !== w || currentCorePosition.<span class="hljs-property">h</span> !== h) {

        currentCorePosition.<span class="hljs-property">w</span> = w;
        currentCorePosition.<span class="hljs-property">h</span> = h;
        mouseChanged = <span class="hljs-literal">true</span>;
        viewportChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h3 id="watch-for-scrolling-interactions">Watch for scrolling interactions</h3>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p><strong>scrollAction</strong> function - to check if a view scroll has occurred; if yes, flag that currentCorePosition object needs to be updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> scrollAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

    <span class="hljs-keyword">let</span> x = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageXOffset</span>,
        y = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>;

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">scrollX</span> !== x || currentCorePosition.<span class="hljs-property">scrollY</span> !== y) {
        currentCorePosition.<span class="hljs-property">x</span> += (x - currentCorePosition.<span class="hljs-property">scrollX</span>);
        currentCorePosition.<span class="hljs-property">y</span> += (y - currentCorePosition.<span class="hljs-property">scrollY</span>);
        currentCorePosition.<span class="hljs-property">scrollX</span> = x;
        currentCorePosition.<span class="hljs-property">scrollY</span> = y;
        mouseChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <h3 id="watch-for-mouse-pointer-and-touch-movement">Watch for mouse, pointer and touch movement</h3>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p><strong>moveAction</strong> function - to check if mouse cursor position has changed; if yes, update currentCorePosition object and flag that the updated needs to cascade to subscribed elements at the next RAF invocation.</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>The events that trigger this function (pointermove, pointerup, pointerdown, pointerleave, pointerenter; or mousemove, mouseup, mousedown, mouseleave, mouseenter) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> moveAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

    <span class="hljs-keyword">let</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(e.<span class="hljs-property">pageX</span>),
        y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(e.<span class="hljs-property">pageY</span>);

    <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">x</span> !== x || currentCorePosition.<span class="hljs-property">y</span> !== y) {
        currentCorePosition.<span class="hljs-property">type</span> = (navigator.<span class="hljs-property">pointerEnabled</span>) ? <span class="hljs-string">&#x27;pointer&#x27;</span> : <span class="hljs-string">&#x27;mouse&#x27;</span>;
        currentCorePosition.<span class="hljs-property">x</span> = x;
        currentCorePosition.<span class="hljs-property">y</span> = y;
        mouseChanged = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p><strong>touchAction</strong> function - maps touch coordinates to the mouse cursor position (via currentCorePosition) and then immediately invokes a cascade update action to all subscribed elements.</p>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>The events that trigger this function (touchstart, touchmove, touchend, touchcancel) are tied to the window object, not to any particular DOM element.</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Note: this is different to mouse moveAction, which is choked via an animation object so update checks happen on each requestAnimationFrame. </p>
<p>TODO: Need to keep an eye on how many times touchAction gets run, for example during a touch-driven drag-and-drop action. If necessary, add a Date.now mediated choke to the check (say minimum 15ms between checks?) to minimize impact on the wider Scrawl-canvas ecosystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> touchActionLastChecked = <span class="hljs-number">0</span>,
    touchActionChoke = <span class="hljs-number">16</span>;

<span class="hljs-keyword">const</span> getTouchActionChoke = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">return</span> touchActionChoke;
};

<span class="hljs-keyword">const</span> setTouchActionChoke = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {

    <span class="hljs-keyword">if</span> (val &amp;&amp; val.<span class="hljs-property">toFixed</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(val)) touchActionChoke = val;
};

<span class="hljs-keyword">const</span> touchAction = <span class="hljs-keyword">function</span> (<span class="hljs-params">e, resetCoordsToZeroOnTouchEnd = <span class="hljs-literal">true</span></span>) {

    currentCorePosition.<span class="hljs-property">rawTouches</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">touches</span> &amp;&amp; e.<span class="hljs-property">touches</span>.<span class="hljs-property">length</span>) {

        currentCorePosition.<span class="hljs-property">rawTouches</span>.<span class="hljs-title function_">push</span>(...e.<span class="hljs-property">touches</span>);

        <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>],
            x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(touch.<span class="hljs-property">pageX</span>),
            y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(touch.<span class="hljs-property">pageY</span>);

        <span class="hljs-keyword">if</span> (currentCorePosition.<span class="hljs-property">x</span> !== x || currentCorePosition.<span class="hljs-property">y</span> !== y) {

            currentCorePosition.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;touch&#x27;</span>;
            currentCorePosition.<span class="hljs-property">x</span> = x;
            currentCorePosition.<span class="hljs-property">y</span> = y;
        }
    }
    <span class="hljs-keyword">else</span> {

        currentCorePosition.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;touch&#x27;</span>;

        <span class="hljs-keyword">if</span> (resetCoordsToZeroOnTouchEnd) {

            currentCorePosition.<span class="hljs-property">x</span> = <span class="hljs-number">0</span>;
            currentCorePosition.<span class="hljs-property">y</span> = <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">if</span> (now &gt; touchActionLastChecked + touchActionChoke) {

        touchActionLastChecked = now;
        <span class="hljs-title function_">updateUiSubscribedElements</span>();
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <h2 id="cascade-interaction-results-down-to-subscribed-elements">Cascade interaction results down to subscribed elements</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Functions to update uiSubscribedElements attached to specified DOM elements. Each stack or canvas element tracked by Scrawl-canvas will include a local <strong>here</strong> object which includes details of the element’s current dimensions, relative position, and the position of the mouse cursor in relation to its top-left corner. These all need to be updated whenever there’s a resize, scroll or cursor movement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> updateUiSubscribedElements = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = uiSubscribedElements.<span class="hljs-property">length</span>; i &lt; iz; i++) {

        <span class="hljs-title function_">updateUiSubscribedElement</span>(uiSubscribedElements[i]);
    }
};

<span class="hljs-keyword">const</span> updateUiSubscribedElement = <span class="hljs-keyword">function</span> (<span class="hljs-params">art</span>) {

    <span class="hljs-keyword">const</span> dom = library.<span class="hljs-property">artefact</span>[art];

    <span class="hljs-keyword">if</span> (dom) {

        <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">here</span>) dom.<span class="hljs-property">here</span> = {}; 

        <span class="hljs-keyword">const</span> { here, <span class="hljs-attr">domElement</span>:el } = dom;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>Accessibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        here.<span class="hljs-property">prefersContrast</span> = currentCorePosition.<span class="hljs-property">prefersContrast</span>;
        here.<span class="hljs-property">prefersReducedMotion</span> = currentCorePosition.<span class="hljs-property">prefersReducedMotion</span>;
        here.<span class="hljs-property">prefersDarkColorScheme</span> = currentCorePosition.<span class="hljs-property">prefersDarkColorScheme</span>;
        here.<span class="hljs-property">prefersReduceTransparency</span> = currentCorePosition.<span class="hljs-property">prefersReduceTransparency</span>;
        here.<span class="hljs-property">prefersReduceData</span> = currentCorePosition.<span class="hljs-property">prefersReduceData</span>;

        <span class="hljs-keyword">if</span> (prefersContrastChanged) dom.<span class="hljs-title function_">contrastActions</span>();
        <span class="hljs-keyword">if</span> (prefersReducedMotionChanged) dom.<span class="hljs-title function_">reducedMotionActions</span>();
        <span class="hljs-keyword">if</span> (prefersDarkColorSchemeChanged) dom.<span class="hljs-title function_">colorSchemeActions</span>();
        <span class="hljs-keyword">if</span> (prefersReduceTransparencyChanged) dom.<span class="hljs-title function_">reducedTransparencyActions</span>();
        <span class="hljs-keyword">if</span> (prefersReduceDataChanged) dom.<span class="hljs-title function_">reducedDataActions</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>DOM-element-dependant values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (el) {

            <span class="hljs-keyword">const</span> dims = el.<span class="hljs-title function_">getBoundingClientRect</span>(),
                dox = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(dims.<span class="hljs-property">left</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageXOffset</span>),
                doy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(dims.<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>),
                dot = dims.<span class="hljs-property">top</span>,
                doh = dims.<span class="hljs-property">height</span>,
                wih = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;

            here.<span class="hljs-property">w</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(dims.<span class="hljs-property">width</span>);
            here.<span class="hljs-property">h</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(doh);

            here.<span class="hljs-property">type</span> = currentCorePosition.<span class="hljs-property">type</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>Position of the artefact in the browser/device viewport</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">const</span> ivpt = dot / wih,
                ivpb = (dot + doh) / wih,
                ivpc = (ivpt + ivpb) / <span class="hljs-number">2</span>;

            here.<span class="hljs-property">inViewportTop</span> = ivpt;
            here.<span class="hljs-property">inViewportBase</span> = ivpb;
            here.<span class="hljs-property">inViewportCenter</span> = ivpc;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>DOM-based artefacts have the option of creating a local mouse move event listener, which better tracks mouse movements across them when their element has been rotated in three dimensions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">localMouseListener</span>) {

                here.<span class="hljs-property">localListener</span> = <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;

                here.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(currentCorePosition.<span class="hljs-property">x</span> - dox);
                here.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(currentCorePosition.<span class="hljs-property">y</span> - doy);

                here.<span class="hljs-property">normX</span> = (here.<span class="hljs-property">w</span>) ? here.<span class="hljs-property">x</span> / here.<span class="hljs-property">w</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">normY</span> = (here.<span class="hljs-property">h</span>) ? here.<span class="hljs-property">y</span> / here.<span class="hljs-property">h</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">offsetX</span> = dox;
                here.<span class="hljs-property">offsetY</span> = doy;

                <span class="hljs-keyword">if</span> (here.<span class="hljs-property">normX</span> &lt; <span class="hljs-number">0</span> || here.<span class="hljs-property">normX</span> &gt; <span class="hljs-number">1</span> || here.<span class="hljs-property">normY</span> &lt; <span class="hljs-number">0</span> || here.<span class="hljs-property">normY</span> &gt; <span class="hljs-number">1</span>) here.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Default mouse tracking behaviour</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                here.<span class="hljs-property">localListener</span> = <span class="hljs-literal">true</span>;
                here.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;

                here.<span class="hljs-property">normX</span> = (here.<span class="hljs-property">originalWidth</span>) ? here.<span class="hljs-property">x</span> / here.<span class="hljs-property">originalWidth</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">normY</span> = (here.<span class="hljs-property">originalHeight</span>) ? here.<span class="hljs-property">y</span> / here.<span class="hljs-property">originalHeight</span> : <span class="hljs-literal">false</span>;
                here.<span class="hljs-property">offsetX</span> = dox;
                here.<span class="hljs-property">offsetY</span> = doy;

                <span class="hljs-keyword">if</span> (here.<span class="hljs-property">x</span> &gt; dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">x</span> &lt; here.<span class="hljs-property">originalWidth</span> - dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">y</span> &gt; <span class="hljs-number">0</span> + dom.<span class="hljs-property">activePadding</span> &amp;&amp; here.<span class="hljs-property">y</span> &lt; here.<span class="hljs-property">originalHeight</span> - dom.<span class="hljs-property">activePadding</span>) here.<span class="hljs-property">active</span> = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">const</span> touches = currentCorePosition.<span class="hljs-property">rawTouches</span>;

            <span class="hljs-keyword">if</span> (touches.<span class="hljs-property">length</span>) {

                <span class="hljs-keyword">if</span> (!here.<span class="hljs-property">touches</span>) here.<span class="hljs-property">touches</span> = [];

                here.<span class="hljs-property">touches</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = touches.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                    <span class="hljs-keyword">const</span> touch = touches[i];

                    here.<span class="hljs-property">touches</span>.<span class="hljs-title function_">push</span>([<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(touch.<span class="hljs-property">pageX</span> - dox), <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(touch.<span class="hljs-property">pageY</span> - doy)]);
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Canvas <code>fit</code> attribute adjustments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Canvas&#x27;</span>) dom.<span class="hljs-title function_">updateBaseHere</span>(here, dom.<span class="hljs-property">fit</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Automatically check for element resize</p>
<ul>
<li>The artefact’s <code>checkForResize</code> flag needs to be set</li>
<li>We ignore resizing actions while dimensions-related dirty flags are set (to prevent getting ourselves into a continuous feedback loop)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">checkForResize</span> &amp;&amp; !dom.<span class="hljs-property">dirtyDimensions</span> &amp;&amp; !dom.<span class="hljs-property">dirtyDomDimensions</span>) {

                <span class="hljs-keyword">let</span> [w, h] = dom.<span class="hljs-property">currentDimensions</span>;

                <span class="hljs-keyword">if</span> (dom.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Canvas&#x27;</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p>Regardless of the setting of &lt;canvas&gt; element’s <code>boxSizing</code> style attribute:</p>
<ul>
<li>It will include padding and borders in its <code>getBoundingClientRect</code> object (and its <code>getComputedStyle</code> width/height values), but these are specifically excluded from the element’s <code>width</code> and <code>height</code> attributes</li>
<li>Which leads to the normal resize test - <code>if (w !== here.w || h !== here.h)</code> - triggering on every mouse/scroll/resize event, which in turn leads to the canvas dimensions increasing uncontrollably.</li>
<li>Solved by subtracting padding/border values from the <code>getBoundingClientRect</code> dimension values before performing the test.</li>
<li>Tested in Demo <a href="../../demo/canvas-004.html">Canvas-004</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (!dom.<span class="hljs-property">computedStyles</span>) dom.<span class="hljs-property">computedStyles</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(dom.<span class="hljs-property">domElement</span>);

                    <span class="hljs-keyword">let</span> s = dom.<span class="hljs-property">computedStyles</span>,
                        hw = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(here.<span class="hljs-property">w</span> - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderLeftWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderRightWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingLeft</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingRight</span>)),
                        hh = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(here.<span class="hljs-property">h</span> - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderTopWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">borderBottomWidth</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingTop</span>) - <span class="hljs-built_in">parseFloat</span>(s.<span class="hljs-property">paddingBottom</span>));

                    <span class="hljs-keyword">if</span> (w !== hw || h !== hh) {

                        dom.<span class="hljs-title function_">set</span>({

                            <span class="hljs-attr">dimensions</span>: [hw, hh],
                        });
                    }
                }
                <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>Stack and Element artefacts resize test.</p>
<ul>
<li>Tested in Demo <a href="../../demo/dom-011.html">DOM-011</a>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (w !== here.<span class="hljs-property">w</span> || h !== here.<span class="hljs-property">h</span>) {

                        dom.<span class="hljs-title function_">set</span>({

                            <span class="hljs-attr">dimensions</span>: [here.<span class="hljs-property">w</span>, here.<span class="hljs-property">h</span>],
                        });
                    }
                }
            }
        }
    }
};

<span class="hljs-keyword">const</span> updatePhraseEntitys = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [name, ent] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(library.<span class="hljs-property">entity</span>)) {

        <span class="hljs-keyword">if</span> (ent.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Phrase&#x27;</span>) {

            ent.<span class="hljs-property">dirtyDimensions</span> = <span class="hljs-literal">true</span>;
            ent.<span class="hljs-property">dirtyFont</span> = <span class="hljs-literal">true</span>;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>Internal functions that get triggered when setting a DOM-based artefact’s <code>trackHere</code> attribute. They add/remove an event listener to the artefact’s domElement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> addLocalMouseMoveListener = <span class="hljs-keyword">function</span> (<span class="hljs-params">wrapper</span>) {

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(wrapper)) {

        <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">localMouseListener</span>) wrapper.<span class="hljs-title function_">localMouseListener</span>();

        <span class="hljs-keyword">if</span> (!wrapper.<span class="hljs-property">here</span>) wrapper.<span class="hljs-property">here</span> = {};

        wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">originalWidth</span> = wrapper.<span class="hljs-property">currentDimensions</span>[<span class="hljs-number">0</span>];
        wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">originalHeight</span> = wrapper.<span class="hljs-property">currentDimensions</span>[<span class="hljs-number">1</span>];

        wrapper.<span class="hljs-property">localMouseListener</span> = <span class="hljs-title function_">addListener</span>(<span class="hljs-string">&#x27;move&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

            <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">here</span>) {

                wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-built_in">parseFloat</span>(e.<span class="hljs-property">offsetX</span>));
                wrapper.<span class="hljs-property">here</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-built_in">parseFloat</span>(e.<span class="hljs-property">offsetY</span>));
            }
        }, wrapper.<span class="hljs-property">domElement</span>);
    }
};

<span class="hljs-keyword">const</span> removeLocalMouseMoveListener = <span class="hljs-keyword">function</span> (<span class="hljs-params">wrapper</span>) {

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(wrapper)) {

        <span class="hljs-keyword">if</span> (wrapper.<span class="hljs-property">localMouseListener</span>) wrapper.<span class="hljs-title function_">localMouseListener</span>();

        wrapper.<span class="hljs-property">localMouseListener</span> = <span class="hljs-literal">false</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>Animation object which checks whether any window event listeners have fired, and actions accordingly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> coreListenersTracker = <span class="hljs-title function_">makeAnimation</span>({

    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;coreListenersTracker&#x27;</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">delay</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">fn</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

        <span class="hljs-keyword">if</span> (!uiSubscribedElements.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> ((trackMouse &amp;&amp; mouseChanged) || prefersReducedMotionChanged || prefersDarkColorSchemeChanged || prefersReduceTransparencyChanged || prefersReduceDataChanged) {

            <span class="hljs-title function_">updateUiSubscribedElements</span>();

            <span class="hljs-keyword">if</span> (trackMouse &amp;&amp; mouseChanged) {

                mouseChanged = <span class="hljs-literal">false</span>;
            }

            <span class="hljs-keyword">if</span> (prefersReducedMotionChanged || prefersDarkColorSchemeChanged || prefersReduceTransparencyChanged || prefersReduceDataChanged) {

                prefersReducedMotionChanged = <span class="hljs-literal">false</span>,
                prefersDarkColorSchemeChanged = <span class="hljs-literal">false</span>,
                prefersReduceTransparencyChanged = <span class="hljs-literal">false</span>,
                prefersReduceDataChanged = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-keyword">if</span> (viewportChanged) {

            viewportChanged = <span class="hljs-literal">false</span>;
            <span class="hljs-title function_">updatePhraseEntitys</span>();
        }
    },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p><code>Exported functions</code> (to modules and the scrawl object). Event listeners can be a drain on web page efficiency. If a web page contains only static canvas (and/or stack) displays, with no requirement for user interaction, we can minimize Scrawl-canvas’s impact on those pages by switching off the core listeners (and also the core animation loop).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> startCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-string">&#x27;removeEventListener&#x27;</span>);
    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-string">&#x27;addEventListener&#x27;</span>);

    trackMouse = <span class="hljs-literal">true</span>;
    mouseChanged = <span class="hljs-literal">true</span>;
    coreListenersTracker.<span class="hljs-title function_">run</span>();
};

<span class="hljs-keyword">const</span> stopCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    trackMouse = <span class="hljs-literal">false</span>;
    mouseChanged = <span class="hljs-literal">false</span>;
    coreListenersTracker.<span class="hljs-title function_">halt</span>();

    <span class="hljs-title function_">actionCoreListeners</span>(<span class="hljs-string">&#x27;removeEventListener&#x27;</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p>Helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> actionCoreListeners = <span class="hljs-keyword">function</span> (<span class="hljs-params">action</span>) {

    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">pointerEnabled</span> || navigator.<span class="hljs-property">msPointerEnabled</span>) {

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;pointermove&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;pointerup&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;pointerdown&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;pointerleave&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;pointerenter&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">else</span> {

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;mousemove&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;mouseup&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;mousedown&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;mouseleave&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;mouseenter&#x27;</span>, moveAction, <span class="hljs-literal">false</span>);

        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;touchmove&#x27;</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;touchstart&#x27;</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;touchend&#x27;</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
        <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;touchcancel&#x27;</span>, touchAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
    }

    <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;scroll&#x27;</span>, scrollAction, {<span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>});
    <span class="hljs-variable language_">window</span>[action](<span class="hljs-string">&#x27;resize&#x27;</span>, resizeAction, <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-37">&#x00a7;</a>
              </div>
              <p><code>Exported functions</code> (to modules). Invoke the resize and/or scroll event listeners once, outside the regular requestAnimationFrame tick.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> applyCoreResizeListener = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">resizeAction</span>();
    mouseChanged = <span class="hljs-literal">true</span>;
    viewportChanged = <span class="hljs-literal">true</span>;
};

<span class="hljs-keyword">const</span> applyCoreScrollListener = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-title function_">scrollAction</span>();
    mouseChanged = <span class="hljs-literal">true</span>;
};

<span class="hljs-keyword">const</span> forceUpdate = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    mouseChanged = <span class="hljs-literal">true</span>;
    viewportChanged = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-38">&#x00a7;</a>
              </div>
              <h4 id="convenience-functions">Convenience functions</h4>
<p>Okay, so I got very bored of writing boilerplate to react to various form elements user interactions across the demos. So I wrote some functions to setup (and take down) batches of DOM event listeners to make my life easier. These are:</p>
<ul>
<li>scrawl.addNativeListener()</li>
<li>scrawl.removeNativeListener()</li>
</ul>
<p>Then there was the use case for reacting to various mouse (and touch) events, so I bundled all those up into a set of complementary functions:</p>
<ul>
<li>scrawl.addListener()</li>
<li>scrawl.removeListener()</li>
</ul>
<p>Even so, there was still a lot of boilerplate code to write, in particular to listening for user interaction with form elements (which can be anywhere on the web page). So I further factorised that code into an <strong>observeAndUpdate</strong> function which uses the listener functions internally.</p>
<p>I have no idea how useful the observeAndUpdate function will be to anyone else. All I know is that it works for me and my demos, and that makes me happy.</p>
<p>Note: observeAndUpdate() returns a function that will (in theory) remove all the bundled event listeners from their DOM elements when it is invoked. Not yet tested.</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-39">&#x00a7;</a>
              </div>
              <p><code>Exported function</code> (to modules and the scrawl object). Capture changes in a form and apply them to a target Scrawl-canvas artefact, asset, style, group, etc object</p>
<p><strong>observeAndUpdate - example</strong></p>
<pre><code>scrawl.<span class="hljs-title function_">observeAndUpdate</span>({

    <span class="hljs-comment">// The input event which will trigger the O&amp;U </span>
    <span class="hljs-attr">event</span>: [<span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>],

    <span class="hljs-comment">// CSS selector used to gather the DOM elements this O&amp;U will be attached to</span>
    <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;.controlItem&#x27;</span>,

    <span class="hljs-comment">// The SC artefact, or Group object, to be updated by user interaction changes</span>
    <span class="hljs-attr">target</span>: piccy,

    <span class="hljs-comment">// Performs an `addNativeListener` when true; `addListener` when false</span>
    <span class="hljs-attr">useNativeListener</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// Invokes the event listener&#x27;s `preventDefault` function</span>
    <span class="hljs-attr">preventDefault</span>: <span class="hljs-literal">true</span>,

    <span class="hljs-comment">// The SC artefact attributes to be updated by various DOM inputs. See below</span>
    <span class="hljs-attr">updates</span>: {

        <span class="hljs-attr">copy_start_xPercent</span>: [<span class="hljs-string">&#x27;copyStartX&#x27;</span>, <span class="hljs-string">&#x27;%&#x27;</span>],
        <span class="hljs-attr">copy_start_xAbsolute</span>: [<span class="hljs-string">&#x27;copyStartX&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>],

        <span class="hljs-attr">copy_start_yPercent</span>: [<span class="hljs-string">&#x27;copyStartY&#x27;</span>, <span class="hljs-string">&#x27;%&#x27;</span>],
        <span class="hljs-attr">copy_start_yAbsolute</span>: [<span class="hljs-string">&#x27;copyStartY&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>],

        <span class="hljs-attr">copy_dims_widthPercent</span>: [<span class="hljs-string">&#x27;copyWidth&#x27;</span>, <span class="hljs-string">&#x27;%&#x27;</span>],
        <span class="hljs-attr">copy_dims_widthAbsolute</span>: [<span class="hljs-string">&#x27;copyWidth&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>],

        <span class="hljs-attr">copy_dims_heightPercent</span>: [<span class="hljs-string">&#x27;copyHeight&#x27;</span>, <span class="hljs-string">&#x27;%&#x27;</span>],
        <span class="hljs-attr">copy_dims_heightAbsolute</span>: [<span class="hljs-string">&#x27;copyHeight&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>],
    },

    <span class="hljs-comment">// A callback function to be performed after any attributes updates</span>
    <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> myLoom.<span class="hljs-title function_">update</span>(),

    <span class="hljs-comment">// Similarly, we can invoke a function to run before performing the updates</span>
    <span class="hljs-attr">setup</span>: <span class="hljs-function">() =&gt;</span> myLoom.<span class="hljs-title function_">update</span>(),
});
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-40">&#x00a7;</a>
              </div>
              <p><strong>observeAndUpdate</strong> - exported function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> observeAndUpdate = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty</span>) {

    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">xta</span>(items.<span class="hljs-property">event</span>, items.<span class="hljs-property">origin</span>, items.<span class="hljs-property">updates</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> target = (items.<span class="hljs-property">target</span>.<span class="hljs-property">substring</span> &amp;&amp; items.<span class="hljs-property">targetLibrarySection</span>) ?
        library[items.<span class="hljs-property">targetLibrarySection</span>][items.<span class="hljs-property">target</span>] :
        items.<span class="hljs-property">target</span>;

    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> event = items.<span class="hljs-property">event</span>,
        origin = items.<span class="hljs-property">origin</span>;

    <span class="hljs-keyword">let</span> listener = (items.<span class="hljs-property">useNativeListener</span>) ? addNativeListener : addListener,
        killListener = (items.<span class="hljs-property">useNativeListener</span>) ? removeNativeListener : removeListener;

    <span class="hljs-keyword">let</span> stop = λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (items.<span class="hljs-property">preventDefault</span>) {

        stop = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {

            e.<span class="hljs-title function_">preventDefault</span>();
            e.<span class="hljs-property">returnValue</span> = <span class="hljs-literal">false</span>;
        };
    }

    <span class="hljs-keyword">let</span> setup = (<span class="hljs-title function_">isa_fn</span>(items.<span class="hljs-property">setup</span>)) ? items.<span class="hljs-property">setup</span> : λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">let</span> callback = (<span class="hljs-title function_">isa_fn</span>(items.<span class="hljs-property">callback</span>)) ? items.<span class="hljs-property">callback</span> : λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">let</span> func = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

        <span class="hljs-title function_">stop</span>(e);

        <span class="hljs-keyword">let</span> id = (e &amp;&amp; e.<span class="hljs-property">target</span>) ? e.<span class="hljs-property">target</span>.<span class="hljs-property">id</span> : <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (id) {

            <span class="hljs-keyword">let</span> updates = items.<span class="hljs-property">updates</span>,
                actionArray = updates[id];

            <span class="hljs-keyword">if</span> (actionArray) {

                <span class="hljs-title function_">setup</span>();

                <span class="hljs-keyword">let</span> actionAttribute = actionArray[<span class="hljs-number">0</span>],
                    action = actionArray[<span class="hljs-number">1</span>],
                    targetVal = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>,
                    actionFlag = <span class="hljs-literal">true</span>,
                    val;

                <span class="hljs-keyword">switch</span> (action) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-41">&#x00a7;</a>
              </div>
              <p>Supplied value converted to float Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;float&#x27;</span> :
                        val = <span class="hljs-built_in">parseFloat</span>(targetVal);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-42">&#x00a7;</a>
              </div>
              <p>Supplied value converted to integer Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;int&#x27;</span> :
                        val = <span class="hljs-built_in">parseInt</span>(targetVal, <span class="hljs-number">10</span>);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-43">&#x00a7;</a>
              </div>
              <p>Supplied value rounded up or down to nearest integer Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;round&#x27;</span> :
                        val = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(targetVal);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-44">&#x00a7;</a>
              </div>
              <p>Supplied value rounded down to nearest integer Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;roundDown&#x27;</span> :
                        val = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(targetVal);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-45">&#x00a7;</a>
              </div>
              <p>Supplied value rounded up to nearest integer Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;roundUp&#x27;</span> :
                        val = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(targetVal);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-46">&#x00a7;</a>
              </div>
              <p>Supplied value not modified in any way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;raw&#x27;</span> :
                        val = targetVal;
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-47">&#x00a7;</a>
              </div>
              <p>Supplied value converted to String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;string&#x27;</span> :
                        val = <span class="hljs-string">`<span class="hljs-subst">${targetVal}</span>`</span>;
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-48">&#x00a7;</a>
              </div>
              <p>Supplied value converted to Boolean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;boolean&#x27;</span> :
                        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">xt</span>(targetVal)) {

                            <span class="hljs-keyword">if</span> (targetVal.<span class="hljs-property">substring</span>) {

                                <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;true&#x27;</span> === targetVal.<span class="hljs-title function_">toLowerCase</span>()) val = <span class="hljs-literal">true</span>;
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;false&#x27;</span> === targetVal.<span class="hljs-title function_">toLowerCase</span>()) val = <span class="hljs-literal">false</span>;
                                <span class="hljs-keyword">else</span> val = (<span class="hljs-built_in">parseFloat</span>(targetVal)) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                            }
                            <span class="hljs-keyword">else</span> val = (targetVal) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                        }
                        <span class="hljs-keyword">else</span> val = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-49">&#x00a7;</a>
              </div>
              <p>Supplied value converted to float number, then action value (eg: ‘%’) added to result to output a String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">default</span> :
                        <span class="hljs-keyword">if</span> (action.<span class="hljs-property">substring</span>) val = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">parseFloat</span>(targetVal)}</span><span class="hljs-subst">${action}</span>`</span>;
                        <span class="hljs-keyword">else</span> actionFlag = <span class="hljs-literal">false</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-50">&#x00a7;</a>
              </div>
              <p>Update - we can apply updates to a Group of artefacts, or to a single artefact</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (actionFlag) {

                    <span class="hljs-keyword">if</span> (target.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Group&#x27;</span>) {

                        target.<span class="hljs-title function_">setArtefacts</span>({
                            [actionAttribute]: val
                        });
                    }
                    <span class="hljs-keyword">else</span> {

                        target.<span class="hljs-title function_">set</span>({
                            [actionAttribute]: val
                        });
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-51">&#x00a7;</a>
              </div>
              <p>Invoke any supplied callback function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-title function_">callback</span>();
                }
            }
        }
    };

    <span class="hljs-keyword">let</span> kill = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

        <span class="hljs-title function_">killListener</span>(event, func, origin);
    };

    <span class="hljs-title function_">listener</span>(event, func, origin);

    <span class="hljs-keyword">return</span> kill;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-52">&#x00a7;</a>
              </div>
              <h4 id="drag-and-drop-zones">Drag-and-drop zones.</h4>
<p><strong>makeDragZone</strong> is an attempt to make setting up drag-and-drop functionality within a Scrawl-canvas stack or canvas as simple as possible. The functionality has been designed to allow multiple drag zones to be set on a canvas or stack element, while limiting the number of event listeners that need to be applied to the element to make the magic happen.</p>
<p>Required attribute of the argument object:</p>
<ul>
<li><strong>.zone</strong> - either the String name of the Stack or Canvas artefact which will host the zone, or the Stack or Canvas artefact itself</li>
</ul>
<p>Additional, optional, attributes in the argument object</p>
<ul>
<li><strong>.coordinateSource</strong> - an object containing a <code>here</code> object</li>
<li><strong>.coordinateSource</strong> - an object containing a <code>here</code> object</li>
<li><strong>.collisionGroup</strong> - String name of Group object, or Group object itself</li>
<li><strong>.startOn</strong> - Array of Strings</li>
<li><strong>.endOn</strong> - Array of Strings</li>
<li><strong>.exposeCurrentArtefact</strong> - Boolean (default: false)</li>
<li><strong>.preventTouchDefaultWhenDragging</strong> - Boolean (default: false)</li>
<li><strong>.resetCoordsToZeroOnTouchEnd</strong> - Boolean (default: true)</li>
</ul>
<p>At the heart of the drag zone are a set of functions (or alternatively, objects that can be applied to the selected artefact) which define the actions that happen when a user starts, continues and stops dragging an artefact in the zone. It is possible to set different actions depending on whether the user is pressing the shift button while they perform the drag action:</p>
<ul>
<li><strong>.updateOnStart</strong>, <strong>.updateOnShiftStart</strong> - Function, or a <code>set</code> object to be applied to the current artefact</li>
<li><strong>.updateOnEnd</strong>, <strong>.updateOnShiftEnd</strong> - Function, or a <code>set</code> object to be applied to the current artefact</li>
<li><strong>.updateWhileMoving</strong>, <strong>.updateWhileShiftMoving</strong> - Function to be run while drag is in progress</li>
<li><strong>.updateOnPrematureExit</strong> - Function that will run when checks (defined in code elsewhere) trigger a premature exit from the drag zone. The triggering code can be used, for instance, to make sure an artefact does not leave a given area of the cell, within the canvas element boundaries</li>
</ul>
<p>Multiple drag zones can be defined on a canvas or stack element. When a user presses the mouse button to start a drag the code will interrogate each drag zone in turn to discover if one of them has an artefact which collides with the mouse cursor; if yes, that drag zone takes precedence for the subsequent move and drop actions</p>
<ul>
<li><strong>.processingOrder</strong> - positive integer Number - drag zones with a lower value will be interrogated ahead of those with a higher value</li>
</ul>
<p>If the <code>exposeCurrentArtefact</code> attribute is true, the <code>makeDragZone</code> factory returns a function that can be invoked at any time to get the collision data object (containing x, y, artefact attributes) for the artefact being dragged (false if nothing is being dragged). The function can also be triggered with the following string arguments:</p>
<ul>
<li><code>&#39;exit&#39;</code> or <code>&#39;drop</code> - force the drag action to end</li>
<li>any other truthy argument - kill the drag zone object. If it was the only drag zone object associated with a given canvas or stack element then the event listeners will also be removed from the element</li>
<li>null, undefined, any other falsy argument - return the collision data object</li>
</ul>
<p>If the <code>exposeCurrentArtefact</code> attribute is false, or omitted, the function returns a kill function that can be invoked (with no arguments) to remove the event listeners from the Stack or Canvas zone’s DOM element.</p>
<p>NOTE: drag-and-drop functionality using this factory function <strong>is not guaranteed</strong> for artefacts referencing a path, or for artefacts whose reference artefact in turn references another artefact in any way.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> dragZones = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-53">&#x00a7;</a>
              </div>
              <p>Generate the drag zone and associate it with the zone element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> processDragZoneData = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty, doAddListeners, doRemoveListeners</span>) {

    <span class="hljs-keyword">let</span> {
        zone, 
        coordinateSource, 
        collisionGroup, 
        startOn, 
        endOn, 
        updateOnStart, 
        updateOnEnd, 
        updateWhileMoving, 
        updateOnShiftStart, 
        updateOnShiftEnd, 
        updateWhileShiftMoving, 
        updateOnPrematureExit,
        exposeCurrentArtefact, 
        preventTouchDefaultWhenDragging, 
        resetCoordsToZeroOnTouchEnd, 
        processingOrder,
    } = items;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-54">&#x00a7;</a>
              </div>
              <p><code>zone</code> is required</p>
<ul>
<li>must be either a Canvas or Stack wrapper, or a wrapper’s String name</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!zone) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;dragZone constructor - no zone supplied&#x27;</span>);

    <span class="hljs-keyword">if</span> (zone.<span class="hljs-property">substring</span>) zone = artefact[zone];

    <span class="hljs-keyword">if</span> (!zone || [<span class="hljs-string">&#x27;Canvas&#x27;</span>, <span class="hljs-string">&#x27;Stack&#x27;</span>].<span class="hljs-title function_">indexOf</span>(zone.<span class="hljs-property">type</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;dragZone constructor - zone object is not a Stack or Canvas wrapper&#x27;</span>);

    <span class="hljs-keyword">let</span> target = zone.<span class="hljs-property">domElement</span>;

    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;dragZone constructor - zone does not contain a target DOM element&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-55">&#x00a7;</a>
              </div>
              <p><code>collisionGroup</code> is optional; defaults to zone’s namesake group</p>
<ul>
<li>must be a Group object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!collisionGroup) {

        <span class="hljs-keyword">if</span> (zone.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Canvas&#x27;</span>) collisionGroup = library.<span class="hljs-property">group</span>[zone.<span class="hljs-property">base</span>.<span class="hljs-property">name</span>];
        <span class="hljs-keyword">else</span> collisionGroup = library.<span class="hljs-property">group</span>[zone.<span class="hljs-property">name</span>];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collisionGroup.<span class="hljs-property">substring</span>) collisionGroup = library.<span class="hljs-property">group</span>[collisionGroup];

    <span class="hljs-keyword">if</span> (!collisionGroup || collisionGroup.<span class="hljs-property">type</span> !== <span class="hljs-string">&#x27;Group&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;dragZone constructor - unable to recover collisionGroup group&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-56">&#x00a7;</a>
              </div>
              <p><code>coordinateSource</code> will be an object containing <code>x</code> and <code>y</code> attributes</p>
<ul>
<li>default’s to the zone’s <code>here</code> object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (coordinateSource) {

        <span class="hljs-keyword">if</span> (coordinateSource.<span class="hljs-property">here</span>) coordinateSource = coordinateSource.<span class="hljs-property">here</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">xta</span>(coordinateSource.<span class="hljs-property">x</span>, coordinateSource.<span class="hljs-property">y</span>)) coordinateSource = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">if</span> (zone.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;Canvas&#x27;</span>) coordinateSource = zone.<span class="hljs-property">base</span>.<span class="hljs-property">here</span>;
        <span class="hljs-keyword">else</span> coordinateSource = zone.<span class="hljs-property">here</span>;
    }

    <span class="hljs-keyword">if</span> (!coordinateSource) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;dragZone constructor - unable to discover a usable coordinateSource object&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-57">&#x00a7;</a>
              </div>
              <p><code>startOn</code>, <code>endOn</code> - if supplied, then need to be arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(startOn)) startOn = [<span class="hljs-string">&#x27;down&#x27;</span>];
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(endOn)) endOn = [<span class="hljs-string">&#x27;up&#x27;</span>];

    <span class="hljs-keyword">if</span> (exposeCurrentArtefact == <span class="hljs-literal">null</span>) exposeCurrentArtefact = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (preventTouchDefaultWhenDragging == <span class="hljs-literal">null</span>) preventTouchDefaultWhenDragging = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (resetCoordsToZeroOnTouchEnd == <span class="hljs-literal">null</span>) resetCoordsToZeroOnTouchEnd = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-58">&#x00a7;</a>
              </div>
              <p><code>updateOnStart</code>, <code>updateOnEnd</code>, <code>updateOnShiftStart</code>, <code>updateOnShiftEnd</code> - if supplied, then needs to be key:value objects which will be applied to the entity (using set) or, alternatively, a callback function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(updateOnStart)) updateOnStart = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) { current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">set</span>(items.<span class="hljs-property">updateOnStart</span>) };
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateOnStart)) updateOnStart = λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(updateOnShiftStart)) updateOnShiftStart = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) { current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">set</span>(items.<span class="hljs-property">updateOnShiftStart</span>) };
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateOnShiftStart)) updateOnShiftStart = updateOnStart;

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(updateOnEnd)) updateOnEnd = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) { current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">set</span>(items.<span class="hljs-property">updateOnEnd</span>) };
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateOnEnd)) updateOnEnd = λ<span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isa_obj</span>(updateOnShiftEnd)) updateOnShiftEnd = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) { current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">set</span>(items.<span class="hljs-property">updateOnShiftEnd</span>) };
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateOnShiftEnd)) updateOnShiftEnd = updateOnEnd;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-59">&#x00a7;</a>
              </div>
              <p><code>updateWhileMoving</code>, <code>updateWhileShiftMoving</code> - if supplied, needs to be a callback function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateWhileMoving)) updateWhileMoving = λ<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateWhileShiftMoving)) updateWhileShiftMoving = updateWhileMoving;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-60">&#x00a7;</a>
              </div>
              <p><code>updateOnPrematureExit</code> - if supplied, needs to be a callback function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_fn</span>(updateOnPrematureExit)) updateOnPrematureExit = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-61">&#x00a7;</a>
              </div>
              <p><code>exposeCurrentArtefact</code> - if supplied, then needs to be a boolean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isa_boolean</span>(exposeCurrentArtefact)) exposeCurrentArtefact = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (processingOrder == <span class="hljs-literal">null</span>) processingOrder = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-62">&#x00a7;</a>
              </div>
              <p>We can only drag one artefact at a time; that artefact - alongside the hit coordinate’s x and y values -  is stored in the <code>current</code> variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> current = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">const</span> checkE = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {

        <span class="hljs-keyword">if</span> (e &amp;&amp; e.<span class="hljs-property">cancelable</span>) {
            
            <span class="hljs-keyword">if</span> (preventTouchDefaultWhenDragging &amp;&amp; current) {

                e.<span class="hljs-title function_">preventDefault</span>();
                e.<span class="hljs-property">returnValue</span> = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!preventTouchDefaultWhenDragging) {

                e.<span class="hljs-title function_">preventDefault</span>();
                e.<span class="hljs-property">returnValue</span> = <span class="hljs-literal">false</span>;
            }
        }
    };

    <span class="hljs-keyword">const</span> pickup = <span class="hljs-keyword">function</span> (<span class="hljs-params">e = Ωempty</span>) {

        <span class="hljs-title function_">checkE</span>(e);

        <span class="hljs-keyword">let</span> type = e.<span class="hljs-property">type</span>;
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;touchstart&#x27;</span> || type === <span class="hljs-string">&#x27;touchcancel&#x27;</span>) <span class="hljs-title function_">touchAction</span>(e, resetCoordsToZeroOnTouchEnd);

        current = collisionGroup.<span class="hljs-title function_">getArtefactAt</span>(coordinateSource);

        <span class="hljs-keyword">if</span> (current) {

            current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">pickupArtefact</span>(coordinateSource);
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">shiftKey</span>) <span class="hljs-title function_">updateOnShiftStart</span>(e);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">updateOnStart</span>(e);
        }
        <span class="hljs-keyword">return</span> {
            current,
            move,
            drop,
        };
    };

    <span class="hljs-keyword">const</span> move = <span class="hljs-keyword">function</span> (<span class="hljs-params">e = Ωempty</span>) {

        <span class="hljs-keyword">if</span> (current) {

            <span class="hljs-title function_">checkE</span>(e);

            <span class="hljs-keyword">let</span> type = e.<span class="hljs-property">type</span>;
            <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;touchmove&#x27;</span>) <span class="hljs-title function_">touchAction</span>(e);

            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">shiftKey</span>) <span class="hljs-title function_">updateWhileShiftMoving</span>(e);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">updateWhileMoving</span>(e);
        }
    };

    <span class="hljs-keyword">const</span> drop = <span class="hljs-keyword">function</span> (<span class="hljs-params">e = Ωempty</span>) {

        <span class="hljs-keyword">if</span> (current) {

            <span class="hljs-title function_">checkE</span>(e);

            <span class="hljs-keyword">let</span> type = e.<span class="hljs-property">type</span>;
            <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;touchend&#x27;</span>) {

                <span class="hljs-title function_">touchAction</span>(e, resetCoordsToZeroOnTouchEnd);
            }

            current.<span class="hljs-property">artefact</span>.<span class="hljs-title function_">dropArtefact</span>();
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">shiftKey</span>) <span class="hljs-title function_">updateOnShiftEnd</span>(e);
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">updateOnEnd</span>(e);
            current = <span class="hljs-literal">false</span>;
        }
    };

    <span class="hljs-keyword">if</span> (!dragZones[zone.<span class="hljs-property">name</span>]) {

        dragZones[zone.<span class="hljs-property">name</span>] = [];
        <span class="hljs-title function_">doAddListeners</span>(startOn, endOn, target);
    }

    <span class="hljs-keyword">const</span> kill = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

        <span class="hljs-keyword">const</span> name = <span class="hljs-string">`<span class="hljs-subst">${zone.name}</span>_<span class="hljs-subst">${collisionGroup.name}</span>_<span class="hljs-subst">${processingOrder}</span>`</span>;

        dragZones[zone.<span class="hljs-property">name</span>] = dragZones[zone.<span class="hljs-property">name</span>].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">z</span> =&gt;</span> z.<span class="hljs-property">name</span> !== name);

        <span class="hljs-keyword">if</span> (!dragZones[zone.<span class="hljs-property">name</span>].<span class="hljs-property">length</span>) <span class="hljs-title function_">doRemoveListeners</span>(startOn, endOn, target);
    };

    <span class="hljs-keyword">const</span> getCurrent = <span class="hljs-keyword">function</span> (<span class="hljs-params">actionKill</span>) {

        <span class="hljs-keyword">if</span> (actionKill) {

            <span class="hljs-keyword">if</span> (actionKill === <span class="hljs-string">&#x27;exit&#x27;</span> || actionKill === <span class="hljs-string">&#x27;drop&#x27;</span>) {

                <span class="hljs-title function_">drop</span>();
                <span class="hljs-title function_">updateOnPrematureExit</span>();
            }
            <span class="hljs-keyword">else</span> <span class="hljs-title function_">kill</span>();
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> current;
    };

    <span class="hljs-keyword">const</span> data = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${zone.name}</span>_<span class="hljs-subst">${collisionGroup.name}</span>_<span class="hljs-subst">${processingOrder}</span>`</span>,
        exposeCurrentArtefact, 
        target,
        processingOrder,
        pickup,
        move,
        drop,
        kill,
        getCurrent,
    };

    dragZones[zone.<span class="hljs-property">name</span>].<span class="hljs-title function_">push</span>(data);

    dragZones[zone.<span class="hljs-property">name</span>].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">processingOrder</span> - b.<span class="hljs-property">processingOrder</span>);

    <span class="hljs-keyword">return</span> {
        exposeCurrentArtefact, 
        getCurrent,
        kill,
        zone,
    };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-63">&#x00a7;</a>
              </div>
              <p><code>Exported function</code> (to modules and the SC object). Add drag-and-drop functionality to a canvas or stack wrapper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeDragZone = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-64">&#x00a7;</a>
              </div>
              <p>The exposed <code>pickup</code> function will search for the target element (if user has started the drag while the mouse cursor was over a child of the Stack wrapper) and then interrogate each drag zone associated with that target until it finds a zone reporting a hit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">pickup</span> = (<span class="hljs-params">e = Ωempty</span>) =&gt; {

        <span class="hljs-keyword">if</span> (e &amp;&amp; e.<span class="hljs-property">target</span>) {

            <span class="hljs-keyword">let</span> myTarget = e.<span class="hljs-property">target</span>,
                name = <span class="hljs-string">&#x27;&#x27;</span>;

            <span class="hljs-keyword">while</span> (!name) {

                <span class="hljs-keyword">if</span> (dragZones[myTarget.<span class="hljs-property">id</span>]) name = myTarget.<span class="hljs-property">id</span>;
                <span class="hljs-keyword">if</span> (myTarget.<span class="hljs-property">tagName</span> === <span class="hljs-string">&#x27;BODY&#x27;</span>) <span class="hljs-keyword">break</span>;
                myTarget = myTarget.<span class="hljs-property">parentElement</span>;
            }

            <span class="hljs-keyword">const</span> variants = dragZones[name];

            <span class="hljs-keyword">if</span> (variants) {

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, iz = variants.<span class="hljs-property">length</span>; i &lt; iz; i++) {

                    <span class="hljs-keyword">const</span> v = variants[i];

                    <span class="hljs-keyword">const</span> res = v.<span class="hljs-title function_">pickup</span>(e);

                    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">current</span>) {

                        currentMove = res.<span class="hljs-property">move</span>;
                        currentDrop = res.<span class="hljs-property">drop</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-65">&#x00a7;</a>
              </div>
              <p>The exposed <code>move</code> and <code>drop</code> functions will change to match the equivalent funtions supplied by the zone selected during the <code>pickup</code> stage of the operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> currentMove = λ<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">move</span> = (<span class="hljs-params">e = Ωempty</span>) =&gt; {

        <span class="hljs-title function_">currentMove</span>(e);
    };

    <span class="hljs-keyword">let</span> currentDrop = λ<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">drop</span> = (<span class="hljs-params">e = Ωempty</span>) =&gt; {

        <span class="hljs-title function_">currentDrop</span>(e);
        currentMove = λ<span class="hljs-literal">null</span>;
        currentDrop = λ<span class="hljs-literal">null</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-66">&#x00a7;</a>
              </div>
              <p>Listeners are added to the DOM element when the first drag zone is created for that target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">doAddListeners</span> = (<span class="hljs-params">startOn, endOn, target</span>) =&gt; {

        <span class="hljs-title function_">addListener</span>(startOn, pickup, target);
        <span class="hljs-title function_">addListener</span>(<span class="hljs-string">&#x27;move&#x27;</span>, move, target);
        <span class="hljs-title function_">addListener</span>(endOn, drop, target);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-67">&#x00a7;</a>
              </div>
              <p>Listeners are only removed from the DOM element when all the drag zones associated with that target have been killed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">doRemoveListeners</span> = (<span class="hljs-params">startOn, endOn, target</span>) =&gt; {

        <span class="hljs-title function_">removeListener</span>(startOn, pickup, target);
        <span class="hljs-title function_">removeListener</span>(<span class="hljs-string">&#x27;move&#x27;</span>, move, target);
        <span class="hljs-title function_">removeListener</span>(endOn, drop, target);
    };

    <span class="hljs-keyword">const</span> processedData = <span class="hljs-title function_">processDragZoneData</span>(items, doAddListeners, doRemoveListeners);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-68">&#x00a7;</a>
              </div>
              <p>Return the appropriate function based on the value of the <code>exposeCurrentArtefact</code> attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (processedData.<span class="hljs-property">exposeCurrentArtefact</span>) <span class="hljs-keyword">return</span> processedData.<span class="hljs-property">getCurrent</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> processedData.<span class="hljs-property">kill</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-69">&#x00a7;</a>
              </div>
              <h4 id="keyboard-zones">Keyboard zones.</h4>
<p><strong>makeKeyboardZone</strong> is an attempt to make setting up keyboard listeners (for accessibility) within a Scrawl-canvas stack or canvas as simple as possible. Similar to the drag zone functionality, SC tries to limit the number of keyboard event listeners attached to a particular DOM element to the bare minimum</p>
<p>Required attribute of the argument object:</p>
<ul>
<li><strong>.zone</strong> - either the String name of the Stack or Canvas artefact which will host the zone, or the Stack or Canvas artefact itself</li>
</ul>
<p>Additional, optional, attributes in the argument object</p>
<ul>
<li><code>&#39;none&#39;, &#39;shiftOnly&#39;, &#39;altOnly&#39;, &#39;ctrlOnly&#39;, &#39;metaOnly&#39;, &#39;shiftAlt&#39;, &#39;shiftCtrl&#39;, &#39;shiftMeta&#39;, &#39;altCtrl&#39;, &#39;altMeta&#39;, &#39;ctrlMeta&#39;, &#39;shiftAltCtrl&#39;, &#39;shiftAltMeta&#39;, &#39;shiftCtrlMeta&#39;, &#39;altCtrlMeta&#39;, &#39;all&#39;</code> - a set of objects containing <code>keyboard Key: function</code> attributes defining the group of actions to take when the user presses the associated key or key-combination.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> keyboardZones = {};

<span class="hljs-keyword">const</span> processKeyboardZoneData = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty, doAddListeners, doRemoveListeners</span>) {

    <span class="hljs-keyword">let</span> {
        zone, 
    } = items;</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-70">&#x00a7;</a>
              </div>
              <p><code>zone</code> is required</p>
<ul>
<li>must be either a Canvas or Stack wrapper, or a wrapper’s String name</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!zone) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;keyboardZone constructor - no zone supplied&#x27;</span>);

    <span class="hljs-keyword">if</span> (zone.<span class="hljs-property">substring</span>) zone = artefact[zone];

    <span class="hljs-keyword">if</span> (!zone || [<span class="hljs-string">&#x27;Canvas&#x27;</span>, <span class="hljs-string">&#x27;Stack&#x27;</span>].<span class="hljs-title function_">indexOf</span>(zone.<span class="hljs-property">type</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;keyboardZone constructor - zone object is not a Stack or Canvas wrapper&#x27;</span>);

    <span class="hljs-keyword">let</span> target = zone.<span class="hljs-property">domElement</span>;

    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;keyboardZone constructor - zone does not contain a target DOM element&#x27;</span>);

    <span class="hljs-keyword">let</span> zoneItem = keyboardZones[zone.<span class="hljs-property">name</span>];

    <span class="hljs-keyword">if</span> (!zoneItem) {

        keyboardZones[zone.<span class="hljs-property">name</span>] = {};
        zoneItem = keyboardZones[zone.<span class="hljs-property">name</span>];
        <span class="hljs-title function_">doAddListeners</span>(target);
    }

    <span class="hljs-keyword">if</span> (!zoneItem.<span class="hljs-property">extraKeys</span>) {

        zoneItem.<span class="hljs-property">extraKeys</span> = {
            <span class="hljs-title class_">Shift</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-title class_">Control</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-title class_">Alt</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-title class_">Meta</span>: <span class="hljs-literal">false</span>,
        };
    }

    <span class="hljs-keyword">const</span> keyGroupsArray = [
        <span class="hljs-string">&#x27;none&#x27;</span>,
        <span class="hljs-string">&#x27;shiftOnly&#x27;</span>,
        <span class="hljs-string">&#x27;altOnly&#x27;</span>,
        <span class="hljs-string">&#x27;ctrlOnly&#x27;</span>,
        <span class="hljs-string">&#x27;metaOnly&#x27;</span>,
        <span class="hljs-string">&#x27;shiftAlt&#x27;</span>,
        <span class="hljs-string">&#x27;shiftCtrl&#x27;</span>,
        <span class="hljs-string">&#x27;shiftMeta&#x27;</span>,
        <span class="hljs-string">&#x27;altCtrl&#x27;</span>,
        <span class="hljs-string">&#x27;altMeta&#x27;</span>,
        <span class="hljs-string">&#x27;ctrlMeta&#x27;</span>,
        <span class="hljs-string">&#x27;shiftAltCtrl&#x27;</span>,
        <span class="hljs-string">&#x27;shiftAltMeta&#x27;</span>,
        <span class="hljs-string">&#x27;shiftCtrlMeta&#x27;</span>,
        <span class="hljs-string">&#x27;altCtrlMeta&#x27;</span>,
        <span class="hljs-string">&#x27;all&#x27;</span>,
    ];

    <span class="hljs-keyword">if</span> (!zoneItem.<span class="hljs-property">keyGroups</span>) {

        <span class="hljs-keyword">const</span> groups = {};
        keyGroupsArray.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">g</span> =&gt;</span> groups[g] = {});
        zoneItem.<span class="hljs-property">keyGroups</span> = groups;
    }

    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KG</span> = zoneItem.<span class="hljs-property">keyGroups</span>;

    keyGroupsArray.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">g</span> =&gt;</span> {

        <span class="hljs-keyword">const</span> keymap = items[g];
        <span class="hljs-keyword">if</span> (keymap != <span class="hljs-literal">null</span>) <span class="hljs-title function_">mergeDiscard</span>(<span class="hljs-variable constant_">KG</span>[g], keymap);
    });

    <span class="hljs-keyword">if</span> (!zoneItem.<span class="hljs-property">onKeyDown</span>) {

        zoneItem.<span class="hljs-property">onKeyDown</span> = <span class="hljs-function">(<span class="hljs-params">e = Ωempty</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (e &amp;&amp; e.<span class="hljs-property">key</span>) {

                e.<span class="hljs-title function_">preventDefault</span>();

                <span class="hljs-keyword">const</span> { extraKeys, keyGroups } = zoneItem;
                <span class="hljs-keyword">const</span> { key } = e;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-71">&#x00a7;</a>
              </div>
              <p>Tab, Esc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;Tab&#x27;</span> === key || <span class="hljs-string">&#x27;Escape&#x27;</span> === key) {

                    target.<span class="hljs-title function_">blur</span>();
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">if</span> (extraKeys[key] != <span class="hljs-literal">null</span>) {

                    extraKeys[key] = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Shift</span>, <span class="hljs-title class_">Control</span>, <span class="hljs-title class_">Alt</span>, <span class="hljs-title class_">Meta</span> } = extraKeys;

                <span class="hljs-keyword">let</span> group = keyGroups.<span class="hljs-property">none</span>;

                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Shift</span> || <span class="hljs-title class_">Control</span> || <span class="hljs-title class_">Alt</span> || <span class="hljs-title class_">Meta</span>) {

                    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Shift</span>) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Alt</span>) {
                            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Control</span>) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">all</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">shiftAltCtrl</span>;
                            }
                            <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">shiftAltMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">shiftAlt</span>;
                            }
                        }
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Control</span>) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">shiftCtrlMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">shiftCtrl</span>;
                            }
                            <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">shiftMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">shiftOnly</span>;
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Alt</span>) {
                            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Control</span>) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">altCtrlMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">altCtrl</span>;
                            }
                            <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">altMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">altOnly</span>;
                            }
                        }
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Control</span>) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">ctrlMeta</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">ctrlOnly</span>;
                            }
                            <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Meta</span>) group = keyGroups.<span class="hljs-property">altOnly</span>;
                                <span class="hljs-keyword">else</span> group = keyGroups.<span class="hljs-property">none</span>;
                            }
                        }
                    }
                }
                <span class="hljs-keyword">if</span> (group[key]) group[key]();
            }
        };
    }

    <span class="hljs-keyword">if</span> (!zoneItem.<span class="hljs-property">onKeyUp</span>) {
        
        zoneItem.<span class="hljs-property">onKeyUp</span> = <span class="hljs-function">(<span class="hljs-params">e = Ωempty</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (e &amp;&amp; e.<span class="hljs-property">key</span>) {

                e.<span class="hljs-title function_">preventDefault</span>();

                <span class="hljs-keyword">const</span> { extraKeys } = zoneItem;
                <span class="hljs-keyword">const</span> { key } = e;

                <span class="hljs-keyword">if</span> (extraKeys[key] != <span class="hljs-literal">null</span>) extraKeys[key] = <span class="hljs-literal">false</span>;
            }
        };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-72">&#x00a7;</a>
              </div>
              <p><strong>kill</strong> - A function to remove the internal key mappings associated with the target DOM element, and then remove the keyboard listeners attached to that element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!zoneItem.<span class="hljs-property">kill</span>) {

        zoneItem.<span class="hljs-property">kill</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

            <span class="hljs-keyword">delete</span> keyboardZones[zone.<span class="hljs-property">name</span>];
            <span class="hljs-title function_">doRemoveListeners</span>(target);
        };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-73">&#x00a7;</a>
              </div>
              <p><strong>getMappedKeys</strong> - A function which returns an Array of the defined keys for the given group, the name of which should be supplied as the function’s argument</p>
<ul>
<li>To update key mappings, invoke the <code>makeKeyboardZone</code> function again, including the new mappings as part of the argument object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMappedKeys</span> = (<span class="hljs-params">keyGroup = <span class="hljs-string">&#x27;none&#x27;</span></span>) =&gt; {

        <span class="hljs-keyword">if</span> (zoneItem.<span class="hljs-property">keyGroups</span>[keyGroup] != <span class="hljs-literal">null</span>) {

            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(zoneItem.<span class="hljs-property">keyGroups</span>[keyGroup]);
        }
        <span class="hljs-keyword">return</span> [];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-74">&#x00a7;</a>
              </div>
              <p>The return includes both the <code>kill</code> and <code>getMappedKeys</code> functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">kill</span>: zoneItem.<span class="hljs-property">kill</span>,
        getMappedKeys,
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-75">&#x00a7;</a>
              </div>
              <p><code>Exported function</code> (to modules and the SC object). Add keyboard listenning functionality to a canvas or stack wrapper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeKeyboardZone = <span class="hljs-keyword">function</span> (<span class="hljs-params">items = Ωempty</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-76">&#x00a7;</a>
              </div>
              <p>The exposed <code>actionKeyDown</code> function will search for the target element (if user has started the drag while the mouse cursor was over a child of the Stack wrapper) and then apply the required keystroke actions while that element remains focussed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">actionKeyDown</span> = (<span class="hljs-params">e = Ωempty</span>) =&gt; {

        <span class="hljs-keyword">if</span> (e &amp;&amp; e.<span class="hljs-property">target</span>) {

            <span class="hljs-keyword">let</span> myTarget = e.<span class="hljs-property">target</span>,
                name = <span class="hljs-string">&#x27;&#x27;</span>;

            <span class="hljs-keyword">while</span> (!name) {

                <span class="hljs-keyword">if</span> (dragZones[myTarget.<span class="hljs-property">id</span>]) name = myTarget.<span class="hljs-property">id</span>;
                <span class="hljs-keyword">if</span> (myTarget.<span class="hljs-property">tagName</span> === <span class="hljs-string">&#x27;BODY&#x27;</span>) <span class="hljs-keyword">break</span>;
                myTarget = myTarget.<span class="hljs-property">parentElement</span>;
            }

            <span class="hljs-keyword">const</span> actions = keyboardZones[name];

            <span class="hljs-keyword">if</span> (actions) {

                actions.<span class="hljs-title function_">onKeyDown</span>(e);
                currentKeyUp = actions.<span class="hljs-property">onKeyUp</span>;
            }
            <span class="hljs-keyword">else</span> currentKeyUp = λ<span class="hljs-literal">null</span>;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-77">&#x00a7;</a>
              </div>
              <p>The exposed <code>actionKeyUp</code> function will change to match the equivalent funtions supplied by the zone selected during the <code>actionKeyDown</code> stage of the operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> currentKeyUp = λ<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">actionKeyUp</span> = (<span class="hljs-params">e</span>) =&gt; {

        <span class="hljs-title function_">currentKeyUp</span>(e);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-78">&#x00a7;</a>
              </div>
              <p>Listeners are added to the DOM element when the first keyboard zone is created for that target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">doAddListeners</span> = (<span class="hljs-params">target</span>) =&gt; {

        <span class="hljs-title function_">addNativeListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, actionKeyDown, target);
        <span class="hljs-title function_">addNativeListener</span>(<span class="hljs-string">&#x27;keyup&#x27;</span>, actionKeyUp, target);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-79">&#x00a7;</a>
              </div>
              <p>Listeners are only removed from the DOM element when all the keyboard zones associated with that target have been killed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">doRemoveListeners</span> = (<span class="hljs-params">target</span>) =&gt; {

        <span class="hljs-title function_">removeNativeListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, actionKeyDown, target);
        <span class="hljs-title function_">removeNativeListener</span>(<span class="hljs-string">&#x27;keyup&#x27;</span>, actionKeyUp, target);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-80">&#x00a7;</a>
              </div>
              <p>Returns an object containing the <code>kill</code> and <code>getMappedKeys</code> functions for this keyboard mapping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">processKeyboardZoneData</span>(items, doAddListeners, doRemoveListeners);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-81">&#x00a7;</a>
              </div>
              <h4 id="exports">Exports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> {
    uiSubscribedElements,
    currentCorePosition,
    addLocalMouseMoveListener,
    removeLocalMouseMoveListener,
    startCoreListeners,
    stopCoreListeners,
    applyCoreResizeListener,
    applyCoreScrollListener,
    forceUpdate,
    observeAndUpdate,
    makeDragZone,
    makeKeyboardZone,
    getTouchActionChoke,
    setTouchActionChoke,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
