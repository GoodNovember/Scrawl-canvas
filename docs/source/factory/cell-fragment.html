<!DOCTYPE html>

<html>
<head>
  <title>Cell-fragment factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/display-cycle.html">
                  ./source/core/display-cycle.js
                </a>
              
                
                <a class="source" href="../core/document-rootElements.html">
                  ./source/core/document-rootElements.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/random-seed.html">
                  ./source/core/random-seed.js
                </a>
              
                
                <a class="source" href="../core/snippets.html">
                  ./source/core/snippets.js
                </a>
              
                
                <a class="source" href="../core/system-flags.html">
                  ./source/core/system-flags.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell-fragment.html">
                  ./source/factory/cell-fragment.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="conicGradient.html">
                  ./source/factory/conicGradient.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="crescent.html">
                  ./source/factory/crescent.js
                </a>
              
                
                <a class="source" href="dragZone.html">
                  ./source/factory/dragZone.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="filterEngine-bluenoiseData.html">
                  ./source/factory/filterEngine-bluenoiseData.js
                </a>
              
                
                <a class="source" href="filterEngine.html">
                  ./source/factory/filterEngine.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="keyboardZone.html">
                  ./source/factory/keyboardZone.js
                </a>
              
                
                <a class="source" href="line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="lineSpiral.html">
                  ./source/factory/lineSpiral.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="noiseAsset.html">
                  ./source/factory/noiseAsset.js
                </a>
              
                
                <a class="source" href="observeUpdate.html">
                  ./source/factory/observeUpdate.js
                </a>
              
                
                <a class="source" href="oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="rawAsset.html">
                  ./source/factory/rawAsset.js
                </a>
              
                
                <a class="source" href="rdAsset.html">
                  ./source/factory/rdAsset.js
                </a>
              
                
                <a class="source" href="rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetAdvancedFunctionality.html">
                  ./source/mixin/assetAdvancedFunctionality.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <h1 id="cell-fragment-factory">Cell-fragment factory</h1>
<p>Create a highly reduced CellFragment which supplies the cell pool</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { styles, stylesnames, cell, cellnames } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/library.js&#x27;</span>;

<span class="hljs-keyword">import</span> { generateUniqueString, mergeOver, λ<span class="hljs-variable language_">this</span>, λ<span class="hljs-literal">null</span>, Ωempty, radian } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;

<span class="hljs-keyword">import</span> { getPixelRatio, getIgnorePixelRatio } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../core/events.js&quot;</span>;

<span class="hljs-keyword">import</span> { makeState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./state.js&#x27;</span>;

<span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/base.js&#x27;</span>;


<span class="hljs-keyword">const</span> poolDefs = {
    <span class="hljs-attr">element</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">engine</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">state</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">alpha</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">composite</span>: <span class="hljs-string">&#x27;source-over&#x27;</span>,
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h4 id="cellfragment-constructor">CellFragment constructor</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> <span class="hljs-title class_">CellFragment</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;

    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>);
    <span class="hljs-keyword">const</span> engine = <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span> = element.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>, {
        <span class="hljs-attr">willReadFrequently</span>: <span class="hljs-literal">true</span>,
    });

    element.<span class="hljs-property">width</span> = <span class="hljs-number">1</span>;
    element.<span class="hljs-property">height</span> = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-title function_">makeState</span>({ engine });

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(poolDefs);

    state.<span class="hljs-title function_">setStateFromEngine</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <h4 id="cellfragment-prototype">CellFragment prototype</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = <span class="hljs-title class_">CellFragment</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
P.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;CellFragment&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h4 id="mixins">Mixins</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = <span class="hljs-title function_">baseMix</span>(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <h4 id="cellfragment-attributes">CellFragment attributes</h4>
<ul>
<li>Attributes defined in the <a href="../mixin/base.html">base mixin</a>: <strong>name</strong>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>clearAlpha</strong> - a Number with a value between 0 and 1. When not zero, the cell will not clear itself; rather it will copy its current contents, clear itself, set its globalAlpha to this value, copy back its contents (now faded) and then restore its globalAlpha value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attr">clearAlpha</span>: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Non-base Cells will stamp themselves onto the ‘base’ Cell as part of the Display cycle’s show stage. We can mediate this action by setting the Cell’s <strong>alpha</strong> and <strong>composite</strong> attributes to valid Rendering2DContext <code>globalAlpha</code> and <code>globalCompositeOperation</code> values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attr">alpha</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">composite</span>: <span class="hljs-string">&#x27;source-over&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>We can also scale the Cell’s size in the displayed Canvas by setting the <strong>scale</strong> attribute to an appropriate value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,
};
P.<span class="hljs-property">defs</span> = <span class="hljs-title function_">mergeOver</span>(P.<span class="hljs-property">defs</span>, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <h4 id="packetclone-management">Packet/Clone management</h4>
<p>This functionality is disabled for CellFragments objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">stringifyFunction</span> = λ<span class="hljs-literal">null</span>;
P.<span class="hljs-property">processPacketOut</span> = λ<span class="hljs-literal">null</span>;
P.<span class="hljs-property">finalizePacketOut</span> = λ<span class="hljs-literal">null</span>;
P.<span class="hljs-property">saveAsPacket</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">return</span> <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.lib}</span>, {}]`</span>
};
P.<span class="hljs-property">clone</span> = λ<span class="hljs-variable language_">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <h4 id="kill-functionality">Kill functionality</h4>
<p>None required</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.<span class="hljs-property">getters</span>, 
    S = P.<span class="hljs-property">setters</span>,
    D = P.<span class="hljs-property">deltaSetters</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p><code>get</code> - overwrites the mixin/position function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">get</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) {

    <span class="hljs-keyword">let</span> getter = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getters</span>[item];

    <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);

    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">let</span> def = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defs</span>[item],
            state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>,
            val;

        <span class="hljs-keyword">if</span> (def != <span class="hljs-literal">null</span>) {

            val = <span class="hljs-variable language_">this</span>[item];
            <span class="hljs-keyword">return</span> (val != <span class="hljs-literal">null</span>) ? val : def;
        }

        def = state.<span class="hljs-property">defs</span>[item];

        <span class="hljs-keyword">if</span> (def != <span class="hljs-literal">null</span>) {

            val = state[item];
            <span class="hljs-keyword">return</span> (val != <span class="hljs-literal">null</span>) ? val : def;
        }
        <span class="hljs-keyword">return</span> undef;
    }
};

S.<span class="hljs-property">clearAlpha</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {

    <span class="hljs-keyword">if</span> (val.<span class="hljs-property">toFixed</span>) {

        <span class="hljs-keyword">if</span> (val &gt; <span class="hljs-number">1</span>) val = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &lt; <span class="hljs-number">0</span>) val = <span class="hljs-number">0</span>;

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clearAlpha</span> = val;
    }
};
D.<span class="hljs-property">clearAlpha</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {

    <span class="hljs-keyword">if</span> (val.<span class="hljs-property">toFixed</span>) {

        val += <span class="hljs-variable language_">this</span>.<span class="hljs-property">clearAlpha</span>;

        <span class="hljs-keyword">if</span> (val &gt; <span class="hljs-number">1</span>) val = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val &lt; <span class="hljs-number">0</span>) val = <span class="hljs-number">0</span>;

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">clearAlpha</span> = val;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>
<p>The following functions set the Cell wrapper’s &lt;canvas&gt; element’s CanvasRenderingContext2D engine’s attributes to match a given set of values</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p><code>setEngineFromState</code> - internal function: set engine to match this Cell’s State object’s attribute values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">setEngineFromState</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) {

    <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>,
        stateKeys = state.<span class="hljs-property">allKeys</span>,
        stateKeysLen = stateKeys.<span class="hljs-property">length</span>;

    <span class="hljs-keyword">let</span> i, iz, key, eVal, sVal;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; stateKeysLen; i++) {

        key = stateKeys[i];
        eVal = engine[key];
        sVal = state[key];

        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;lineDash&#x27;</span>) {

            engine.<span class="hljs-property">lineDash</span> = sVal;
            engine.<span class="hljs-title function_">setLineDash</span>(engine.<span class="hljs-property">lineDash</span>);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eVal !== sVal) engine[key] = sVal;
    }
    <span class="hljs-keyword">if</span> (engine.<span class="hljs-property">textAlign</span> !== <span class="hljs-string">&#x27;left&#x27;</span>) engine.<span class="hljs-property">textAlign</span> = <span class="hljs-string">&#x27;left&#x27;</span>;
    <span class="hljs-keyword">if</span> (engine.<span class="hljs-property">textBaseline</span> !== <span class="hljs-string">&#x27;top&#x27;</span>) engine.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">&#x27;top&#x27;</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p><code>setToDefaults</code> - internal function: set engine to match the State Factory’s default attribute values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">setToDefaults</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">let</span> items = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">defs</span>,
        state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>,
        engine = <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>,
        isArray = <span class="hljs-title class_">Array</span>.<span class="hljs-property">isArray</span>;

    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(items).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;lineDash&#x27;</span>) {

            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isArray</span>(engine.<span class="hljs-property">lineDash</span>)) engine.<span class="hljs-property">lineDash</span> = [];
            <span class="hljs-keyword">else</span> engine.<span class="hljs-property">lineDash</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isArray</span>(state.<span class="hljs-property">lineDash</span>)) state.<span class="hljs-property">lineDash</span> = [];
            <span class="hljs-keyword">else</span> state.<span class="hljs-property">lineDash</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">else</span> {

            engine[key] = value;
            state[key] = value;
        }
    });

    engine.<span class="hljs-property">textAlign</span> = state.<span class="hljs-property">textAlign</span> = <span class="hljs-string">&#x27;left&#x27;</span>;
    engine.<span class="hljs-property">textBaseline</span> = state.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">&#x27;top&#x27;</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p><code>setEngine</code> - internal function: set engine to match the entity object’s State attribute values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">stylesArray</span> = [<span class="hljs-string">&#x27;Gradient&#x27;</span>, <span class="hljs-string">&#x27;RadialGradient&#x27;</span>, <span class="hljs-string">&#x27;Pattern&#x27;</span>];
P.<span class="hljs-property">setEngine</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">entity</span>) {

    <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>,
        entityState = entity.<span class="hljs-property">state</span>;

    <span class="hljs-keyword">if</span> (entityState) {

        <span class="hljs-keyword">let</span> engine, item,
            changes = entityState.<span class="hljs-title function_">getChanges</span>(entity, state),
            action = <span class="hljs-variable language_">this</span>.<span class="hljs-property">setEngineActions</span>,
            stylesArray = <span class="hljs-variable language_">this</span>.<span class="hljs-property">stylesArray</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(changes).<span class="hljs-property">length</span>) {

            engine = <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>;

            <span class="hljs-keyword">for</span> (item <span class="hljs-keyword">in</span> changes) {

                action[item](changes[item], engine, stylesArray, entity, <span class="hljs-variable language_">this</span>);
                state[item] = changes[item];
            }
        }
    }
    <span class="hljs-keyword">return</span> entity;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p><strong>setEngineActions</strong> - an Object containing functions for updating the engine’s attributes; used by <code>setEngine</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">setEngineActions</span> = {

    <span class="hljs-attr">fillStyle</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine, stylesArray, entity, layer</span>) {

        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">substring</span>) {

            <span class="hljs-keyword">let</span> brokenStyle = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (stylesnames.<span class="hljs-title function_">indexOf</span>(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = styles[item];
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cellnames.<span class="hljs-title function_">indexOf</span>(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = cell[item];

            <span class="hljs-keyword">if</span> (brokenStyle) {
                
                entity.<span class="hljs-property">state</span>.<span class="hljs-property">fillStyle</span> = brokenStyle;
                engine.<span class="hljs-property">fillStyle</span> = brokenStyle.<span class="hljs-title function_">getData</span>(entity, layer);
            }
            <span class="hljs-keyword">else</span> engine.<span class="hljs-property">fillStyle</span> = item;
        }
        <span class="hljs-keyword">else</span> engine.<span class="hljs-property">fillStyle</span> = item.<span class="hljs-title function_">getData</span>(entity, layer);
    },

    <span class="hljs-attr">filter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">filter</span> = item;
    },

    <span class="hljs-attr">font</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">font</span> = item;
    },

    <span class="hljs-attr">globalAlpha</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">globalAlpha</span> = item;
    },

    <span class="hljs-attr">globalCompositeOperation</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">globalCompositeOperation</span> = item;
    },

    <span class="hljs-attr">imageSmoothingEnabled</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">imageSmoothingEnabled</span> = item;
    },

    <span class="hljs-attr">imageSmoothingQuality</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">imageSmoothingQuality</span> = item;
    },

    <span class="hljs-attr">lineCap</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">lineCap</span> = item;
    },

    <span class="hljs-attr">lineDash</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">lineDash</span> = item;
        <span class="hljs-keyword">if</span> (engine.<span class="hljs-property">setLineDash</span>) engine.<span class="hljs-title function_">setLineDash</span>(item);
    },

    <span class="hljs-attr">lineDashOffset</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">lineDashOffset</span> = item;
    },

    <span class="hljs-attr">lineJoin</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">lineJoin</span> = item;
    },

    <span class="hljs-attr">lineWidth</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">lineWidth</span> = item;
    },

    <span class="hljs-attr">miterLimit</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">miterLimit</span> = item;
    },

    <span class="hljs-attr">shadowBlur</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">shadowBlur</span> = item;
    },

    <span class="hljs-attr">shadowColor</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">shadowColor</span> = item;
    },

    <span class="hljs-attr">shadowOffsetX</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">shadowOffsetX</span> = item;
    },

    <span class="hljs-attr">shadowOffsetY</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine</span>) {
        engine.<span class="hljs-property">shadowOffsetY</span> = item;
    },

    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">item, engine, stylesArray, entity, layer</span>) {

        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">substring</span>) {

            <span class="hljs-keyword">let</span> brokenStyle = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (stylesnames.<span class="hljs-title function_">indexOf</span>(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = styles[item];
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cellnames.<span class="hljs-title function_">indexOf</span>(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = cell[item];

            <span class="hljs-keyword">if</span> (brokenStyle) {
                
                entity.<span class="hljs-property">state</span>.<span class="hljs-property">strokeStyle</span> = brokenStyle;
                engine.<span class="hljs-property">strokeStyle</span> = brokenStyle.<span class="hljs-title function_">getData</span>(entity, layer);
            }
            <span class="hljs-keyword">else</span> engine.<span class="hljs-property">strokeStyle</span> = item;
        }
        <span class="hljs-keyword">else</span> engine.<span class="hljs-property">strokeStyle</span> = item.<span class="hljs-title function_">getData</span>(entity, layer);
    },
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>The following functions are used as part of entity object <code>stamp</code> functionality - specifically for those with a <strong>method</strong> whose appearance is affected by shadows, and for the <code>clear</code> method</p>
<ul>
<li>Scrawl-canvas, for the most part, avoids using engine.save() and engine.restore() functionality, instead preferring to keep track of engine state in State objects. </li>
<li>When clearing and restoring shadows - a frequent operation given Scrawl-canvas functionality around stamping methods - both the Cell’s state object and the Canvas context engine need to be updated with the necessary data </li>
<li>The same reasoning holds when setting up the context engine to ‘clear’ an entity from the canvas display instead of stamping it onto the canvas</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p><code>clearShadow</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">clearShadow</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowOffsetX</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowOffsetY</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowBlur</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowOffsetX</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowOffsetY</span> = <span class="hljs-number">0.0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowBlur</span> = <span class="hljs-number">0.0</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p><code>restoreShadow</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">restoreShadow</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">entity</span>) {

    <span class="hljs-keyword">let</span> state = entity.<span class="hljs-property">state</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowOffsetX</span> = state.<span class="hljs-property">shadowOffsetX</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowOffsetY</span> = state.<span class="hljs-property">shadowOffsetY</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowBlur</span> = state.<span class="hljs-property">shadowBlur</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowOffsetX</span> = state.<span class="hljs-property">shadowOffsetX</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowOffsetY</span> = state.<span class="hljs-property">shadowOffsetY</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowBlur</span> = state.<span class="hljs-property">shadowBlur</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p><code>setToClearShape</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">setToClearShape</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-property">shadowColor</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">shadowColor</span> = <span class="hljs-string">&#x27;rgb(0 0 0 / 0)&#x27;</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p><code>saveEngine</code>, <code>restoreEngine</code> - save and restore the Cell wrapper’s &lt;canvas&gt; element’s CanvasRenderingContext2D engine’s current state to/from a stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">saveEngine</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-title function_">save</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};

P.<span class="hljs-property">restoreEngine</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">engine</span>.<span class="hljs-title function_">restore</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p><code>getComputedFontSizes</code> - internal function - the Cell wrapper gets passed by Phrase entitys to its fontAttributes object, which then invokes it when calculating font sizes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getComputedFontSizes</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">let</span> host = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHost</span>();

    <span class="hljs-keyword">if</span> (host &amp;&amp; host.<span class="hljs-property">domElement</span>) {

        <span class="hljs-keyword">let</span> em = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(host.<span class="hljs-property">domElement</span>),
            rem = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>);

        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">parseFloat</span>(em.<span class="hljs-property">fontSize</span>), <span class="hljs-built_in">parseFloat</span>(rem.<span class="hljs-property">fontSize</span>), <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p><code>checkEngineScale</code>
DPR is detected in the <code>core/events.js</code> file, but mainly handled here</p>
<ul>
<li>We scale the cell by DPR - this should be the only time we touch native scale functionality!</li>
<li>All the other scaling functionality in SC is handled by computiation - applying the scaling factor to dimensions, start, handle, offset etc values which then get saved in the <code>current</code> equivalent attributes</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> checkEngineScale = <span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) {

    <span class="hljs-keyword">if</span> (engine) {

        engine.<span class="hljs-title function_">setTransform</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getIgnorePixelRatio</span>()) engine.<span class="hljs-title function_">scale</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">const</span> dpr = <span class="hljs-title function_">getPixelRatio</span>();
            engine.<span class="hljs-title function_">scale</span>(dpr, dpr);
            <span class="hljs-keyword">return</span> dpr;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p><code>getEntityHits</code> - Returns an array of entity Objects responding ‘true’ to a checkHit call on them, for the Cell’s current <code>.here</code> attribute coordinates. Used in particular with <code>Canvas.cascadeEventAction()</code> function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">getEntityHits</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">let</span> response = [],
        results = [],
        resultNames = [];

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">groupBuckets</span>) {

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">groupBuckets</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">grp</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (grp.<span class="hljs-property">visibility</span>) results.<span class="hljs-title function_">push</span>(grp.<span class="hljs-title function_">getAllArtefactsAt</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">here</span>));
        }, <span class="hljs-variable language_">this</span>);
    }

    <span class="hljs-keyword">if</span> (results.<span class="hljs-property">length</span>) {

        results = results.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a.<span class="hljs-title function_">concat</span>(v), []);

        results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {

            <span class="hljs-keyword">let</span> art = item.<span class="hljs-property">artefact</span>;

            <span class="hljs-keyword">if</span> (art.<span class="hljs-property">visibility</span> &amp;&amp; resultNames.<span class="hljs-title function_">indexOf</span>(art.<span class="hljs-property">name</span>) &lt; <span class="hljs-number">0</span>) {

                resultNames.<span class="hljs-title function_">push</span>(art.<span class="hljs-property">name</span>);
                response.<span class="hljs-title function_">push</span>(art);
            }
        })
    }
    <span class="hljs-keyword">return</span> response;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p><code>rotateDestination</code> - internal function, called by entity objects about to stamp themselves onto the Cell.</p>
<ul>
<li>entity stamp functionality works by performing a <code>setTransform</code> action on the Cell engine so that engine coordinates [0, 0] equal the entity’s <code>currentStampPosition</code> coordinates, alongside any directionality (<code>flipReverse</code>, <code>flipUpend</code>) and rotational (<code>roll</code>) changes necessary</li>
<li>doing it this way saves a massive amount of calculation that is otherwise required to correctly position the entity in the display</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.<span class="hljs-property">rotateDestination</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">engine, x, y, entity</span>) {

    <span class="hljs-keyword">let</span> self = (entity) ? entity : <span class="hljs-variable language_">this</span>,
        mimic = self.<span class="hljs-property">mimic</span>,
        pivot = self.<span class="hljs-property">pivot</span>,
        reverse, upend,
        rotation = self.<span class="hljs-property">currentRotation</span>;

    <span class="hljs-keyword">if</span> (mimic &amp;&amp; mimic.<span class="hljs-property">name</span> &amp;&amp; self.<span class="hljs-property">useMimicFlip</span>) {

        reverse = (mimic.<span class="hljs-property">flipReverse</span>) ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
        upend = (mimic.<span class="hljs-property">flipUpend</span>) ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">else</span> {

        reverse = (self.<span class="hljs-property">flipReverse</span>) ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
        upend = (self.<span class="hljs-property">flipUpend</span>) ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">if</span> (mimic &amp;&amp; mimic.<span class="hljs-property">name</span> &amp;&amp; self.<span class="hljs-property">useMimicRotation</span>) {

        rotation = mimic.<span class="hljs-property">currentRotation</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pivot &amp;&amp; pivot.<span class="hljs-property">name</span> &amp;&amp; self.<span class="hljs-property">addPivotRotation</span>) {

        rotation = pivot.<span class="hljs-property">currentRotation</span>;
    }

    <span class="hljs-keyword">if</span> (rotation) {

        rotation *= radian;

        <span class="hljs-keyword">let</span> cos = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(rotation),
            sin = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(rotation);

        engine.<span class="hljs-title function_">setTransform</span>((cos * reverse), (sin * reverse), (-sin * upend), (cos * upend), x, y);
    }
    <span class="hljs-keyword">else</span> engine.<span class="hljs-title function_">setTransform</span>(reverse, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, upend, x, y);

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <h4 id="cell-pool">Cell pool</h4>
<p>A number of processes - for instance collision functionality, and applying filters to entitys and groups - require the use of a &lt;canvas&gt; element and its CanvasRenderingContext2D engine. Rather than generate these canvas elements on the fly, we store them in a pool, to help make the code more efficiant.</p>
<p>To use a pool cell, request it using the exposed <strong>requestCell</strong> function.</p>
<p>IT IS IMPERATIVE that requested cells are released once work with them completes, using the <strong>releaseCell</strong> function. Failure to do this leads to impaired performance as Javascript creates new canvas elements (often in multiples of 60 per second) which need to be garbage collected by the Javascript engine, thus leading to increasingly shoddy performance the longer the animation runs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> cellPool = [];

<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p><code>Exported function</code> - <strong>requestCell</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> requestCell = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {

    <span class="hljs-keyword">if</span> (!cellPool.<span class="hljs-property">length</span>) cellPool.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CellFragment</span>(<span class="hljs-string">`pool_<span class="hljs-subst">${count++}</span>`</span>));

    <span class="hljs-keyword">let</span> c = cellPool.<span class="hljs-title function_">shift</span>();
    c.<span class="hljs-property">engine</span>.<span class="hljs-title function_">save</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>console.log(c.name, c.element.width, c.element.height);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> c;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p><code>Exported function</code> - <strong>releaseCell</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> releaseCell = <span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) {

    <span class="hljs-keyword">if</span> (c &amp;&amp; c.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;CellFragment&#x27;</span>) {

        c.<span class="hljs-property">engine</span>.<span class="hljs-title function_">restore</span>();
        cellPool.<span class="hljs-title function_">push</span>(c);
    }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
