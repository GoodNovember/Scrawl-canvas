<!DOCTYPE html>

<html>
<head>
  <title>Mesh factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="cog.html">
                  ./source/factory/cog.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="filterEngine.html">
                  ./source/factory/filterEngine.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="mesh.html">
                  ./source/factory/mesh.js
                </a>
              
                
                <a class="source" href="net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="noise.html">
                  ./source/factory/noise.js
                </a>
              
                
                <a class="source" href="oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="../mixin/displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="../mixin/path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="../mixin/pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="../mixin/pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="../mixin/shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="mesh-factory">Mesh factory</h1>
<p>The Scrawl-canvas Mesh entity applies a Net particle system to an image, allowing the image to be deformed by dragging particles around the canvas. This is a similar concept to <a href="https://helpx.adobe.com/uk/photoshop/using/warp-images-shapes-paths.html">Photoshop warp meshes</a> and (more distantly) <a href="https://docs.gimp.org/2.10/en/gimp-tool-cage.html">the Gimp’s cage tool</a>.</p>
<p>Mesh entitys are <strong><em>composite entitys</em></strong> - an entity that relies on other entitys for its basic functionality.</p>
<ul>
<li>Every Mesh object requires a <a href="./net.html">Net</a> entity create the grid that it uses for transforming its image.</li>
<li>A Mesh entity also requires a <a href="./picture.html">Picture</a> entity to act as its image source.</li>
<li>Meshes can (in theory) use CSS color Strings for their strokeStyle values, alongside <strong>Gradient</strong>, <strong>RadialGradient</strong>, <strong>Color</strong> and <strong>Pattern</strong> objects. </li>
<li>They can (in theory) use <strong>Anchor</strong> objects for user navigation. </li>
<li>They can (in theory) be rendered to the canvas by including them in a <strong>Cell</strong> object’s <strong>Group</strong>. </li>
<li>They can (in theory) be <strong>animated</strong> directly, or using delta animation, or act as the target for <strong>Tween</strong> animations.</li>
<li>Meshes can (in theory) be cloned, and killed.</li>
</ul>
<p><strong><em>Note that this is experimental technology!</em></strong></p>
<ul>
<li>The Mesh entity code base shares many similarities to that of the Loom entity; some of the code has been copied over from that file directly.</li>
<li>Current code does not use <a href="./mixin/position.html">position</a> or <a href="./mixin/entity.html">entity</a> mixins, meaning much of the code here has been copied over from those mixins (DRY issue).</li>
<li>TODO: packet management, clone and kill functionality not yet tested. Much of the other functionality also lacks tests.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="demos">Demos:</h4>
<ul>
<li><a href="../../demo/particles-008.html">Particles-008</a> - Net entity: generation and basic functionality, including Spring objects</li>
<li><a href="../../demo/particles-016.html">Particles-016</a> - Mesh entitys</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { <span class="hljs-title">constructors</span>, <span class="hljs-title">artefact</span> } <span class="hljs-title">from</span> &#x27;../<span class="hljs-title">core</span>/<span class="hljs-title">library</span>.<span class="hljs-title">js</span>&#x27;;
<span class="hljs-keyword">import</span> { currentGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/document.js&#x27;</span>;
<span class="hljs-keyword">import</span> { mergeOver, mergeDiscard, pushUnique, λ<span class="hljs-literal">null</span>, λ<span class="hljs-built_in">this</span>, xta } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;

<span class="hljs-keyword">import</span> { makeState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/state.js&#x27;</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/cell.js&#x27;</span>;

<span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/base.js&#x27;</span>;
<span class="hljs-keyword">import</span> anchorMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/anchor.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="mesh-constructor">Mesh constructor</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Mesh = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-built_in">this</span>.makeName(items.name);
    <span class="hljs-built_in">this</span>.register();

    <span class="hljs-built_in">this</span>.set(<span class="hljs-built_in">this</span>.defs);

    <span class="hljs-built_in">this</span>.state = makeState();

    <span class="hljs-keyword">if</span> (!items.group) items.group = currentGroup;

    <span class="hljs-built_in">this</span>.onEnter = λ<span class="hljs-literal">null</span>;
    <span class="hljs-built_in">this</span>.onLeave = λ<span class="hljs-literal">null</span>;
    <span class="hljs-built_in">this</span>.onDown = λ<span class="hljs-literal">null</span>;
    <span class="hljs-built_in">this</span>.onUp = λ<span class="hljs-literal">null</span>;

    <span class="hljs-built_in">this</span>.delta = {};

    <span class="hljs-built_in">this</span>.set(items);

    <span class="hljs-built_in">this</span>.fromPathData = [];
    <span class="hljs-built_in">this</span>.toPathData = [];

    <span class="hljs-built_in">this</span>.watchFromPath = <span class="hljs-literal">null</span>;
    <span class="hljs-built_in">this</span>.watchIndex = -<span class="hljs-number">1</span>;
    <span class="hljs-built_in">this</span>.engineInstructions = [];
    <span class="hljs-built_in">this</span>.engineDeltaLengths = [];

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="mesh-prototype">Mesh prototype</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = Mesh.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.prototype);
P.type = <span class="hljs-string">&#x27;Mesh&#x27;</span>;
P.lib = <span class="hljs-string">&#x27;entity&#x27;</span>;
P.isArtefact = <span class="hljs-literal">true</span>;
P.isAsset = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4 id="mixins">Mixins</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = baseMix(P);
P = anchorMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4 id="mesh-attributes">Mesh attributes</h4>
<ul>
<li>Attributes defined in the <a href="../mixin/base.html">base mixin</a>: <strong>name</strong>.</li>
<li>Attributes defined in the <a href="../mixin/anchor.html">anchor mixin</a>: <strong>anchor</strong>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>net</strong> - A Mesh entity requires a Net entity, set to generate a weak or strong net, to supply Particle objects to act as its mapping coordinates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    net: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>isHorizontalCopy</strong> - Boolean flag - Copying the source image to the output happens, by default, by rows - which effectively means the struts are on the left-hand and right-hand edges of the image. </p>
<ul>
<li>To change this to columns (which sets the struts to the top and bottom edges of the image) set the attribute to <code>false</code> </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isHorizontalCopy: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>source</strong> - The Picture entity source for this Mesh. For initialization and/or <code>set</code>, we can supply either the Picture entity itself, or its name-String value.</p>
<ul>
<li>The content image displayed by the Mesh entity are set in the Picture entity, not the Mesh, and can be any artefact supported by the Picture (image, video, sprite, or a Cell artefact).</li>
<li>Note that any <strong><em>filters should be applied to the Picture entity</em></strong>; Mesh entitys do not support filter functionality but will apply a Picture’s filters to the source image as-and-where appropriate.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    source: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>sourceIsVideoOrSprite</strong> - Boolean flag - If the Picture entity is hosting a video or sprite asset, we need to update the input on every frame. </p>
<ul>
<li>It’s easier to tell the Mesh entity to do this using a flag, rather than get the Picture entity to update all its Mesh subscribers on every display cycle. </li>
<li>For Pictures using image assets the flag must be set to <code>false</code> (the default); setting the flag to <code>true</code> will significantly degrade display and animation performance.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sourceIsVideoOrSprite: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The current Frame drawing process often leads to <a href="https://en.wikipedia.org/wiki/Moir%C3%A9_pattern">moiré interference patterns</a> appearing in the resulting image. Scrawl-canvas uses a resize trick to blur out these patterns. </p>
<p><strong>interferenceLoops</strong> (positive integer Number), <strong>interferenceFactor</strong> (positive float Number) - The interferenceFactor attribute sets the resizing ratio; while he interferenceLoops attribute sets the number of times the image gets resized. </p>
<ul>
<li>If inteference patterns still appear in the final image, tweak these values to see if a better output can be achieved.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    interferenceLoops: <span class="hljs-number">2</span>,
    <span class="hljs-attr">interferenceFactor</span>: <span class="hljs-number">1.03</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The Mesh entity does not use the <a href="./mixin/position.html">position</a> or <a href="./mixin/entity.html">entity</a> mixins (used by most other entitys) as its positioning is entirely dependent on the position, rotation, scale etc of its constituent Shape path entity struts. </p>
<p>It does, however, use these attributes (alongside their setters and getters): <strong>visibility</strong>, <strong>order</strong>, <strong>delta</strong>, <strong>host</strong>, <strong>group</strong>, <strong>anchor</strong>, <strong>collides</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    visibility: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">delta</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">group</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">anchor</span>: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>noCanvasEngineUpdates</strong> - Boolean flag - Canvas engine updates are required for the Mesh’s border - strokeStyle and line styling; if a Mesh is to be drawn without a border, then setting this flag to <code>true</code> may help improve rendering efficiency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noCanvasEngineUpdates: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>noDeltaUpdates</strong> - Boolean flag - Mesh entitys support delta animation - achieved by updating the <code>...path</code> attributes by appropriate (and small!) values. If the Mesh is not going to be animated by delta values, setting the flag to <code>true</code> may help improve rendering efficiency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noDeltaUpdates: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>onEnter</strong>, <strong>onLeave</strong>, <strong>onDown</strong>, <strong>onUp</strong> - Mesh entitys support <strong><em>collision detection</em></strong>, reporting a hit when a test coordinate falls within the Mesh’s output image. As a result, Looms can also accept and act on the four <strong>on</strong> functions - see <a href="../mixin/entity.html#section-11">entity event listener functions</a> for more details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onEnter: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onLeave</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onDown</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onUp</span>: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>noUserInteraction</strong> - Boolean flag - To switch off collision detection for a Mesh entity - which might help improve rendering efficiency - set the flag to <code>true</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noUserInteraction: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><a href="./anchor.html">Anchor objects</a> can be assigned to Mesh entitys, meaning the following attributes are supported:</p>
<ul>
<li>anchorDescription</li>
<li>anchorType</li>
<li>anchorTarget</li>
<li>anchorRel</li>
<li>anchorReferrerPolicy</li>
<li>anchorPing</li>
<li>anchorHreflang</li>
<li>anchorHref</li>
<li>anchorDownload</li>
</ul>
<p>And the anchor attributes can also be supplied as a key:value object assigned to the <strong>anchor</strong> attribute:</p>
<pre><code>    anchor: {
        description
        download
        href
        hreflang
        ping
        referrerpolicy
        <span class="hljs-attr">rel</span>:
        target:
        anchorType
        <span class="hljs-attr">clickAction</span>: 
    }</code></pre>
<p><strong>method</strong> - All normal Scrawl-canvas entity stamping methods are supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    method: <span class="hljs-string">&#x27;fill&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Mesh entitys support appropriate styling attributes, mainly for their stroke styles (used with the <code>draw</code>, <code>drawAndFill</code>, <code>fillAndDraw</code>, <code>drawThenFill</code> and <code>fillThenDraw</code> stamping methods). </p>
<ul>
<li>These <strong><em>state</em></strong> attributes are stored directly on the object, rather than in a separate <a href="./state.html">State</a> object. </li>
</ul>
<p>The following attributes are thus supported:</p>
<p>Alpha and Composite operations will be applied to both the Mesh entity’s border (the Shape entitys, with connecting lines between their paths’ start and end points) and fill (the image displayed between the Mesh’s struts)</p>
<ul>
<li><strong>globalAlpha</strong></li>
<li><strong>globalCompositeOperation</strong></li>
</ul>
<p>All line attributes are supported</p>
<ul>
<li><strong>lineWidth</strong></li>
<li><strong>lineCap</strong></li>
<li><strong>lineJoin</strong></li>
<li><strong>lineDash</strong></li>
<li><strong>lineDashOffset</strong></li>
<li><strong>miterLimit</strong></li>
</ul>
<p>The Mesh entity’s strokeStyle can be any style supported by Scrawl-canvas - color strings, gradient objects, and pattern objects</p>
<ul>
<li><strong>strokeStyle</strong></li>
</ul>
<p>The shadow attributes will only be applied to the stroke (border), not to the Mesh’s fill (image)</p>
<ul>
<li><strong>shadowOffsetX</strong></li>
<li><strong>shadowOffsetY</strong></li>
<li><strong>shadowBlur</strong></li>
<li><strong>shadowColor</strong></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>};
P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">&#x27;pathObject&#x27;</span>, <span class="hljs-string">&#x27;state&#x27;</span>]);
P.packetExclusionsByRegex = pushUnique(P.packetExclusionsByRegex, [<span class="hljs-string">&#x27;^(local|dirty|current)&#x27;</span>, <span class="hljs-string">&#x27;Subscriber$&#x27;</span>]);
P.packetCoordinates = pushUnique(P.packetCoordinates, []);
P.packetObjects = pushUnique(P.packetObjects, [<span class="hljs-string">&#x27;group&#x27;</span>, <span class="hljs-string">&#x27;net&#x27;</span>, <span class="hljs-string">&#x27;source&#x27;</span>]);
P.packetFunctions = pushUnique(P.packetFunctions, [<span class="hljs-string">&#x27;onEnter&#x27;</span>, <span class="hljs-string">&#x27;onLeave&#x27;</span>, <span class="hljs-string">&#x27;onDown&#x27;</span>, <span class="hljs-string">&#x27;onUp&#x27;</span>]);

P.processPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

    <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span>(includes.indexOf(key) &lt; <span class="hljs-number">0</span> &amp;&amp; value === <span class="hljs-built_in">this</span>.defs[key]) result = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> result;
};

P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

    <span class="hljs-keyword">let</span> stateCopy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">this</span>.state.saveAsPacket(items))[<span class="hljs-number">3</span>];
    copy = mergeOver(copy, stateCopy);

    copy = <span class="hljs-built_in">this</span>.handlePacketAnchor(copy, items);

    <span class="hljs-keyword">return</span> copy;
};

P.handlePacketAnchor = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.anchor) {

        <span class="hljs-keyword">let</span> a = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">this</span>.anchor.saveAsPacket(items))[<span class="hljs-number">3</span>];
        copy.anchor = a;
    }
    <span class="hljs-keyword">return</span> copy;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p>TODO - this functionality is currently disabled, need to enable it and make it work properly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.clone = λ<span class="hljs-built_in">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>
<p>No additional kill functionality required</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.getters,
    S = P.setters,
    D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>get</strong> - copied over from the entity mixin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> getter = <span class="hljs-built_in">this</span>.getters[item];

    <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.call(<span class="hljs-built_in">this</span>);

    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">let</span> def = <span class="hljs-built_in">this</span>.defs[item],
            state = <span class="hljs-built_in">this</span>.state,
            val;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">&#x27;undefined&#x27;</span>) {

            val = <span class="hljs-built_in">this</span>[item];
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">&#x27;undefined&#x27;</span>) ? val : def;
        }

        def = state.defs[item];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">&#x27;undefined&#x27;</span>) {

            val = state[item];
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">&#x27;undefined&#x27;</span>) ? val : def;
        }
        <span class="hljs-keyword">return</span> undef;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong>set</strong> - copied over from the entity mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

        <span class="hljs-keyword">let</span> setters = <span class="hljs-built_in">this</span>.setters,
            defs = <span class="hljs-built_in">this</span>.defs,
            state = <span class="hljs-built_in">this</span>.state,
            stateSetters = (state) ? state.setters : {},
            stateDefs = (state) ? state.defs : {},
            predefined, stateFlag;

        <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">&#x27;name&#x27;</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                predefined = setters[key];
                stateFlag = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">if</span> (!predefined) {

                    predefined = stateSetters[key];
                    stateFlag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-built_in">this</span>.state : <span class="hljs-built_in">this</span>, value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) <span class="hljs-built_in">this</span>[key] = value;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) state[key] = value;
            }
        }, <span class="hljs-built_in">this</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong>setDelta</strong> - copied over from the entity mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

        <span class="hljs-keyword">let</span> setters = <span class="hljs-built_in">this</span>.deltaSetters,
            defs = <span class="hljs-built_in">this</span>.defs,
            state = <span class="hljs-built_in">this</span>.state,
            stateSetters = (state) ? state.deltaSetters : {},
            stateDefs = (state) ? state.defs : {},
            predefined, stateFlag;

        <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">&#x27;name&#x27;</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                predefined = setters[key];
                stateFlag = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">if</span> (!predefined) {

                    predefined = stateSetters[key];
                    stateFlag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-built_in">this</span>.state : <span class="hljs-built_in">this</span>, value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) <span class="hljs-built_in">this</span>[key] = addStrings(<span class="hljs-built_in">this</span>[key], value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) state[key] = addStrings(state[key], value);
            }
        }, <span class="hljs-built_in">this</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong>host</strong>, <strong>getHost</strong> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.host = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">let</span> host = artefact[item];

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.here) <span class="hljs-built_in">this</span>.host = host.name;
        <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.host = item;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.host = <span class="hljs-string">&#x27;&#x27;</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong>group</strong> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.group) ? <span class="hljs-built_in">this</span>.group.name : <span class="hljs-string">&#x27;&#x27;</span>;
};
S.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> g;

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.group &amp;&amp; <span class="hljs-built_in">this</span>.group.type === <span class="hljs-string">&#x27;Group&#x27;</span>) <span class="hljs-built_in">this</span>.group.removeArtefacts(<span class="hljs-built_in">this</span>.name);

        <span class="hljs-keyword">if</span> (item.substring) {

            g = group[item];

            <span class="hljs-keyword">if</span> (g) <span class="hljs-built_in">this</span>.group = g;
            <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.group = item;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.group = item;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.group &amp;&amp; <span class="hljs-built_in">this</span>.group.type === <span class="hljs-string">&#x27;Group&#x27;</span>) <span class="hljs-built_in">this</span>.group.addArtefacts(<span class="hljs-built_in">this</span>.name);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><strong>getHere</strong> - returns current core position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getHere = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> currentCorePosition;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><strong>delta</strong> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.delta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (items) <span class="hljs-built_in">this</span>.delta = mergeDiscard(<span class="hljs-built_in">this</span>.delta, items);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong>net</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.net = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        item = (item.substring) ? artefact[item] : item;

        <span class="hljs-keyword">if</span> (item &amp;&amp; item.type === <span class="hljs-string">&#x27;Net&#x27;</span>) {

            <span class="hljs-built_in">this</span>.net = item;
            <span class="hljs-built_in">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong>source</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.source = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    item = (item.substring) ? artefact[item] : item;

    <span class="hljs-keyword">if</span> (item &amp;&amp; item.type === <span class="hljs-string">&#x27;Picture&#x27;</span>) {

        <span class="hljs-keyword">let</span> src = <span class="hljs-built_in">this</span>.source;

        <span class="hljs-keyword">if</span> (src &amp;&amp; src.type === <span class="hljs-string">&#x27;Picture&#x27;</span>) src.imageUnsubscribe(<span class="hljs-built_in">this</span>.name);

        <span class="hljs-built_in">this</span>.source = item;
        item.imageSubscribe(<span class="hljs-built_in">this</span>.name);
        <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong>isHorizontalCopy</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.isHorizontalCopy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-built_in">this</span>.isHorizontalCopy = (item) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>getHost</code> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getHost = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentHost) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.currentHost;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.host) {

        <span class="hljs-keyword">let</span> host = artefact[<span class="hljs-built_in">this</span>.host];

        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-built_in">this</span>.currentHost = host;
            <span class="hljs-built_in">this</span>.dirtyHost = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.currentHost;
        }
    }
    <span class="hljs-keyword">return</span> currentCorePosition;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><code>updateByDelta</code>, <code>reverseByDelta</code> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.updateByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-built_in">this</span>.setDelta(<span class="hljs-built_in">this</span>.delta);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};

P.reverseByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> temp = {};
    
    <span class="hljs-built_in">Object</span>.entries(<span class="hljs-built_in">this</span>.delta).forEach(<span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (val.substring) val = -(<span class="hljs-built_in">parseFloat</span>(val)) + <span class="hljs-string">&#x27;%&#x27;</span>;
        <span class="hljs-keyword">else</span> val = -val;

        temp[key] = val;
    });

    <span class="hljs-built_in">this</span>.setDelta(temp);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><code>setDeltaValues</code> - copied over from the position mixin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setDeltaValues = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">let</span> delta = <span class="hljs-built_in">this</span>.delta, 
        oldVal, action;

    <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, requirement]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (xt(delta[key])) {

            action = requirement;

            oldVal = delta[key];

            <span class="hljs-keyword">switch</span> (action) {

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;reverse&#x27;</span> :
                    <span class="hljs-keyword">if</span> (oldVal.toFixed) delta[key] = -oldVal;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>TODO: reverse String% (and em, etc) values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;zero&#x27;</span> :
                    <span class="hljs-keyword">if</span> (oldVal.toFixed) delta[key] = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>TODO: zero String% (and em, etc) values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;add&#x27;</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;subtract&#x27;</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;multiply&#x27;</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;divide&#x27;</span> :
                    <span class="hljs-keyword">break</span>;
            }
        }
    })
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Invalidate mid-init functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.midInitActions = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Invalidating sensor functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanCollisionData = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>, []];
};
P.getSensors = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h4 id="display-cycle-functionality">Display cycle functionality</h4>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><code>prepareStamp</code> - function called as part of the Display cycle <code>compile</code> step.</p>
<ul>
<li>This function is called before we get into the entity stamp promise cascade (thus it’s a synchronous function). This is where we need to check whether we need to recalculate the path data which we’ll use later to build the Mesh entity’s output image.</li>
<li>We only need to recalculate the path data on the initial render, and afterwards when the <strong>dirtyPathData</strong> flag has been set.</li>
<li>If we perform the recalculation, then we need to make sure to set the <strong>dirtyOutput</strong> flag, which will trigger the output image build.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-built_in">this</span>.badNet = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">this</span>.dirtyParticles = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> {net, particlePositions} = <span class="hljs-built_in">this</span>;

    <span class="hljs-keyword">if</span> (net &amp;&amp; net.particleStore &amp;&amp; net.particleStore.length &gt; <span class="hljs-number">3</span>) {

        <span class="hljs-keyword">let</span> {rows, columns, particleStore} = net;

        <span class="hljs-keyword">if</span> (rows &amp;&amp; columns) {

            <span class="hljs-built_in">this</span>.badNet = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">this</span>.rows = rows;
            <span class="hljs-built_in">this</span>.columns = columns;

            <span class="hljs-keyword">if</span> (!particlePositions) particlePositions = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Sanity check</p>
<ul>
<li>We will recalculate stuff if any of the net particles have moved since the last check. This is most simply done by constructing a string of all current particle position values and comparing it to the previous string. If they are the same, then we can use the stashed image construct, otherwise we build and stash a new image construct</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">let</span> checkPositions = [];

            particleStore.forEach(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> {

                <span class="hljs-keyword">let</span> pos = p.position;
                <span class="hljs-keyword">let</span> {x, y} = pos;

                checkPositions.push([x, y]);
            });
            <span class="hljs-keyword">let</span> checkPositionsString = checkPositions.join(<span class="hljs-string">&#x27;,&#x27;</span>),
                particlePositionsString = particlePositions.join(<span class="hljs-string">&#x27;,&#x27;</span>);

            <span class="hljs-keyword">if</span> (particlePositionsString !== checkPositionsString) {

                <span class="hljs-built_in">this</span>.particlePositions = checkPositions;
                <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sourceIsVideoOrSprite) <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><code>setSourceDimension</code> - internal function called by <code>prepareStamp</code>.</p>
<ul>
<li>We make the source dimensions a square of the longest row ‘path’</li>
<li>This way, we can do a horizontal scan, or a vertical scan with no further calculation</li>
</ul>
<p>This function also:</p>
<ul>
<li>Calculates the bounding box</li>
<li>Creates the perimeter path object</li>
<li>Stores the (relative) lengths of individual struts in each row</li>
</ul>
<p>TODO: consider drawing order of squares - is there a way we can predict which squares are going to be behind other squares … </p>
<ul>
<li>For instance by adding together the particle z values for each square, then filling in the lowest square first? </li>
<li>May also be a way of calculating a cull of squares so that we don’t need to fill in squares entirely covered by other squares?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setSourceDimension = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.badNet) {

        <span class="hljs-keyword">const</span> {columns, rows, particlePositions} = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">const</span> results = [],
            lengths = [],
            xPos = [],
            yPos = [],
            top = [],
            left = [],
            right = [],
            coords = [],
            bottom = [];

        <span class="hljs-keyword">let</span> x, xz, y, res, pos, coord, x0, x1, y0, y1, dx, dy, len, l, i, iz, j, jz;

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; rows; y++) {

            res = <span class="hljs-number">0</span>;
            len = lengths[y] = [];
            coord = coords[y] = [];

            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>, xz = columns - <span class="hljs-number">1</span>; x &lt; xz; x++) {

                pos = (y * columns) + x; 

                [x0, y0] = particlePositions[pos];
                [x1, y1] = particlePositions[pos + <span class="hljs-number">1</span>];

                coord.push([x0, y0, x1, y1]);

                <span class="hljs-keyword">if</span> (x === <span class="hljs-number">0</span>) {

                    left.push([x0, y0]);
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x === xz - <span class="hljs-number">1</span>) {

                    right.push([x1, y1]);
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y === <span class="hljs-number">0</span>) {

                    top.push([x0, y0]);

                    <span class="hljs-keyword">if</span> (x === xz - <span class="hljs-number">2</span>) top.push([x1, y1]);
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y === rows - <span class="hljs-number">1</span>) {

                    bottom.push([x0, y0]);

                    <span class="hljs-keyword">if</span> (x === xz - <span class="hljs-number">2</span>) bottom.push([x1, y1]);
                }

                xPos.push(x0, x1);
                yPos.push(y0, y1);

                dx = x1 - x0;
                dy = y1 - y0;

                l = <span class="hljs-built_in">Math</span>.sqrt((dx * dx) + (dy * dy));
                res += l;
                len.push(l);
            }
            results.push(res);
        }
        <span class="hljs-built_in">this</span>.sourceDimension = <span class="hljs-built_in">Math</span>.max(...results);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Sanity check - the particle system, when it breaks down, can create some massive dimension values!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> host = <span class="hljs-built_in">this</span>.currentHost || <span class="hljs-built_in">this</span>.getHost();
        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-keyword">let</span> max = <span class="hljs-built_in">Math</span>.max(...host.currentDimensions);
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sourceDimension &gt; max) <span class="hljs-built_in">this</span>.sourceDimension = max;
        }

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = lengths.length; i &lt; iz; i++) {

            l = results[i];
            len = lengths[i];
            coord = coords[i];

            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = len.length; j &lt; jz; j++) {

                <span class="hljs-keyword">if</span> (l) len[j] = len[j] / l;

                coord[j].push(len[j]);
            }
        }

        <span class="hljs-built_in">this</span>.struts = coords;

        <span class="hljs-keyword">let</span> xMin = <span class="hljs-built_in">Math</span>.min(...xPos),
            yMin = <span class="hljs-built_in">Math</span>.min(...yPos),
            xMax = <span class="hljs-built_in">Math</span>.max(...xPos),
            yMax = <span class="hljs-built_in">Math</span>.max(...yPos);

        <span class="hljs-built_in">this</span>.boundingBox = [xMin, yMin, xMax - xMin, yMax - yMin];

        left.reverse();
        bottom.reverse();

        <span class="hljs-keyword">let</span> p = <span class="hljs-string">`M<span class="hljs-subst">${top[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]}</span>,<span class="hljs-subst">${top[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]}</span>L`</span>;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>, iz = top.length; i &lt; iz; i++) {

            [x, y] = top[i];
            p += <span class="hljs-string">`<span class="hljs-subst">${x}</span>,<span class="hljs-subst">${y}</span> `</span>;
        }
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = right.length; i &lt; iz; i++) {

            [x, y] = right[i];
            p += <span class="hljs-string">`<span class="hljs-subst">${x}</span>,<span class="hljs-subst">${y}</span> `</span>;
        }
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = bottom.length; i &lt; iz; i++) {

            [x, y] = bottom[i];
            p += <span class="hljs-string">`<span class="hljs-subst">${x}</span>,<span class="hljs-subst">${y}</span> `</span>;
        }
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = left.length; i &lt; iz; i++) {

            [x, y] = left[i];
            p += <span class="hljs-string">`<span class="hljs-subst">${x}</span>,<span class="hljs-subst">${y}</span> `</span>;
        }
        p += <span class="hljs-string">&#x27;z&#x27;</span>;

        <span class="hljs-built_in">this</span>.pathObject = <span class="hljs-keyword">new</span> Path2D(p);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><code>simpleStamp</code> - Simple stamping is entirely synchronous</p>
<ul>
<li>TODO: we may have to disable this functionality for the Mesh entity, if we use a web worker for either the prepareStamp calculations, or to build the output image itself</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.simpleStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">host, changes = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">&#x27;Cell&#x27;</span>) {

        <span class="hljs-built_in">this</span>.currentHost = host;
        
        <span class="hljs-keyword">if</span> (changes) {

            <span class="hljs-built_in">this</span>.set(changes);
            <span class="hljs-built_in">this</span>.prepareStamp();
        }

        <span class="hljs-built_in">this</span>.regularStampSynchronousActions();
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><code>stamp</code> - All entity stamping, except for simple stamps, goes through this function, which needs to return a Promise which will resolve in due course.</p>
<ul>
<li>While other entitys have to worry about applying filters as part of the stamping process, this is not an issue for Mesh entitys because filters are defined on, and applied to, the source Picture entity, not the Mesh itself</li>
</ul>
<p>Here we check which dirty flags need actioning, and call a range of different functions to process the work. These flags are:</p>
<ul>
<li><code>dirtyInput</code> - the Picture entity has reported a change in its source, or copy attributes)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">force = <span class="hljs-literal">false</span>, host, changes</span>) </span>{

    <span class="hljs-keyword">if</span> (force) {

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">&#x27;Cell&#x27;</span>) <span class="hljs-built_in">this</span>.currentHost = host;

        <span class="hljs-keyword">if</span> (changes) {

            <span class="hljs-built_in">this</span>.set(changes);
            <span class="hljs-built_in">this</span>.prepareStamp();
        }
        <span class="hljs-built_in">this</span>.regularStamp();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.visibility) {

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyInput) {

            <span class="hljs-built_in">this</span>.sourceImageData = <span class="hljs-built_in">this</span>.cleanInput();

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sourceImageData) <span class="hljs-built_in">this</span>.output = <span class="hljs-built_in">this</span>.cleanOutput();
            <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.output) <span class="hljs-built_in">this</span>.regularStamp();
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h4 id="clean-functions">Clean functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><code>cleanInput</code> - internal function called by <code>stamp</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanInput = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">false</span>;

    <span class="hljs-built_in">this</span>.setSourceDimension();

    <span class="hljs-keyword">let</span> sourceDimension = <span class="hljs-built_in">this</span>.sourceDimension;

    <span class="hljs-keyword">if</span> (!sourceDimension) {

        <span class="hljs-built_in">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">let</span> cell = requestCell(),
        engine = cell.engine,
        canvas = cell.element;

    canvas.width = sourceDimension;
    canvas.height = sourceDimension;
    engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-built_in">this</span>.source.stamp(<span class="hljs-literal">true</span>, cell, { 
        <span class="hljs-attr">startX</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">startY</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">handleX</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">handleY</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">offsetX</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">offsetY</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">roll</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,

        <span class="hljs-attr">width</span>: sourceDimension,
        <span class="hljs-attr">height</span>: sourceDimension,

        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;fill&#x27;</span>,
    })
    <span class="hljs-keyword">let</span> sourceImageData = engine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sourceDimension, sourceDimension);

    releaseCell(cell);
    <span class="hljs-keyword">return</span> sourceImageData;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><code>cleanOutput</code> - internal function called by <code>stamp</code></p>
<ul>
<li>If you’re not a fan of big functions, please look away now.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanOutput = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    
    <span class="hljs-keyword">const</span> halfPi = <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>;

    <span class="hljs-built_in">this</span>.dirtyOutput = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> {sourceDimension, sourceImageData, columns, rows, struts, boundingBox} = <span class="hljs-built_in">this</span>;

    sourceDimension = <span class="hljs-built_in">Math</span>.ceil(sourceDimension);

    <span class="hljs-keyword">if</span> (sourceImageData &amp;&amp; rows - <span class="hljs-number">1</span> &gt; <span class="hljs-number">0</span>) {

        <span class="hljs-keyword">let</span> [startX, startY, outputWidth, outputHeight] = boundingBox;

        outputWidth += startX;
        outputHeight += startY;

        <span class="hljs-keyword">const</span> inputCell = requestCell(),
            inputEngine = inputCell.engine,
            inputCanvas = inputCell.element;

        inputCanvas.width = sourceDimension;
        inputCanvas.height = sourceDimension;
        inputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        inputEngine.putImageData(sourceImageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">const</span> outputCell = requestCell(),
            outputEngine = outputCell.engine,
            outputCanvas = outputCell.element;

        outputCanvas.width = outputWidth;
        outputCanvas.height = outputHeight;
        outputEngine.globalAlpha = <span class="hljs-built_in">this</span>.state.globalAlpha;
        outputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">const</span> inputStrutHeight = <span class="hljs-built_in">parseFloat</span>((sourceDimension / (rows - <span class="hljs-number">1</span>)).toFixed(<span class="hljs-number">4</span>)),
            inputStrutWidth = <span class="hljs-built_in">parseFloat</span>((sourceDimension / (columns - <span class="hljs-number">1</span>)).toFixed(<span class="hljs-number">4</span>));

        <span class="hljs-keyword">let</span> topStruts, baseStruts,
            maxLen, tStep, bStep, iStep, xtStep, ytStep, xbStep, ybStep, tx, ty, bx, by, sx, sy,
            xLen, yLen, stripLength, stripAngle,
            c, cz, r, rz, i, iz;

        <span class="hljs-keyword">for</span> (r = <span class="hljs-number">0</span>, rz = rows - <span class="hljs-number">1</span>; r &lt; rz; r++) {

            topStruts = struts[r];
            baseStruts = struts[r + <span class="hljs-number">1</span>];

            <span class="hljs-keyword">for</span> (c = <span class="hljs-number">0</span>, cz = columns - <span class="hljs-number">1</span>; c &lt; cz; c++) {

                <span class="hljs-keyword">let</span> [ltx, lty, rtx, rty, tLen] = topStruts[c];
                <span class="hljs-keyword">let</span> [lbx, lby, rbx, rby, bLen] = baseStruts[c];

                tLen *= sourceDimension;
                bLen *= sourceDimension;

                maxLen = <span class="hljs-built_in">Math</span>.max(tLen, bLen, inputStrutWidth);

                tStep = tLen / maxLen;
                bStep = bLen / maxLen;
                iStep = inputStrutWidth / maxLen;

                xtStep = (rtx - ltx) / maxLen;
                ytStep = (rty - lty) / maxLen;
                xbStep = (rbx - lbx) / maxLen;
                ybStep = (rby - lby) / maxLen;

                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {

                    tx = ltx + (xtStep * i);
                    ty = lty + (ytStep * i);
                    bx = lbx + (xbStep * i);
                    by = lby + (ybStep * i);
                    sy = r * inputStrutHeight;
                    sx = (c * inputStrutWidth) + (iStep * i);

                    xLen = tx - bx;
                    yLen = ty - by;
                    stripLength = <span class="hljs-built_in">Math</span>.sqrt((xLen * xLen) + (yLen * yLen));
                    stripAngle = <span class="hljs-built_in">Math</span>.atan2(yLen, xLen) + halfPi;

                    outputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, tx, ty);
                    outputEngine.rotate(stripAngle);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Safari bugfix because we fall foul of of the Safari source-out-of-bounds bug</p>
<ul>
<li><a href="https://stackoverflow.com/questions/35500999/cropping-with-drawimage-not-working-in-safari">Stack Overflow question identifying the issue</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">let</span> testHeight = (sy + inputStrutHeight &gt; sourceDimension) ? sourceDimension - sy : inputStrutHeight;

                    outputEngine.drawImage(inputCanvas, sx, sy, <span class="hljs-number">1</span>, testHeight, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, stripLength);
                }
            }
        }

        <span class="hljs-keyword">let</span> iFactor = <span class="hljs-built_in">this</span>.interferenceFactor,
            iLoops = <span class="hljs-built_in">this</span>.interferenceLoops,

            iWidth = <span class="hljs-built_in">Math</span>.ceil(outputWidth * iFactor),
            iHeight = <span class="hljs-built_in">Math</span>.ceil(outputHeight * iFactor);

        inputCanvas.width = iWidth;
        inputCanvas.height = iHeight;

        outputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        inputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; iLoops; j++) {

            inputEngine.drawImage(outputCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, iWidth, iHeight);
            outputEngine.drawImage(inputCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, iWidth, iHeight, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight);
        }

        <span class="hljs-keyword">let</span> outputData = outputEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight);

        releaseCell(inputCell);
        releaseCell(outputCell);

        <span class="hljs-built_in">this</span>.dirtyTargetImage = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">return</span> outputData;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><code>regularStamp</code> - internal function called by <code>stamp</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.regularStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentHost) <span class="hljs-built_in">this</span>.regularStampSynchronousActions();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p><code>regularStampSynchronousActions</code> - internal function called by <code>regularStamp</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.regularStampSynchronousActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> dest = <span class="hljs-built_in">this</span>.currentHost;

    <span class="hljs-keyword">if</span> (dest) {

        <span class="hljs-keyword">let</span> engine = dest.engine;

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.noCanvasEngineUpdates) dest.setEngine(<span class="hljs-built_in">this</span>);

        <span class="hljs-built_in">this</span>[<span class="hljs-built_in">this</span>.method](engine);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h5 id="stamp-methods">Stamp methods</h5>
<p>These ‘method’ functions stamp the Mesh entity onto the canvas context supplied to them in the <code>engine</code> argument.</p>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><code>fill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.fill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doFill(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p><code>draw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.draw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doStroke(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><code>drawAndFill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.drawAndFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doStroke(engine);
    <span class="hljs-built_in">this</span>.currentHost.clearShadow();
    <span class="hljs-built_in">this</span>.doFill(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><code>fillAndDraw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.fillAndDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doFill(engine);
    <span class="hljs-built_in">this</span>.currentHost.clearShadow();
    <span class="hljs-built_in">this</span>.doStroke(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><code>drawThenFill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.drawThenFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doStroke(engine);
    <span class="hljs-built_in">this</span>.doFill(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><code>fillThenDraw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.fillThenDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-built_in">this</span>.doFill(engine);
    <span class="hljs-built_in">this</span>.doStroke(engine);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>clear</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.clear = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> output = <span class="hljs-built_in">this</span>.output,
        canvas = (<span class="hljs-built_in">this</span>.currentHost) ? <span class="hljs-built_in">this</span>.currentHost.element : <span class="hljs-literal">false</span>,
        gco = engine.globalCompositeOperation;

    <span class="hljs-keyword">if</span> (output &amp;&amp; canvas) {

        <span class="hljs-keyword">let</span> tempCell = requestCell(),
            tempEngine = tempCell.engine,
            tempCanvas = tempCell.element;

        <span class="hljs-keyword">let</span> w = canvas.width,
            h = canvas.height;

        tempCanvas.width = w;
        tempCanvas.height = h;

        tempEngine.putImageData(output, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.globalCompositeOperation = <span class="hljs-string">&#x27;destination-out&#x27;</span>;
        engine.drawImage(tempCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.globalCompositeOperation = gco;

        releaseCell(tempCell);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p><code>none</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.none = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>These <strong>stroke</strong> and <strong>fill</strong> functions handle most of the stuff that the method functions require to stamp the Mesh entity onto a canvas cell.</p>

            </div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><code>doStroke</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.doStroke = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    engine.stroke(<span class="hljs-built_in">this</span>.pathObject);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p><code>doFill</code></p>
<ul>
<li>Canvas API’s <code>putImageData</code> function turns transparent pixels in the output into transparent in the host canvas - which is not what we want</li>
<li>Problem solved by putting output into a pool cell, then drawing it from there to the host cell</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.doFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> output = <span class="hljs-built_in">this</span>.output,
        canvas = (<span class="hljs-built_in">this</span>.currentHost) ? <span class="hljs-built_in">this</span>.currentHost.element : <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (output &amp;&amp; canvas) {

        <span class="hljs-keyword">let</span> tempCell = requestCell(),
            tempEngine = tempCell.engine,
            tempCanvas = tempCell.element;

        <span class="hljs-keyword">let</span> w = canvas.width,
            h = canvas.height;

        tempCanvas.width = w;
        tempCanvas.height = h;

        tempEngine.putImageData(output, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.drawImage(tempCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        releaseCell(tempCell);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h4 id="collision-functionality">Collision functionality</h4>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p><code>checkHit</code></p>
<ul>
<li>Overwrites mixin/position.js function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.checkHit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = [], mycell</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.noUserInteraction) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.pathObject) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> tests = (!<span class="hljs-built_in">Array</span>.isArray(items)) ?  [items] : items,
        poolCellFlag = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!mycell) {

        mycell = requestCell();
        poolCellFlag = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">let</span> engine = mycell.engine,
        tx, ty;

    <span class="hljs-keyword">if</span> (tests.some(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(test)) {

            tx = test[<span class="hljs-number">0</span>];
            ty = test[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (xta(test, test.x, test.y)) {

            tx = test.x;
            ty = test.y;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!tx.toFixed || !ty.toFixed || <span class="hljs-built_in">isNaN</span>(tx) || <span class="hljs-built_in">isNaN</span>(ty)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> engine.isPointInPath(<span class="hljs-built_in">this</span>.pathObject, tx, ty, <span class="hljs-built_in">this</span>.winding);

    }, <span class="hljs-built_in">this</span>)) {

        <span class="hljs-keyword">let</span> r = {
            <span class="hljs-attr">x</span>: tx,
            <span class="hljs-attr">y</span>: ty,
            <span class="hljs-attr">artefact</span>: <span class="hljs-built_in">this</span>
        };

        <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);

        <span class="hljs-keyword">return</span> r;
    }
    
    <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h4 id="factory">Factory</h4>
<pre><code><span class="hljs-keyword">let</span> myMesh = scrawl.makeMesh({</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <pre><code>name: <span class="hljs-string">&#x27;display-mesh&#x27;</span>,</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <pre><code>net: <span class="hljs-string">&#x27;test-net&#x27;</span>,
<span class="hljs-attr">source</span>: <span class="hljs-string">&#x27;my-flower&#x27;</span>,</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <pre><code>lineWidth: <span class="hljs-number">2</span>,
<span class="hljs-attr">lineJoin</span>: <span class="hljs-string">&#x27;round&#x27;</span>,
<span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">&#x27;orange&#x27;</span>,</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <pre><code>method: <span class="hljs-string">&#x27;fillThenDraw&#x27;</span>,</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <pre><code>onEnter: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-built_in">this</span>.set({ <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">6</span> }) },
<span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-built_in">this</span>.set({ <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span> }) },</code></pre>
<p>});</p>
<pre><code></code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeMesh = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Mesh(items);
};

<span class="hljs-title">constructors</span>.<span class="hljs-title">Mesh</span> = <span class="hljs-title">Mesh</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <h4 id="exports">Exports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> {
    makeMesh,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
