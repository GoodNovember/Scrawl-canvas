<!DOCTYPE html>

<html>
<head>
  <title>DOM mixin</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="../factory/particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="../factory/particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="../factory/particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="../factory/particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="../worker/filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="dom-mixin">DOM mixin</h1>
<p>This mixin builds on the base and position mixins to give DOM elements (Scrawl-canvas <a href="../factory/stack.html">Stack</a>, <a href="../factory/canvas.html">Canvas</a> and <a href="../factory/element.html">Element</a> wrapper objects) the ability to act as <strong>artefacts</strong> in a Scrawl-canvas stack environment.</p>
<ul>
<li>Absolute and relative positioning and dimensioning</li>
<li>Positioning in the 3rd (z) dimension (absolute values only)</li>
<li>Use other artefacts as <code>pivot</code>, <code>mimic</code> and <code>path</code> objects</li>
<li>Allow other artefacts to use Element objects as their pivot or mimic object</li>
<li>Track the real (3D) positions of the DOM element’s corners, so that they can participate in collision detection functionality (for example, drag-and-drop)</li>
<li>Allow other artefacts to use Element object corners as their pivot reference</li>
<li>3D-rotation management - extending beyond <code>roll</code> (z) rotation to include <code>pitch</code> (x) and <code>yaw</code> (y) rotations</li>
<li>DOM element class and CSS management</li>
<li>Real-time localized mouse/pointer cursor coordinate tracking</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { <span class="hljs-title">constructors</span>, <span class="hljs-title">artefact</span> } <span class="hljs-title">from</span> &#x27;../<span class="hljs-title">core</span>/<span class="hljs-title">library</span>.<span class="hljs-title">js</span>&#x27;;
<span class="hljs-keyword">import</span> { mergeOver, pushUnique, removeItem, isa_obj, isa_dom, isa_quaternion, xt, xta, λ<span class="hljs-literal">null</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;
<span class="hljs-keyword">import</span> { uiSubscribedElements, currentCorePosition, applyCoreResizeListener } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/userInteraction.js&#x27;</span>;
<span class="hljs-keyword">import</span> { addDomShowElement, setDomShowRequired, domShow } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/document.js&#x27;</span>;

<span class="hljs-keyword">import</span> { makeQuaternion, requestQuaternion, releaseQuaternion } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/quaternion.js&#x27;</span>;

<span class="hljs-keyword">import</span> positionMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/position.js&#x27;</span>;
<span class="hljs-keyword">import</span> deltaMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./delta.js&#x27;</span>;
<span class="hljs-keyword">import</span> pivotMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./pivot.js&#x27;</span>;
<span class="hljs-keyword">import</span> mimicMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./mimic.js&#x27;</span>;
<span class="hljs-keyword">import</span> pathMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./path.js&#x27;</span>;
<span class="hljs-keyword">import</span> anchorMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/anchor.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="export-function">Export function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">P = {}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="mixins">Mixins</h4>
<ul>
<li><a href="../mixin/position.html">position</a></li>
<li><a href="../mixin/delta.html">delta</a></li>
<li><a href="../mixin/pivot.html">pivot</a></li>
<li><a href="../mixin/mimic.html">mimic</a></li>
<li><a href="../mixin/path.html">path</a></li>
<li><a href="../mixin/anchor.html">anchor</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P = positionMix(P);
    P = deltaMix(P);
    P = pivotMix(P);
    P = mimicMix(P);
    P = pathMix(P);
    P = anchorMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="shared-attributes">Shared attributes</h4>
<p>TODO: we need to test how various Javascript frameworks interact with Scrawl-canvas functionality in this area. In particular: <a href="https://vuejs.org/">vue.js</a>; <a href="https://reactjs.org/">React</a>; <a href="https://svelte.dev/">Svelte</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>domElement</strong> - Wrapper objects reference handle to its DOM element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        domElement: <span class="hljs-string">&#x27;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>pitch</strong>, <strong>yaw</strong> - rotation management in the <code>x</code> and <code>y</code> axes, to go with the <strong>roll</strong> attribute (for <code>z</code> axis rotation) defined in the position mixin. Like roll, values should be Numbers representing <strong><em>degrees</em></strong> (not radians)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pitch: <span class="hljs-number">0</span>,
        <span class="hljs-attr">yaw</span>: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>offsetZ</strong> - Number - unlike the X and Y offsets, offsetZ can only ever be a number as there is no 3d box (as such) to act as a length for relative N% strings (and ‘front’, ‘center’, ‘back’ strings would be equally nonsensical)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        offsetZ: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>css</strong> - a Javascript Object to hold key:value CSS values. Scrawl-canvas does not track any non-positioning-related CSS attributes; this attribute is a convenience function to allow developers to add CSS to the DOM element’s <code>style</code> attribute.</p>
<ul>
<li>Styles added to DOM elements using this object are applied directly to the element, thus having precedence over all other CSS declarations such as those included in a &lt;style&gt; tag in the document, or in a CSS style sheet file.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        css: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>classes</strong> - a String representation of the DOM element’s <code>classNode</code> attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        classes: <span class="hljs-string">&#x27;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>position</strong> - a String representation of the DOM element’s <code>position</code> attribute.</p>
<ul>
<li>by default all Scrawl-canvas Stack, Canvas and Element wrapper DOM elements are given a position value of <code>absolute</code></li>
<li>root Stack and Canvas wrappers have a position value of <code>relative</code> - this is to make sure their DOM elements remain in the document flow, thus attempting to minimize Scrawl-canvas’s impact on the wider environment</li>
<li>other possible values - except <code>static</code> - will be respected if they are explicitly set on the DOM elements prior to Scrawl-canvas initialization.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        position: <span class="hljs-string">&#x27;absolute&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>checkForResize</strong> - Boolean - automatically update stuff when the element changes its dimensions</p>
<ul>
<li>triggers as part of the <a href="../core/userInteraction.html">userInteraction</a> <code>updateUiSubscribedElement</code> functionality</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        checkForResize: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>trackHere</strong> - Boolean flag - when set, Scrawl-canvas will track mouse/touch cursor’s <em>local</em> position (relative to top-left corner) over the wrapper’s DOM element</p>
<ul>
<li>Stack and Canvas wrappers have this flag set to true, by default</li>
<li>Element wrappers default to false, as expected</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        trackHere: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>domAttributes</strong> - pseudo-attribute which is not retained by the wrapper object. See <code>updateDomAttributes</code> function below for details on how to use this functionality when creating or updating (via <code>set</code>), for example, Element objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    };
    P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">&#x27;domElement&#x27;</span>, <span class="hljs-string">&#x27;pathCorners&#x27;</span>, <span class="hljs-string">&#x27;rotation&#x27;</span>]);
    P.packetFunctions = pushUnique(P.packetFunctions, [<span class="hljs-string">&#x27;onEnter&#x27;</span>, <span class="hljs-string">&#x27;onLeave&#x27;</span>, <span class="hljs-string">&#x27;onDown&#x27;</span>, <span class="hljs-string">&#x27;onUp&#x27;</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>processDOMPacketOut</code> - internal helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.processDOMPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.processFactoryPacketOut(key, value, includes);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>processFactoryPacketOut</code> - internal helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.processFactoryPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span>(includes.indexOf(key) &lt; <span class="hljs-number">0</span> &amp;&amp; value === <span class="hljs-built_in">this</span>.defs[key]) result = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> result;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>finalizePacketOut</code> - internal helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

        <span class="hljs-keyword">if</span> (isa_dom(<span class="hljs-built_in">this</span>.domElement)) {

            <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">this</span>.domElement;

            <span class="hljs-keyword">let</span> mynode = el.cloneNode(<span class="hljs-literal">true</span>);

            <span class="hljs-keyword">let</span> kids = mynode.querySelectorAll(<span class="hljs-string">&#x27;[data-corner-div=&quot;sc&quot;]&#x27;</span>);
            kids.forEach(<span class="hljs-function"><span class="hljs-params">kid</span> =&gt;</span> mynode.removeChild(kid));

            copy.outerHTML = mynode.outerHTML;
            copy.host = el.parentElement.id;
        }

        copy = <span class="hljs-built_in">this</span>.handlePacketAnchor(copy, items);

        <span class="hljs-keyword">return</span> copy;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p><code>postCloneAction</code> - internal helper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.postCloneAction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clone, items</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onEnter) clone.onEnter = <span class="hljs-built_in">this</span>.onEnter;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onLeave) clone.onLeave = <span class="hljs-built_in">this</span>.onLeave;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onDown) clone.onDown = <span class="hljs-built_in">this</span>.onDown;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onUp) clone.onUp = <span class="hljs-built_in">this</span>.onUp;

        <span class="hljs-keyword">return</span> clone;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>
<p>No additional kill functionality required</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> S = P.setters,
        D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>trackHere</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.trackHere = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.trackHere = item;
        
        <span class="hljs-keyword">if</span> (item) pushUnique(uiSubscribedElements, <span class="hljs-built_in">this</span>.name);
        <span class="hljs-keyword">else</span> removeItem(uiSubscribedElements, <span class="hljs-built_in">this</span>.name);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>position</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.position = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.position = item;
        <span class="hljs-built_in">this</span>.dirtyPosition = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>visibility</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.visibility = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.visibility = item;
        <span class="hljs-built_in">this</span>.dirtyVisibility = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><code>offsetZ</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.offsetZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.offsetZ = item;
        <span class="hljs-built_in">this</span>.dirtyOffsetZ = <span class="hljs-literal">true</span>;
    };

    D.offsetZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.offsetZ += item;
        <span class="hljs-built_in">this</span>.dirtyOffsetZ = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><code>roll</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.roll = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.roll = <span class="hljs-built_in">this</span>.checkRotationAngle(item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };
    D.roll = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.roll = <span class="hljs-built_in">this</span>.checkRotationAngle(<span class="hljs-built_in">this</span>.roll + item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><code>pitch</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.pitch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.pitch = <span class="hljs-built_in">this</span>.checkRotationAngle(item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };
    D.pitch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.pitch = <span class="hljs-built_in">this</span>.checkRotationAngle(<span class="hljs-built_in">this</span>.pitch + item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>yaw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.yaw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.yaw = <span class="hljs-built_in">this</span>.checkRotationAngle(item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };
    D.yaw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.yaw = <span class="hljs-built_in">this</span>.checkRotationAngle(<span class="hljs-built_in">this</span>.yaw + item);
        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>css</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.css = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.css = (<span class="hljs-built_in">this</span>.css) ? mergeOver(<span class="hljs-built_in">this</span>.css, item) : item;

        <span class="hljs-built_in">this</span>.dirtyCss = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><code>classes</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.classes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.classes = item;

        <span class="hljs-built_in">this</span>.dirtyClasses = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><code>domAttributes</code> - see <code>updateDomAttributes</code> below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.domAttributes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.updateDomAttributes(item);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><code>checkRotationAngle</code> - internal function - a quick check for rotational (<code>roll</code>, <code>pitch</code>, <code>yaw</code>) setter/deltaSetter functionality. Attempts to keep values of these attributes between -360 and + 360</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.checkRotationAngle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">angle</span>) </span>{

        <span class="hljs-keyword">if</span> (angle &lt; -<span class="hljs-number">180</span> || angle &gt; <span class="hljs-number">180</span>) {
            angle += (angle &gt; <span class="hljs-number">0</span>) ? -<span class="hljs-number">360</span> : <span class="hljs-number">360</span>;
        }

        <span class="hljs-keyword">return</span> angle;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><code>updateDomAttributes</code> - DOM wrapper objects do not keep track of their DOM element attribute values; this function is a convenience function to make updating those attributes a bit easier. Function arguments can be one of:</p>
<ul>
<li><code>(attribute-String, value)</code></li>
<li><code>({attribute-String: value, attribute-String: value, etc})</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.updateDomAttributes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items, value</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.domElement) {

            <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">this</span>.domElement;

            <span class="hljs-keyword">if</span> (items.substring &amp;&amp; xt(value)) {

                <span class="hljs-keyword">if</span> (value) el.setAttribute(items, value);
                <span class="hljs-keyword">else</span> el.removeAttribute(items);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isa_obj(items)) {

                <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[item, val]</span>) =&gt;</span> {

                    <span class="hljs-keyword">if</span> (val) el.setAttribute(item, val);
                    <span class="hljs-keyword">else</span> el.removeAttribute(item);
                });
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>initializeDomLayout</code> - internal function </p>
<ul>
<li>Used by factory constructors to help wrap DOM elements in a Stack, Canvas or Element wrapper</li>
<li>TODO - there’s a lot of improvements we can do here - the aim should be to create the wrapper object and update the objects DOM element’s style and dimensions attributes - specifically shifting <code>position</code> from “static” to “absolute” - in a way that does not disturb the page view in any way whatsoever (pixel-perfect!) so website visitors are completely unaware that the work has taken place</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.initializeDomLayout = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

        <span class="hljs-keyword">let</span> el = items.domElement,
            elStyle = el.style;

        elStyle.boxSizing = <span class="hljs-string">&#x27;border-box&#x27;</span>;

        <span class="hljs-keyword">if</span> (el &amp;&amp; items.setInitialDimensions) {

            <span class="hljs-keyword">let</span> dims = el.getBoundingClientRect(),
                trans = el.style.transform,
                transOrigin = el.style.transformOrigin,
                host = <span class="hljs-literal">false</span>,
                hostDims;

            <span class="hljs-keyword">if</span> (items &amp;&amp; items.host) {

                host = items.host;

                <span class="hljs-keyword">if</span> (host.substring &amp;&amp; artefact[host]) host = artefact[host];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO - discover scale</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>discover dimensions (width, height)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">this</span>.currentDimensions[<span class="hljs-number">0</span>] = dims.width;
            <span class="hljs-built_in">this</span>.currentDimensions[<span class="hljs-number">1</span>] = dims.height;
            items.width = dims.width;
            items.height = dims.height;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>recover classes already assigned to the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (el.className) items.classes = el.className;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>go with lock defaults - no work required</p>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>discover start (boundingClientRect - will be the difference between this object and its host (parent) object ‘top’ and ‘left’ values)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (host &amp;&amp; host.domElement) {

                hostDims = host.domElement.getBoundingClientRect();

                <span class="hljs-keyword">if</span> (hostDims) {

                    items.startX = dims.left - hostDims.left;
                    items.startY = dims.top - hostDims.top;
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO go with offset defaults - though may be worthwhile checking if the translate style has been set?</p>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>TODO discover handle (transform, transformOrigin)</p>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>TODO go with rotation (pitch, yaw, roll) defaults - no further work required?</p>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>for Stack artefacts only, discover perspective and perspective-origin values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.type === <span class="hljs-string">&#x27;Stack&#x27;</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>TODO - currently assumes all lengths supplied are in px - need a way to calculate non-px values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!xt(items.perspective) &amp;&amp; !xt(items.perspectiveZ)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>TODO - this isn’t working! </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    items.perspectiveZ = (xt(elStyle.perspective) &amp;&amp; elStyle.perspective) ? <span class="hljs-built_in">parseFloat</span>(elStyle.perspective) : <span class="hljs-number">0</span>;
                }

                <span class="hljs-keyword">let</span> perspectiveOrigin = elStyle.perspectiveOrigin;

                <span class="hljs-keyword">if</span> (perspectiveOrigin.length) {

                    perspectiveOrigin = perspectiveOrigin.split(<span class="hljs-string">&#x27; &#x27;</span>);

                    <span class="hljs-keyword">if</span> (perspectiveOrigin.length &gt; <span class="hljs-number">0</span> &amp;&amp; !xt(items.perspective) &amp;&amp; !xt(items.perspectiveX)) items.perspectiveX = perspectiveOrigin[<span class="hljs-number">0</span>];

                    <span class="hljs-keyword">if</span> (!xt(items.perspective) &amp;&amp; !xt(items.perspectiveY)) {

                        <span class="hljs-keyword">if</span> (perspectiveOrigin.length &gt; <span class="hljs-number">1</span>) items.perspectiveY = perspectiveOrigin[<span class="hljs-number">1</span>];
                        <span class="hljs-keyword">else</span> items.perspectiveY = perspectiveOrigin[<span class="hljs-number">0</span>];
                    }
                }
            }
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h5 id="dom-element-class-attribute-management">DOM element class attribute management</h5>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><code>addClasses</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.addClasses = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item.substring) {

            <span class="hljs-keyword">let</span> classes = <span class="hljs-built_in">this</span>.classes;

            classes += <span class="hljs-string">` <span class="hljs-subst">${item}</span>`</span>;
            classes = classes.trim();
            classes = classes.replace(<span class="hljs-regexp">/[\s\uFEFF\xA0]+/g</span>, <span class="hljs-string">&#x27; &#x27;</span>);

            <span class="hljs-keyword">if</span> (classes !== <span class="hljs-built_in">this</span>.classes) {

                <span class="hljs-built_in">this</span>.classes = classes;
                <span class="hljs-built_in">this</span>.dirtyClasses = <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><code>removeClasses</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.removeClasses = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item.substring) {

            <span class="hljs-keyword">let</span> classes = <span class="hljs-built_in">this</span>.classes,
                targets = item.split(),
                search;

            targets.forEach(<span class="hljs-function"><span class="hljs-params">cls</span> =&gt;</span> {

                search = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">&#x27; ?&#x27;</span> + cls + <span class="hljs-string">&#x27; ?&#x27;</span>);
                classes = classes.replace(search, <span class="hljs-string">&#x27; &#x27;</span>);
                classes = classes.trim();
                classes = classes.replace(<span class="hljs-regexp">/[\s\uFEFF\xA0]+/g</span>, <span class="hljs-string">&#x27; &#x27;</span>);
            });

            <span class="hljs-keyword">if</span> (classes !== <span class="hljs-built_in">this</span>.classes) {

                <span class="hljs-built_in">this</span>.classes = classes;
                <span class="hljs-built_in">this</span>.dirtyClasses = <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h5 id="dom-element-corners-management">DOM element corners management</h5>
<p>Scrawl-canvas keeps track of its DOM wrapper element’s positions by creating four zero-dimension &lt;div&gt; elements and adding them as absolutely positioned children to the element. We can then get these children to report on their real coordinates (even when the parent is 3D rotated) by calling <code>getClientRects</code> on them.</p>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><code>addPathCorners</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.addPathCorners = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.domElement &amp;&amp; !<span class="hljs-built_in">this</span>.noUserInteraction) {

            <span class="hljs-keyword">let</span> pointMaker = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);

                p.style.width = <span class="hljs-number">0</span>;
                p.style.height = <span class="hljs-number">0</span>;
                p.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;

                <span class="hljs-keyword">return</span> p;
            };

            <span class="hljs-keyword">let</span> tl = pointMaker(),
                tr = pointMaker(),
                br = pointMaker(),
                bl = pointMaker();

            tl.style.top = <span class="hljs-string">&#x27;0%&#x27;</span>;
            tl.style.left = <span class="hljs-string">&#x27;0%&#x27;</span>;
            tl.setAttribute(<span class="hljs-string">&#x27;data-corner-div&#x27;</span>, <span class="hljs-string">&#x27;sc&#x27;</span>);

            tr.style.top = <span class="hljs-string">&#x27;0%&#x27;</span>;
            tr.style.left = <span class="hljs-string">&#x27;100%&#x27;</span>;
            tr.setAttribute(<span class="hljs-string">&#x27;data-corner-div&#x27;</span>, <span class="hljs-string">&#x27;sc&#x27;</span>);

            br.style.top = <span class="hljs-string">&#x27;100%&#x27;</span>;
            br.style.left = <span class="hljs-string">&#x27;100%&#x27;</span>;
            br.setAttribute(<span class="hljs-string">&#x27;data-corner-div&#x27;</span>, <span class="hljs-string">&#x27;sc&#x27;</span>);

            bl.style.top = <span class="hljs-string">&#x27;100%&#x27;</span>;
            bl.style.left = <span class="hljs-string">&#x27;0%&#x27;</span>;
            bl.setAttribute(<span class="hljs-string">&#x27;data-corner-div&#x27;</span>, <span class="hljs-string">&#x27;sc&#x27;</span>);

            <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">this</span>.domElement;

            el.appendChild(tl);
            el.appendChild(tr);
            el.appendChild(br);
            el.appendChild(bl);

            <span class="hljs-built_in">this</span>.pathCorners.push(tl);
            <span class="hljs-built_in">this</span>.pathCorners.push(tr);
            <span class="hljs-built_in">this</span>.pathCorners.push(br);
            <span class="hljs-built_in">this</span>.pathCorners.push(bl);

            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.currentCornersData) <span class="hljs-built_in">this</span>.currentCornersData = [];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><code>checkCornerPositions</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.checkCornerPositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">corner</span>) </span>{

        <span class="hljs-keyword">let</span> pathCorners = <span class="hljs-built_in">this</span>.pathCorners;

        <span class="hljs-keyword">if</span> (pathCorners.length === <span class="hljs-number">4</span>) {

            <span class="hljs-keyword">let</span> here = <span class="hljs-built_in">this</span>.getHere(),
                x = currentCorePosition.scrollX - (here.offsetX || <span class="hljs-number">0</span>),
                y = currentCorePosition.scrollY - (here.offsetY || <span class="hljs-number">0</span>),
                round = <span class="hljs-built_in">Math</span>.round,
                results = [],
                client;

            <span class="hljs-keyword">const</span> cornerPush = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>{

                <span class="hljs-keyword">let</span> coord = c[<span class="hljs-number">0</span>];

                <span class="hljs-keyword">if</span> (coord) {

                    results.push(round(coord.left + x));
                    results.push(round(coord.top + y));
                }
                <span class="hljs-keyword">else</span> results.push(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            };

            <span class="hljs-keyword">switch</span> (corner) {

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;topLeft&#x27;</span> :

                    client = pathCorners[<span class="hljs-number">0</span>].getClientRects();
                    cornerPush(client);
                    <span class="hljs-keyword">return</span> results;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;topRight&#x27;</span> :

                    client = pathCorners[<span class="hljs-number">1</span>].getClientRects();
                    cornerPush(client);
                    <span class="hljs-keyword">return</span> results;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;bottomRight&#x27;</span> :

                    client = pathCorners[<span class="hljs-number">2</span>].getClientRects();
                    cornerPush(client);
                    <span class="hljs-keyword">return</span> results;

                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;bottomLeft&#x27;</span> :

                    client = pathCorners[<span class="hljs-number">3</span>].getClientRects();
                    cornerPush(client);
                    <span class="hljs-keyword">return</span> results;

                <span class="hljs-keyword">default</span> :

                    pathCorners.forEach(<span class="hljs-function"><span class="hljs-params">point</span> =&gt;</span> {

                        <span class="hljs-keyword">if</span> (isa_dom(point)) {

                            client = point.getClientRects();
                            cornerPush(client);
                        }
                    });
                    <span class="hljs-keyword">return</span> results;
            }
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><code>getCornerCoordinate</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> cornerCoordinateLabels = [<span class="hljs-string">&#x27;topLeft&#x27;</span>, <span class="hljs-string">&#x27;topRight&#x27;</span>, <span class="hljs-string">&#x27;bottomRight&#x27;</span>, <span class="hljs-string">&#x27;bottomLeft&#x27;</span>];
    P.getCornerCoordinate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">corner</span>) </span>{

        <span class="hljs-keyword">if</span> (cornerCoordinateLabels.indexOf(corner) &gt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.checkCornerPositions(corner);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> [].concat(<span class="hljs-built_in">this</span>.currentStampPosition);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h5 id="collision-detection">Collision detection</h5>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>cleanPathObject</code></p>
<ul>
<li>Scrawl-canvas uses the DOM wrapper element’s child &lt;div&gt; elements’ position coordinates to build a <code>Path2D object</code> (which will be some form of trapezium). </li>
<li>We can now perform collision detection in the same way as we do for Canvas-based entity objects using <code>CanvasRenderingContext2D.isPointInPath</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanPathObject = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-built_in">this</span>.dirtyPathObject = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.domElement &amp;&amp; !<span class="hljs-built_in">this</span>.noUserInteraction) {

            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.pathCorners.length) <span class="hljs-built_in">this</span>.addPathCorners();

            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.currentCornersData) <span class="hljs-built_in">this</span>.currentCornersData = [];

            <span class="hljs-keyword">let</span> cornerData = <span class="hljs-built_in">this</span>.currentCornersData;
            cornerData.length = <span class="hljs-number">0</span>;
            cornerData.push(...this.checkCornerPositions());

            <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">this</span>.pathObject = <span class="hljs-keyword">new</span> Path2D();
            p.moveTo(cornerData[<span class="hljs-number">0</span>], cornerData[<span class="hljs-number">1</span>]);
            p.lineTo(cornerData[<span class="hljs-number">2</span>], cornerData[<span class="hljs-number">3</span>]);
            p.lineTo(cornerData[<span class="hljs-number">4</span>], cornerData[<span class="hljs-number">5</span>]);
            p.lineTo(cornerData[<span class="hljs-number">6</span>], cornerData[<span class="hljs-number">7</span>]);
            p.closePath();
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><code>checkHit</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.checkHit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = [], mycell</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.noUserInteraction) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.pathObject || <span class="hljs-built_in">this</span>.dirtyPathObject) <span class="hljs-built_in">this</span>.cleanPathObject();

        <span class="hljs-keyword">let</span> tests = (!<span class="hljs-built_in">Array</span>.isArray(items)) ?  [items] : items,
            poolCellFlag = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!mycell) {

            mycell = requestCell();
            poolCellFlag = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">let</span> engine = mycell.engine,
            stamp = <span class="hljs-built_in">this</span>.currentStampPosition,
            x = stamp[<span class="hljs-number">0</span>],
            y = stamp[<span class="hljs-number">1</span>],
            tx, ty;

        <span class="hljs-keyword">if</span> (tests.some(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(test)) {

                tx = test[<span class="hljs-number">0</span>];
                ty = test[<span class="hljs-number">1</span>];
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (xta(test, test.x, test.y)) {

                tx = test.x;
                ty = test.y;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (!tx.toFixed || !ty.toFixed || <span class="hljs-built_in">isNaN</span>(tx) || <span class="hljs-built_in">isNaN</span>(ty)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">return</span> engine.isPointInPath(<span class="hljs-built_in">this</span>.pathObject, tx, ty);

        }, <span class="hljs-built_in">this</span>)) {

            <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">x</span>: tx,
                <span class="hljs-attr">y</span>: ty,
                <span class="hljs-attr">artefact</span>: <span class="hljs-built_in">this</span>,
            };
        }
        
        <span class="hljs-keyword">if</span> (poolCellFlag) releaseCell(mycell);
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h5 id="display-cycle-functionality">Display cycle functionality</h5>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><code>cleanRotation</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanRotation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-built_in">this</span>.dirtyRotation = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.rotation || !isa_quaternion(<span class="hljs-built_in">this</span>.rotation)) <span class="hljs-built_in">this</span>.rotation = makeQuaternion();

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.currentRotation || !isa_quaternion(<span class="hljs-built_in">this</span>.rotation)) <span class="hljs-built_in">this</span>.currentRotation = makeQuaternion();

        <span class="hljs-keyword">let</span> calculatedRotation = <span class="hljs-built_in">this</span>.rotation;

        calculatedRotation.setFromEuler({
            <span class="hljs-attr">pitch</span>: <span class="hljs-built_in">this</span>.pitch || <span class="hljs-number">0</span>,
            <span class="hljs-attr">yaw</span>: <span class="hljs-built_in">this</span>.yaw || <span class="hljs-number">0</span>,
            <span class="hljs-attr">roll</span>: <span class="hljs-built_in">this</span>.roll || <span class="hljs-number">0</span>,
        });

        <span class="hljs-keyword">if</span> (calculatedRotation.getMagnitude() !== <span class="hljs-number">1</span>) calculatedRotation.normalize();

        <span class="hljs-keyword">let</span> processedRotation = requestQuaternion(),
            path = <span class="hljs-built_in">this</span>.path,
            mimic = <span class="hljs-built_in">this</span>.mimic,
            pivot = <span class="hljs-built_in">this</span>.pivot,
            lock = <span class="hljs-built_in">this</span>.lockTo;

        <span class="hljs-keyword">if</span> (path &amp;&amp; lock.indexOf(<span class="hljs-string">&#x27;path&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {

            processedRotation.set(calculatedRotation);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>TODO check to see if path roll needs to be added</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mimic &amp;&amp; <span class="hljs-built_in">this</span>.useMimicRotation &amp;&amp; lock.indexOf(<span class="hljs-string">&#x27;mimic&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">if</span> (xt(mimic.currentRotation)) {

                processedRotation.set(mimic.currentRotation);
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.addOwnRotationToMimic) processedRotation.quaternionRotate(calculatedRotation);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.dirtyMimicRotation = <span class="hljs-literal">true</span>;
        } 
        <span class="hljs-keyword">else</span> {

            processedRotation.set(calculatedRotation);

            <span class="hljs-keyword">if</span> (pivot &amp;&amp; <span class="hljs-built_in">this</span>.addPivotRotation &amp;&amp; lock.indexOf(<span class="hljs-string">&#x27;pivot&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {

                <span class="hljs-keyword">if</span> (xt(pivot.currentRotation)) processedRotation.quaternionRotate(pivot.currentRotation);
                <span class="hljs-keyword">else</span> <span class="hljs-built_in">this</span>.dirtyPivotRotation = <span class="hljs-literal">true</span>;
            }
        }

        <span class="hljs-built_in">this</span>.currentRotation.set(processedRotation);

        releaseQuaternion(processedRotation);

        <span class="hljs-built_in">this</span>.dirtyPositionSubscribers = <span class="hljs-literal">true</span>;
        
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.mimicked &amp;&amp; <span class="hljs-built_in">this</span>.mimicked.length) <span class="hljs-built_in">this</span>.dirtyMimicRotation = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><code>cleanOffsetZ</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanOffsetZ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>nothing to do here - function only exists in case we need to do stuff in future Scrawl-canvas version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">this</span>.dirtyOffsetZ = <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>cleanContent</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanContent = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-built_in">this</span>.dirtyContent = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> el = <span class="hljs-built_in">this</span>.domElement;

        <span class="hljs-keyword">if</span> (el) <span class="hljs-built_in">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p><code>cleanDisplayShape</code> - overwritten in Stack and Canvas artefacts via the displayShape mixin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanDisplayShape = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p><code>cleanDisplayArea</code> - overwritten in Stack and Canvas artefacts via the displayShape mixin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanDisplayArea = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><code>prepareStamp</code> - check all the dirty flags and call the appropriate <code>clean</code> functions if they are set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyScale || <span class="hljs-built_in">this</span>.dirtyDimensions || <span class="hljs-built_in">this</span>.dirtyStart || <span class="hljs-built_in">this</span>.dirtyOffset || <span class="hljs-built_in">this</span>.dirtyHandle || <span class="hljs-built_in">this</span>.dirtyRotation) <span class="hljs-built_in">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyContent) <span class="hljs-built_in">this</span>.cleanContent();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyScale) <span class="hljs-built_in">this</span>.cleanScale();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyDimensions) <span class="hljs-built_in">this</span>.cleanDimensions();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyDisplayArea) <span class="hljs-built_in">this</span>.cleanDisplayArea();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyDisplayShape) <span class="hljs-built_in">this</span>.cleanDisplayShape();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyLock) <span class="hljs-built_in">this</span>.cleanLock();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStart) <span class="hljs-built_in">this</span>.cleanStart();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyOffset) <span class="hljs-built_in">this</span>.cleanOffset();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyOffsetZ) <span class="hljs-built_in">this</span>.cleanOffsetZ();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyHandle) <span class="hljs-built_in">this</span>.cleanHandle();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyRotation) <span class="hljs-built_in">this</span>.cleanRotation();

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isBeingDragged || <span class="hljs-built_in">this</span>.lockTo.indexOf(<span class="hljs-string">&#x27;mouse&#x27;</span>) &gt;= <span class="hljs-number">0</span> || <span class="hljs-built_in">this</span>.lockTo.indexOf(<span class="hljs-string">&#x27;particle&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-built_in">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;
            <span class="hljs-built_in">this</span>.dirtyStampHandlePositions = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.pivoted.length) <span class="hljs-built_in">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStampPositions) <span class="hljs-built_in">this</span>.cleanStampPositions();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStampHandlePositions) <span class="hljs-built_in">this</span>.cleanStampHandlePositions();

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyPathObject) <span class="hljs-built_in">this</span>.cleanPathObject();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p><code>stamp</code> - builds a set of Strings which can then be applied to the DOM wrapper’s element’s <code>style</code> attribute.</p>
<ul>
<li>The functionality for performing the update is defined in the <a href="../core/document.html">document</a> module’s <code>domShow</code> function, which will be called for each DOM-based artefact during the ‘show’ stage of the Display cycle</li>
<li>Function returns a promise</li>
</ul>
<p>Only DOM elements whose attribute values have changed will be updated - as made clear by setting the appropriate dirty flags. Affected style attributes are: </p>
<ul>
<li><code>perspectiveOrigin</code> and <code>perspective</code> - Stack wrappers only</li>
<li><code>position</code> (relative vs absolute, not position within a Stack)</li>
<li><code>width</code> and <code>height</code> - for dimensions</li>
<li><code>transformOrigin</code> - relating to wrapper <code>handle</code> values</li>
<li><code>transform</code> - for positioning and rotation within a Stack element</li>
<li><code>display</code> - for visibility</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> self = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>do not process if the DOM element is missing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!self.domElement) reject(<span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>calculate transform strings on each iteration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> [stampX, stampY] = self.currentStampPosition,
                [handleX, handleY] = self.currentStampHandlePosition,
                scale = self.currentScale;

            <span class="hljs-keyword">let</span> rotation = self.currentRotation,
                v, vx, vy, vz, angle;

            <span class="hljs-keyword">let</span> nTransformOrigin = <span class="hljs-string">`<span class="hljs-subst">${handleX}</span>px <span class="hljs-subst">${handleY}</span>px 0`</span>,
                nTransform = <span class="hljs-string">`translate(<span class="hljs-subst">${stampX - handleX}</span>px,<span class="hljs-subst">${stampY - handleY}</span>px)`</span>;

            <span class="hljs-keyword">if</span> (self.yaw || self.pitch || self.roll || (self.pivot &amp;&amp; self.addPivotRotation) || (self.mimic &amp;&amp; self.useMimicRotation) || (self.path &amp;&amp; self.addPathRotation)) {

                v = rotation.v;
                vx = v.x;
                vy = v.y;
                vz = v.z;
                angle = rotation.getAngle(<span class="hljs-literal">false</span>);

                nTransform += <span class="hljs-string">` rotate3d(<span class="hljs-subst">${vx}</span>,<span class="hljs-subst">${vy}</span>,<span class="hljs-subst">${vz}</span>,<span class="hljs-subst">${angle}</span>rad)`</span>;
            }

            <span class="hljs-keyword">if</span> (self.offsetZ) nTransform += <span class="hljs-string">` translateZ(<span class="hljs-subst">${self.offsetZ}</span>px)`</span>;

            <span class="hljs-keyword">if</span> (scale !== <span class="hljs-number">1</span>) nTransform += <span class="hljs-string">` scale(<span class="hljs-subst">${scale}</span>,<span class="hljs-subst">${scale}</span>)`</span>;

            <span class="hljs-keyword">if</span> (nTransform !== self.currentTransformString) {

                self.currentTransformString = nTransform;
                self.dirtyTransform = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span> (nTransformOrigin !== self.currentTransformOriginString) {

                self.currentTransformOriginString = nTransformOrigin;
                self.dirtyTransformOrigin = <span class="hljs-literal">true</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>determine whether there is a need to trigger a redraw of the DOM element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (self.dirtyTransform || self.dirtyPerspective || self.dirtyPosition || self.dirtyDomDimensions || self.dirtyTransformOrigin || self.dirtyVisibility || self.dirtyCss || self.dirtyClasses || self.domShowRequired) {

                addDomShowElement(self.name);
                setDomShowRequired(<span class="hljs-literal">true</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>update artefacts subscribed to this artefact (using it as their pivot or mimic source), if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (self.dirtyPositionSubscribers) self.updatePositionSubscribers();</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>if this artefact’s pivot or mimic source was playing up, reset appropriate dirty flags so we can try and fix on next iteration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(self.dirtyMimicRotation || self.dirtyPivotRotation) {

                self.dirtyMimicRotation = <span class="hljs-literal">false</span>;
                self.dirtyPivotRotation = <span class="hljs-literal">false</span>;
                self.dirtyRotation = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span>(self.dirtyMimicScale) {

                self.dirtyMimicScale = <span class="hljs-literal">false</span>;
                self.dirtyScale = <span class="hljs-literal">true</span>;
            }

            resolve(<span class="hljs-literal">true</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p><code>apply</code></p>
<ul>
<li>I really don’t like this functionality - see if we can purge it from the code base?</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.apply = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        applyCoreResizeListener();

        <span class="hljs-built_in">this</span>.prepareStamp();

        <span class="hljs-keyword">let</span> self = <span class="hljs-built_in">this</span>;

        <span class="hljs-built_in">this</span>.stamp()
        .then(<span class="hljs-function">() =&gt;</span> {

            domShow(self.name);
            self.dirtyPathObject = <span class="hljs-literal">true</span>;
            self.cleanPathObject();
        })
        .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(err));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Return the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> P;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
