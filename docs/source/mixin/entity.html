<!DOCTYPE html>

<html>
<head>
  <title>Entity mixin</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/events.html">
                  ./source/core/events.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/bezier.html">
                  ./source/factory/bezier.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/emitter.html">
                  ./source/factory/emitter.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/line.html">
                  ./source/factory/line.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/net.html">
                  ./source/factory/net.js
                </a>
              
                
                <a class="source" href="../factory/oval.html">
                  ./source/factory/oval.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/particle.html">
                  ./source/factory/particle.js
                </a>
              
                
                <a class="source" href="../factory/particleForce.html">
                  ./source/factory/particleForce.js
                </a>
              
                
                <a class="source" href="../factory/particleHistory.html">
                  ./source/factory/particleHistory.js
                </a>
              
                
                <a class="source" href="../factory/particleSpring.html">
                  ./source/factory/particleSpring.js
                </a>
              
                
                <a class="source" href="../factory/particleWorld.html">
                  ./source/factory/particleWorld.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/polygon.html">
                  ./source/factory/polygon.js
                </a>
              
                
                <a class="source" href="../factory/polyline.html">
                  ./source/factory/polyline.js
                </a>
              
                
                <a class="source" href="../factory/quadratic.html">
                  ./source/factory/quadratic.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/rectangle.html">
                  ./source/factory/rectangle.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spiral.html">
                  ./source/factory/spiral.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/star.html">
                  ./source/factory/star.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/tetragon.html">
                  ./source/factory/tetragon.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tracer.html">
                  ./source/factory/tracer.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="delta.html">
                  ./source/mixin/delta.js
                </a>
              
                
                <a class="source" href="displayShape.html">
                  ./source/mixin/displayShape.js
                </a>
              
                
                <a class="source" href="dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="mimic.html">
                  ./source/mixin/mimic.js
                </a>
              
                
                <a class="source" href="path.html">
                  ./source/mixin/path.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/mixin/pattern.js
                </a>
              
                
                <a class="source" href="pivot.html">
                  ./source/mixin/pivot.js
                </a>
              
                
                <a class="source" href="position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="shapeBasic.html">
                  ./source/mixin/shapeBasic.js
                </a>
              
                
                <a class="source" href="shapeCurve.html">
                  ./source/mixin/shapeCurve.js
                </a>
              
                
                <a class="source" href="shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter-stringed.html">
                  ./source/worker/filter-stringed.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
                
                <a class="source" href="../worker/filter_canvas.html">
                  ./source/worker/filter_canvas.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="entity-mixin">Entity mixin</h1>
<p>This mixin builds on the base and position mixins to give Canvas entity objects (Scrawl-canvas <a href="../factory/block.html">Block</a>, <a href="../factory/grid.html">Grid</a>, <a href="../factory/loom.html">Loom</a>, <a href="../factory/phrase.html">Phrase</a>, <a href="../factory/picture.html">Picture</a>, <a href="../factory/shape.html">Shape</a>, <a href="../factory/wheel.html">Wheel</a>) the ability to act as <strong>artefacts</strong>.</p>
<p>Entitys differ from non-entity artefacts in that they are restricted to Cell wrappers (though no harm should come if they are included in Stack-related Groups).</p>
<ul>
<li>The entity object represents a set of instructions for rendering graphical lines and shapes onto a &lt;canvas&gt; CanvasRenderingContext2D engine, using the Canvas API to do this</li>
<li>The engine requirements for the render - <code>fillStyle</code>, <code>font</code>, <code>globalAlpha</code>, <code>globalCompositeOperation</code>, <code>lineCap</code>, <code>lineDash</code>, <code>lineDashOffset</code>, <code>lineJoin</code>, <code>lineWidth</code>, <code>miterLimit</code>, <code>shadowBlur</code>, <code>shadowColor</code>, <code>shadowOffsetX</code>, <code>shadowOffsetY</code>, <code>strokeStyle</code>, <code>textAlign</code>, <code>textBaseline</code> - are kept in a separate <a href="../factory.state.html">State object</a>. Note that these attributes are initialized/updated directly on the entity object</li>
<li>Entitys can act as hotspots within a &lt;canvas&gt; display; we can create hover and click effects for them</li>
</ul>
<p>Entitys are, nevertheless, full artefact objects which can interact with other artefacts and the mouse/touch cursor in all the normal ways: positioning (<code>pivot</code> and <code>path</code>) and dimensioning (<code>mimic</code>) functionality; collision detection (including <strong>drag-and-drop</strong>); etc</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { λ<span class="hljs-literal">null</span>, mergeOver, pushUnique, xt, addStrings, isa_obj } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/utilities.js&#x27;</span>;
<span class="hljs-keyword">import</span> { currentGroup, scrawlCanvasHold } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../core/document.js&#x27;</span>;

<span class="hljs-keyword">import</span> { makeState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/state.js&#x27;</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/cell.js&#x27;</span>;
<span class="hljs-keyword">import</span> { requestFilterWorker, releaseFilterWorker, actionFilterWorker } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/filter.js&#x27;</span>;
<span class="hljs-keyword">import</span> { importDomImage } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../factory/imageAsset.js&#x27;</span>;

<span class="hljs-keyword">import</span> positionMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/position.js&#x27;</span>;
<span class="hljs-keyword">import</span> deltaMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/delta.js&#x27;</span>;
<span class="hljs-keyword">import</span> pivotMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/pivot.js&#x27;</span>;
<span class="hljs-keyword">import</span> mimicMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/mimic.js&#x27;</span>;
<span class="hljs-keyword">import</span> pathMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/path.js&#x27;</span>;
<span class="hljs-keyword">import</span> anchorMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/anchor.js&#x27;</span>;
<span class="hljs-keyword">import</span> filterMix <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixin/filter.js&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="export-function">Export function</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">P = {}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="mixins">Mixins</h4>
<ul>
<li><a href="../mixin/position.html">position</a></li>
<li><a href="../mixin/delta.html">delta</a></li>
<li><a href="../mixin/pivot.html">pivot</a></li>
<li><a href="../mixin/mimic.html">mimic</a></li>
<li><a href="../mixin/path.html">path</a></li>
<li><a href="../mixin/anchor.html">anchor</a></li>
<li><a href="../mixin/filter.html">filter</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P = positionMix(P);
    P = deltaMix(P);
    P = pivotMix(P);
    P = mimicMix(P);
    P = pathMix(P);
    P = anchorMix(P);
    P = filterMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="shared-attributes">Shared attributes</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>method</strong> - String value which tells the entity <em>how</em> it will display itself on the canvas. Available options are:</p>
<ul>
<li><code>draw</code> - stroke the entity outline with the entity’s <code>strokeStyle</code> color, gradient or pattern - including shadow</li>
<li><code>fill</code> - fill the entity with the entity’s <code>fillStyle</code> color, gradient or pattern - including shadow</li>
<li><code>drawAndFill</code> - stroke the entity’s outline, remove shadow, then fill it</li>
<li><code>fillAndDraw</code> - fill the entity’s outline, remove shadow, then stroke it</li>
<li><code>drawThenFill</code> - stroke the entity’s outline, then fill it (shadow applied twice)</li>
<li><code>fillThenDraw</code> - fill the entity’s outline, then stroke it (shadow applied twice)</li>
<li><code>clear</code> - remove everything that would have been covered if the entity had performed fill (including shadow)</li>
<li><code>none</code> - perform all the calculations required, but don’t perform the final stamping</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        method: <span class="hljs-string">&#x27;fill&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>pathObject</strong> - Scrawl-canvas holds details of every type of entity’s outline in a <code>Path2D</code> object - used both for draw/fill operations, and for collision detection work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pathObject: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>winding</strong> - String with value <code>evenodd</code> or <code>nonzero</code> (default)</p>
<ul>
<li>Canvas fill (flood) drawing operations can take into account an entity’s winding choice. Two are available: the <a href="https://en.wikipedia.org/wiki/Nonzero-rule">non-zero rule</a>; and the <a href="https://en.wikipedia.org/wiki/Even%E2%80%93odd_rule">even-odd rule</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        winding: <span class="hljs-string">&#x27;nonzero&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>flipReverse</strong>, <strong>flipUpend</strong> - Boolean flags which determine the orientation of the entity when it stamps itself on the display. </p>
<ul>
<li>a <code>reversed</code> entity is effectively flipped 180&deg; around a vertical line passing through that entity’s rotation-reflection (start) point - a face looking to the right will now look to the left</li>
<li>an <code>upended</code> entity is effectively flipped 180&deg; around a horizontal line passing through that entity’s rotation-reflection (start) point - a normal face will now appear upside-down</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        flipReverse: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">flipUpend</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>scaleOutline</strong> - Boolean flag. When set, the entity will increase its <code>lineWidth</code> proportionat to the entity’s <code>scale</code> value - an entity of scale = 2 will display lines twice the thickness of the same entity at scale = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scaleOutline: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>lockFillStyleToEntity</strong>, <strong>lockStrokeStyleToEntity</strong> - Boolean flags. </p>
<ul>
<li>When set, these flags instruct any gradient-type style (Scrawl-canvas Gradient, RadialGradient) to map their <code>start</code> and <code>end</code> coordinates to the entity’s dimensions</li>
<li>Default action is for gradient-type styles to map their coordinates to the host Cell’s dimensions</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lockFillStyleToEntity: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">lockStrokeStyleToEntity</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h5 id="event-listener-functions">Event listener functions</h5>
<p>Entity objects have the ability to act as ‘hotspots’ within a canvas display, reacting to mouse/pointer movements over the canvas. Four mouse-like events are supported:</p>
<ul>
<li><code>enter</code> - triggers when the cursor passes over the entity’s outline into its fillable area</li>
<li><code>down</code> - triggers when a user presses their (left) mouse key while inside the entity’s fillable area</li>
<li><code>up</code> - triggers when a user releases their (left) mouse key while inside the entity’s fillable area - this can also be used for capturing mouse click and touch tap actions</li>
<li><code>leave</code> - triggers when the cursor passes over the entity’s outline away from its fillable area</li>
</ul>
<p>The events are regular functions. </p>
<ul>
<li><code>this</code> refers to the entity object, giving the functions access to any attribute and method set on it. </li>
<li>They can also use variables defined elsewhere in the script code (though these will need to be rehydrated if the entity is packet stored and resurrected - see Demo <a href="../../demo/canvas-009.html">Canvas-009</a> tests for an example of doing this)</li>
</ul>
<p>Scrawl-canvas will not automatically trigger these functions: </p>
<ul>
<li>They can be triggered as part of an Animation object’s function checking for hits on a Group of entitys</li>
<li>Similar checks can be included in a RenderAnimation hook function</li>
<li>Alternatively we can set up an event listener on the DOM &lt;canvas&gt; element, which invokes a call to cascade a mouse/touch <code>move</code> event down to its associated entitys - in this case the entitys will check the event themselves and trigger the appropriate function</li>
</ul>
<p>The functions defined in these attributes will be included in entity <code>packet</code> functionality, and can be safely cloned</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>onEnter</strong> - define tasks to be performed for <code>enter</code> events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onEnter: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>onLeave</strong> - define tasks to be performed for <code>leave</code> events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onLeave: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>onDown</strong> - define tasks to be performed for <code>down</code> events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onDown: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>onUp</strong> - define tasks to be performed for <code>up</code> events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onUp: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h5 id="state-object-attributes">State object attributes</h5>
<p>We can treat the following attributes as if they are entity object attributes, though in fact they are stored and managed by <strong>State objects</strong></p>
<p><strong>fillStyle</strong> and <strong>strokeStyle</strong> - color, gradient or pattern used to outline or fill a entity. Can be:</p>
<ul>
<li>CSS format color String - <code>#fff</code>, <code>#ffffff</code>, <code>rgb(255,255,255)</code>, <code>rgba(255,255,255,1)</code>, <code>white</code>, etc</li>
<li>COLORNAME String</li>
<li>GRADIENTNAME String</li>
<li>RADIALGRADIENTNAME String</li>
<li>PATTERNNAME String</li>
</ul>
<p><strong>globalAlpha</strong> - entity transparency - a value between 0 and 1, where 0 is completely transparent and 1 is completely opaque</p>
<p><strong>globalCompositeOperation</strong> - compositing method for applying the entity to an existing Cell (&lt;canvas&gt;) display. Permitted values include</p>
<ul>
<li>‘source-over’</li>
<li>‘source-atop’</li>
<li>‘source-in’</li>
<li>‘source-out’</li>
<li>‘destination-over’</li>
<li>‘destination-atop’</li>
<li>‘destination-in’</li>
<li>‘destination-out’</li>
<li>‘lighter’</li>
<li>‘darker’</li>
<li>‘copy’</li>
<li>‘xor’</li>
<li>any other permitted value - be aware that different browsers may render these operations in different ways, and some options are not supported by all browsers.</li>
</ul>
<p><strong>lineWidth</strong> - Number (in pixels)</p>
<p><strong>lineCap</strong> - how the ends of lines will display. Permitted values include:</p>
<ul>
<li>‘butt’</li>
<li>‘round’</li>
<li>‘square’</li>
</ul>
<p><strong>lineJoin</strong> - how line joints will display. Permitted values include:</p>
<ul>
<li>‘miter’</li>
<li>‘round’</li>
<li>‘bevel’</li>
</ul>
<p><strong>lineDash</strong> - an array of integer Numbers representing line and gap values (in pixels), for example [5,2,2,2] for a long-short dash pattern</p>
<p><strong>lineDashOffset</strong> - distance along the entity’s outline at which to start the line dash. Changing this value can be used to create a ‘marching ants effect</p>
<p><strong>miterLimit</strong> - affecting the ‘pointiness’ of the line join where two lines join at an acute angle</p>
<p><strong>shadowOffsetX</strong>, <strong>shadowOffsetY</strong> - horizontal and vertical offsets for a entity’s shadow, in Number pixels</p>
<p><strong>shadowBlur</strong> - the blur width for a entity’s shadow, in Number pixels</p>
<p><strong>shadowColor</strong> - the color used for an entity’s shadow effect. Can be:</p>
<ul>
<li>CSS format color String - <code>#fff</code>, <code>#ffffff</code>, <code>rgb(255,255,255)</code>, <code>rgba(255,255,255,1)</code>, <code>white</code>, etc</li>
<li>COLORNAME String</li>
</ul>
<p><strong>font</strong>, <strong>textAlign</strong>, <strong>textBaseline</strong> - the Canvas API standards for using fonts on a canvas are near-useless, and often lead to a sub-par display of text. The Scrawl-canvas Phrase entity uses the following attributes internally, but has its own set of attributes for defining the font styling used by its text.</p>
<p><strong>filter</strong> - the Canvas 2D engine supports the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/filter">filter attribute</a> on an experimental basis, thus it is not guaranteed to work in all browsers and devices. The filter attribute takes a String value (default: ‘none’) defining one or more filter functions to be applied to the entity as it is stamped on the canvas.</p>
<ul>
<li>Be aware that entitys can also take a <code>filters</code> Array - this represents an array of Scrawl-canvas filters to be applied to the entity (or group or Cell). The two filter systems are completely separate - combine their effects at your own risk!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    };
    P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">&#x27;state&#x27;</span>]);
    P.packetFunctions = pushUnique(P.packetFunctions, [<span class="hljs-string">&#x27;onEnter&#x27;</span>, <span class="hljs-string">&#x27;onLeave&#x27;</span>, <span class="hljs-string">&#x27;onDown&#x27;</span>, <span class="hljs-string">&#x27;onUp&#x27;</span>]);

    P.processEntityPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.processFactoryPacketOut(key, value, includes);
    };

    P.processFactoryPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span>(includes.indexOf(key) &lt; <span class="hljs-number">0</span> &amp;&amp; value === <span class="hljs-built_in">this</span>.defs[key]) result = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> result;
    };

    P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

        <span class="hljs-keyword">let</span> stateCopy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">this</span>.state.saveAsPacket(items))[<span class="hljs-number">3</span>];
        copy = mergeOver(copy, stateCopy);

        copy = <span class="hljs-built_in">this</span>.handlePacketAnchor(copy, items);

        <span class="hljs-keyword">return</span> copy;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.postCloneAction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clone, items</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onEnter) clone.onEnter = <span class="hljs-built_in">this</span>.onEnter;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onLeave) clone.onLeave = <span class="hljs-built_in">this</span>.onLeave;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onDown) clone.onDown = <span class="hljs-built_in">this</span>.onDown;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.onUp) clone.onUp = <span class="hljs-built_in">this</span>.onUp;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Shared state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (items.sharedState) clone.state = <span class="hljs-built_in">this</span>.state;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Cloned anchors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (items.anchor) {

            items.anchor.host = clone;

            <span class="hljs-keyword">if</span> (!xt(items.anchor.focusAction)) items.anchor.focusAction = <span class="hljs-built_in">this</span>.anchor.focusAction;
            <span class="hljs-keyword">if</span> (!xt(items.anchor.blurAction)) items.anchor.blurAction = <span class="hljs-built_in">this</span>.anchor.blurAction;

            clone.buildAnchor(items.anchor);

            <span class="hljs-keyword">if</span> (!items.anchor.clickAction) clone.anchor.clickAction = <span class="hljs-built_in">this</span>.anchor.clickAction;
        }

        <span class="hljs-keyword">return</span> clone;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>
<p>No additional kill functionality defined here</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> G = P.getters,
        S = P.setters,
        D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>group</strong> - returns the entity’s latest Group’s String name, not the Group object itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.group) ? <span class="hljs-built_in">this</span>.group.name : <span class="hljs-string">&#x27;&#x27;</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong>lockStylesToEntity</strong> - a pseudo-attribute which will set the <code>lockFillStyleToEntity</code> and <code>lockStrokeStyleToEntity</code> flags to the same Boolean value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.lockStylesToEntity = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-built_in">this</span>.lockFillStyleToEntity = item;
        <span class="hljs-built_in">this</span>.lockStrokeStyleToEntity = item;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Entity <code>get</code>, <code>set</code> and <code>deltaSet</code> functions need to take into account the entity State object, whose attributes can be retrieved/amended directly on the entity object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">let</span> getter = <span class="hljs-built_in">this</span>.getters[item];

        <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.call(<span class="hljs-built_in">this</span>);

        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">let</span> def = <span class="hljs-built_in">this</span>.defs[item],
                state = <span class="hljs-built_in">this</span>.state,
                val;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">&#x27;undefined&#x27;</span>) {

                val = <span class="hljs-built_in">this</span>[item];
                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">&#x27;undefined&#x27;</span>) ? val : def;
            }

            def = state.defs[item];

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">&#x27;undefined&#x27;</span>) {

                val = state[item];
                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">&#x27;undefined&#x27;</span>) ? val : def;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    };

    P.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-built_in">this</span>.setters,
                defs = <span class="hljs-built_in">this</span>.defs,
                state = <span class="hljs-built_in">this</span>.state,
                stateSetters = (state) ? state.setters : {},
                stateDefs = (state) ? state.defs : {},
                predefined, stateFlag;

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">&#x27;name&#x27;</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    predefined = setters[key];
                    stateFlag = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">if</span> (!predefined) {

                        predefined = stateSetters[key];
                        stateFlag = <span class="hljs-literal">true</span>;
                    }

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-built_in">this</span>.state : <span class="hljs-built_in">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) <span class="hljs-built_in">this</span>[key] = value;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) state[key] = value;
                }
            }, <span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };

    P.setDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(items).length) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-built_in">this</span>.deltaSetters,
                defs = <span class="hljs-built_in">this</span>.defs,
                state = <span class="hljs-built_in">this</span>.state,
                stateSetters = (state) ? state.deltaSetters : {},
                stateDefs = (state) ? state.defs : {},
                predefined, stateFlag;

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">&#x27;name&#x27;</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    predefined = setters[key];
                    stateFlag = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">if</span> (!predefined) {

                        predefined = stateSetters[key];
                        stateFlag = <span class="hljs-literal">true</span>;
                    }

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-built_in">this</span>.state : <span class="hljs-built_in">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) <span class="hljs-built_in">this</span>[key] = addStrings(<span class="hljs-built_in">this</span>[key], value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) state[key] = addStrings(state[key], value);
                }
            }, <span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>entityInit</code> - internal function, called by all entity factory constructors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.entityInit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-built_in">this</span>.makeName(items.name);
        <span class="hljs-built_in">this</span>.register();
        <span class="hljs-built_in">this</span>.initializePositions();

        <span class="hljs-built_in">this</span>.set(<span class="hljs-built_in">this</span>.defs);

        <span class="hljs-built_in">this</span>.state = makeState();

        <span class="hljs-keyword">if</span> (!items.group) items.group = currentGroup;

        <span class="hljs-built_in">this</span>.onEnter = λ<span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.onLeave = λ<span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.onDown = λ<span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.onUp = λ<span class="hljs-literal">null</span>;

        <span class="hljs-built_in">this</span>.set(items);

        <span class="hljs-built_in">this</span>.midInitActions(items);

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.purge) <span class="hljs-built_in">this</span>.purgeArtefact(<span class="hljs-built_in">this</span>.purge);
    };

    P.midInitActions = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h4 id="display-cycle-functionality">Display cycle functionality</h4>
<p>Entitys - as artefacts - take part in the Display cycle at the <code>compile</code> stage, when Cell wrappers trigger a compile action cascade through their associated Group objects to entity objects included in those groups.</p>
<p>The main entity compile-related functions are:</p>
<ul>
<li><strong>prepareStamp</strong> - a synchronous function called at the start of the compile step where an entity will check its dirty flags and update position, dimensions and other attributes accordingly.</li>
<li><strong>stamp</strong> - a function that returns a Promise - this is where the main drawing activity happens. This function calls one of two other functions: <strong>filteredStamp</strong>; or <strong>regularStamp</strong> (both returning Promises) which in turn rely on the <strong>regularStampSynchronousActions</strong> function where all the drawing magic happens.</li>
</ul>
<p>The stamp functionality can be triggered outside of the Display cycle, if required - for instance when compiling a Cell display setup as a static background layer, which excludes itself from the Display cycle cascade’s <code>clear</code> and <code>compile</code> steps.</p>
<ul>
<li>Invoking <code>entity.stamp</code> is an asynchronous call returning a Promise which needs to be handled accordingly - in particular for error management.</li>
<li>Alternatively, the <strong>simpleStamp</strong> function will make the entity perform a synchronous action (no Promise returned); the function ignores any filter requirements set on the entity.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h5 id="step-1-prepare-the-entity-for-stamping">Step 1: prepare the entity for stamping</h5>
<p><code>prepareStamp</code> - all entity objects need to check the following dirty flags and take corrective action when a flag is set. </p>
<ul>
<li>The order in which flags get checked is important! </li>
<li>As part of the checking process, additional dirty flags may be set early in the function, for processing later on in the function.</li>
</ul>
<p>If an entity relies on another artefact as a <code>pivot</code>, <code>mimic</code> or <code>path</code> reference, those artefacts should be processed earlier in the compile cascade. This can be achieved by:</p>
<ul>
<li>Placing the reference artefacts in a different Group, whose <strong>order</strong> attribute has been set to a lower value than this entity’s Group’s order value</li>
<li>If both entity and reference artefact are in the same Group, give this entity an order value higher than its reference.</li>
<li>If both entity and the reference artefact are in the same Group, and have the same order value, then make sure that the reference artefact is defined in code before the entity.</li>
</ul>
<p>Note that some entity factories need to overwrite this function to meet their particular requirements. Many of the <em>clean functions</em> mentioned below are defined in the <a href="./position.html">position mixin</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><code>dirtyHost</code> - set by a Cell wrapper on the entitys associated with it (via the Cell’s associated Group objects) whenever the Cell’s dimensions change. The entity sets its own <code>dirtyDimensions</code> flag as a result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyHost) {

            <span class="hljs-built_in">this</span>.dirtyHost = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>A number of updates (<strong>scale</strong>, <strong>dimensions</strong>, <strong>start</strong>, <strong>offset</strong>, <strong>handle</strong>) require the entity to recalculate its Path2D object - if any of them are set, then the entity sets its own <code>dirtyPathObject</code> flag as a result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyScale || <span class="hljs-built_in">this</span>.dirtyDimensions || <span class="hljs-built_in">this</span>.dirtyStart || <span class="hljs-built_in">this</span>.dirtyOffset || <span class="hljs-built_in">this</span>.dirtyHandle) <span class="hljs-built_in">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><code>dirtyScale</code> - triggers <strong>cleanScale</strong> function - which in turn sets the <code>dirtyDimensions</code>, <code>dirtyHandle</code> and (if required) <code>dirtyPositionSubscribers</code>, <code>dirtyMimicScale</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyScale) <span class="hljs-built_in">this</span>.cleanScale();</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><code>dirtyDimensions</code> - triggers <strong>cleanDimensions</strong> function - which in turn sets the <code>dirtyStart</code>, <code>dirtyHandle</code>, <code>dirtyOffset</code> and (if required) <code>dirtyPositionSubscribers</code>, <code>dirtyMimicDimensions</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyDimensions) <span class="hljs-built_in">this</span>.cleanDimensions();</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>dirtyLock</code> - triggers <strong>cleanLock</strong> function - which in turn sets the <code>dirtyStart</code> and <code>dirtyHandle</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyLock) <span class="hljs-built_in">this</span>.cleanLock();</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><code>dirtyStart</code> - triggers <strong>cleanStart</strong> function - which in turn sets the <code>dirtyStampPositions</code> flag on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStart) <span class="hljs-built_in">this</span>.cleanStart();</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><code>dirtyOffset</code> - triggers <strong>cleanOffset</strong> function - which in turn sets the <code>dirtyStampPositions</code> and (if required) <code>dirtyMimicOffset</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyOffset) <span class="hljs-built_in">this</span>.cleanOffset();</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><code>dirtyHandle</code> - triggers <strong>cleanHandle</strong> function - which in turn sets the <code>dirtyStampHandlePositions</code> and (if required) <code>dirtyMimicHandle</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyHandle) <span class="hljs-built_in">this</span>.cleanHandle();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><code>dirtyRotation</code> - triggers <strong>cleanRotation</strong> function - which in turn sets (if required) <code>dirtyMimicRotation</code>, <code>dirtyPivotRotation</code>, <code>dirtyPositionSubscribers</code> flags on the entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyRotation) <span class="hljs-built_in">this</span>.cleanRotation();</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>To handle situations where the entity position is currently under the influence of the mouse/touch cursor - where true, entity will set its own <code>dirtyStampPositions</code>, <code>dirtyStampHandlePositions</code> flags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isBeingDragged || <span class="hljs-built_in">this</span>.lockTo.indexOf(<span class="hljs-string">&#x27;mouse&#x27;</span>) &gt;= <span class="hljs-number">0</span> || <span class="hljs-built_in">this</span>.lockTo.indexOf(<span class="hljs-string">&#x27;particle&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-built_in">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;
            <span class="hljs-built_in">this</span>.dirtyStampHandlePositions = <span class="hljs-literal">true</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Invoke the <strong>cleanStampPositions</strong> and <strong>cleanStampHandlePositions</strong> functions, if needed, to update current positional data prior to the stamping operation. Both functions will set the <code>dirtyPositionSubscribers</code> flag if changes to positional values result from the calculations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStampPositions) <span class="hljs-built_in">this</span>.cleanStampPositions();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyStampHandlePositions) <span class="hljs-built_in">this</span>.cleanStampHandlePositions();</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>If the entity’s Path2D object has been marked as dirty by the <code>dirtyPathObject</code> flag, rebuild it by invoking the <strong>cleanPathObject</strong> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyPathObject) <span class="hljs-built_in">this</span>.cleanPathObject();</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><code>dirtyPositionSubscribers</code> - update any artefacts subscribed to this entity as their <code>pivot</code> or <code>mimic</code> source, if required, by invoking the <strong>updatePositionSubscribers</strong> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyPositionSubscribers) <span class="hljs-built_in">this</span>.updatePositionSubscribers();</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>The <code>dirtyFilters</code> flag is checked and handled by the <strong>filteredStamp</strong> function.</p>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><code>dirtyAnchorHold</code> - if the entity has an Anchor object, and any updates have been made to its data, it needs to be rebuilt by invoking the <strong>buildAnchor</strong> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.anchor &amp;&amp; <span class="hljs-built_in">this</span>.dirtyAnchorHold) {

            <span class="hljs-built_in">this</span>.dirtyAnchorHold = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">this</span>.buildAnchor(<span class="hljs-built_in">this</span>.anchor);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><code>cleanPathObject</code> - <strong><em>this function will be overwritten by every entity Factory</em></strong>, to meet their individual requirements.</p>
<ul>
<li>The function needs to build a Canvas API <a href="https://developer.mozilla.org/en-US/docs/Web/API/Path2D">Path2D</a> object and store it in the <strong>pathObject</strong> attribute. The Path2D object is used for both entity stamping (see below) and entity collision detection work.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanPathObject = λ<span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h5 id="step-2-invoke-the-entitys-stamp-action">Step 2: invoke the entity’s stamp action</h5>
<p><code>stamp</code> - returns a Promise. This is the function invoked by Group objects as they cascade the Display cycle <strong>compile</strong> step through to their member artefacts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">force = <span class="hljs-literal">false</span>, host, changes</span>) </span>{

        <span class="hljs-keyword">let</span> filterTest = (!<span class="hljs-built_in">this</span>.noFilters &amp;&amp; <span class="hljs-built_in">this</span>.filters &amp;&amp; <span class="hljs-built_in">this</span>.filters.length) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (force) {

            <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">&#x27;Cell&#x27;</span>) <span class="hljs-built_in">this</span>.currentHost = host;

            <span class="hljs-keyword">if</span> (changes) {

                <span class="hljs-built_in">this</span>.set(changes);
                <span class="hljs-built_in">this</span>.prepareStamp();
            }

            <span class="hljs-keyword">if</span> (filterTest) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.filteredStamp();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.regularStamp();
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.visibility) {

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.stashOutput || filterTest) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.filteredStamp();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.regularStamp();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;entity.stamp&#x27;</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><code>regularStamp</code> - handles stamping functionality for all entitys that do not have any filter functions associated with them - returns a Promise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.regularStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> self = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (self.currentHost) {

                self.regularStampSynchronousActions();
                resolve(<span class="hljs-string">&#x27;entity.regularStamp resolving&#x27;</span>);
            }
            reject(<span class="hljs-string">&#x27;entity.regularStamp - no currentHost&#x27;</span>);
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><code>filteredStamp</code> - handles stamping functionality for all <strong>entitys that have filter functions</strong> associated with them - returns a Promise.</p>
<ul>
<li>Filters require the use of the <a href="../worker/filter.html">Filter web worker</a> which returns its results asynchronously.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.filteredStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Clean and sort the Entity-level filters before sending them to the filter worker for application</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.dirtyFilters || !<span class="hljs-built_in">this</span>.currentFilters) <span class="hljs-built_in">this</span>.cleanFilters();

        <span class="hljs-keyword">let</span> self = <span class="hljs-built_in">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>An internal cleanup function to release resources and restore the non-filter defaults to what they were before. It’s also in the cleanup phase that we (finally) copy over the results of the filter over to the current canvas display, taking into account the entity’s composite and alpha values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">if</span> (worker) releaseFilterWorker(worker);

                currentEngine.save();
                
                currentEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                currentEngine.drawImage(filterElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>This is also the point at which we action any requests to stash the Cell output and (optionally) create/update imageAsset objects and associated &lt;img&gt; elements for use elsewhere in the Scrawl-canvas ecosystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (self.stashOutput) {

                    self.stashOutput = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">let</span> [stashX, stashY, stashWidth, stashHeight] = self.getCellCoverage(filterEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, filterElement.width, filterElement.height));

                    self.stashedImageData = filterEngine.getImageData(stashX, stashY, stashWidth, stashHeight);

                    <span class="hljs-keyword">if</span> (self.stashOutputAsAsset) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>KNOWN ISSUE - it takes time for the images to load the new dataURLs generated from canvas elements. See demo <a href="../../demo/canvas-020.html">Canvas-020</a> for a workaround.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        self.stashOutputAsAsset = <span class="hljs-literal">false</span>;

                        filterElement.width = stashWidth;
                        filterElement.height = stashHeight;
                        filterEngine.putImageData(self.stashedImageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                        <span class="hljs-keyword">if</span> (!self.stashedImage) {

                            <span class="hljs-keyword">let</span> newimg = self.stashedImage = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&#x27;img&#x27;</span>);

                            newimg.id = <span class="hljs-string">`<span class="hljs-subst">${self.name}</span>-image`</span>;

                            newimg.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                                scrawlCanvasHold.appendChild(newimg);
                                importDomImage(<span class="hljs-string">`#<span class="hljs-subst">${newimg.id}</span>`</span>);
                            };

                            newimg.src = filterElement.toDataURL();
                        }
                        <span class="hljs-keyword">else</span> self.stashedImage.src = filterElement.toDataURL();
                    }
                }
        
                releaseCell(filterHost);

                currentEngine.restore();

                self.currentHost = currentHost;
                self.noCanvasEngineUpdates = oldNoCanvasEngineUpdates;
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Save current host data into a set of vars, ready for restoration after web worker completes or fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> currentHost = self.currentHost,
                currentElement = currentHost.element,
                currentEngine = currentHost.engine,
                currentDimensions = currentHost.currentDimensions;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Get and prepare a pool Cell for the filter operations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> filterHost = requestCell(),
                filterElement = filterHost.element,
                filterEngine = filterHost.engine;

            self.currentHost = filterHost;
            
            <span class="hljs-keyword">let</span> w = filterElement.width = currentDimensions[<span class="hljs-number">0</span>] || currentElement.width,
                h = filterElement.height = currentDimensions[<span class="hljs-number">1</span>] || currentElement.height;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Switch off fast stamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> oldNoCanvasEngineUpdates = self.noCanvasEngineUpdates;
            self.noCanvasEngineUpdates = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Stamp the entity onto the pool Cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.regularStampSynchronousActions();

            <span class="hljs-keyword">let</span> worker, myimage;

            <span class="hljs-keyword">if</span> (!self.noFilters &amp;&amp; self.filters &amp;&amp; self.filters.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>If we’re using the entity as a stencil, copy the entity cell’s current display over the entity in the pool Cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (self.isStencil) {

                    filterEngine.save();
                    filterEngine.globalCompositeOperation = <span class="hljs-string">&#x27;source-in&#x27;</span>;
                    filterEngine.globalAlpha = <span class="hljs-number">1</span>;
                    filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                    filterEngine.drawImage(currentElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                    filterEngine.restore();
                } 

                filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                myimage = filterEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h);
                worker = requestFilterWorker();</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Pass control over to the web worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                actionFilterWorker(worker, {
                    <span class="hljs-attr">image</span>: myimage,
                    <span class="hljs-attr">filters</span>: self.currentFilters
                })
                .then(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Handle the web worker response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (img) {

                        filterEngine.globalCompositeOperation = <span class="hljs-string">&#x27;source-over&#x27;</span>;
                        filterEngine.globalAlpha = <span class="hljs-number">1</span>;
                        filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                        filterEngine.putImageData(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                        cleanup();
                        resolve(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;image issue&#x27;</span>);
                })
                .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {

                    cleanup();
                    reject(err);
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Where no filter is required, but we still want to stash the results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                cleanup();
                resolve(<span class="hljs-literal">true</span>);
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>getCellCoverage</code> - internal helper function - calculates the box start and dimensions values for the entity on its current Cell host, to help minimize work required when applying filters to the entity output. Also used when building an image when the <code>scrawl.createImageFromEntity</code> function is invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.getCellCoverage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">img</span>) </span>{

        <span class="hljs-keyword">let</span> width = img.width,
            height = img.height,
            data = img.data,
            maxX = <span class="hljs-number">0</span>,
            maxY = <span class="hljs-number">0</span>,
            minX = width,
            minY = height,
            counter = <span class="hljs-number">3</span>,
            x, y;

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; height; y++) {

            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; width; x++) {

                <span class="hljs-keyword">if</span> (data[counter]) {

                    <span class="hljs-keyword">if</span> (minX &gt; x) minX = x;
                    <span class="hljs-keyword">if</span> (maxX &lt; x) maxX = x;
                    <span class="hljs-keyword">if</span> (minY &gt; y) minY = y;
                    <span class="hljs-keyword">if</span> (maxY &lt; y) maxY = y;
                }

                counter += <span class="hljs-number">4</span>;
            }
        }
        <span class="hljs-keyword">if</span> (minX &lt; maxX &amp;&amp; minY &lt; maxY) <span class="hljs-keyword">return</span> [minX, minY, maxX - minX, maxY - minY];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p><code>simpleStamp</code> - an alternative to the <code>stamp</code> function, to get an entity to stamp its output onto a Cell.</p>
<ul>
<li>Note that this is a synchronous action, thus cannot be included in a Display cycle cascade.</li>
<li>Will ignore any filters assigned to the entity (because they require asynchronous Promises for the Filter web worker)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.simpleStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">host, changes = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">&#x27;Cell&#x27;</span>) {

            <span class="hljs-built_in">this</span>.currentHost = host;
            
            <span class="hljs-built_in">this</span>.set(changes);
            <span class="hljs-built_in">this</span>.prepareStamp();

            <span class="hljs-built_in">this</span>.regularStampSynchronousActions();
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <h5 id="stamping-the-entity-onto-a-cell-wrapper-canvas-element">Stamping the entity onto a Cell wrapper &lt;canvas&gt; element</h5>
<p><code>regularStampSynchronousActions</code> - this function <strong><em>coordinates the actions required</em></strong> for an entity to display its output on a Cell wrapper’s &lt;canvas&gt; element.</p>
<p>Scrawl-canvas stamps an entity onto a Cell by moving and rotating the Cell engine’s <code>transformation</code> (its coordinate grid) to match the entity’s <strong>start</strong> and <strong>offset</strong> coordinates, alongside any requirements to rotate (<strong>roll</strong>) and flip (<strong>flipReverse</strong>, <strong>flipUpend</strong>) the transformation as set out by the entity object.</p>
<ul>
<li>We use the Web API CanvasRenderingContext2D engine’s <code>setTransform</code> method to perform these actions when we invoke the Cell wrapper’s <strong>rotateDestination</strong> function.</li>
<li><strong><em>We never invoke the engine’s <code>translate</code>, <code>rotate</code> or <code>scale</code> methods</em></strong> on the transformation. All positional, rotational and scaling data is kept in the entity object, and calculated as part of its <strong>prepareStamp</strong> step. This means we don’t need to keep track of the transformation’s current state, and makes the entity stamping operation more efficient.</li>
<li>Scrawl-canvas <strong>does not support skew operations</strong> on the transformation - use a more appropriately shaped entity instead.</li>
<li>Scrawl-canvas <strong>does not support non-isometric scaling</strong> (applying different scaling factors along the x and y axes) - most entitys include width and height attributes: use those instead.</li>
<li>We only use the transformation’s <code>save</code> and <code>restore</code> methods where it makes sense to do so - for instance in very limited actions where the save and restore invocations are close enough in the code base that we don’t lose sight of them (and remember to restore after the action completes). They are <strong><em>not</em></strong> used when updating the engine’s attributes to match an entity’s stamping requirements!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.regularStampSynchronousActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Get a handle to the Cell wrapper - which needs to be assigned and checked prior to calling this function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> dest = <span class="hljs-built_in">this</span>.currentHost;

        <span class="hljs-keyword">if</span> (dest) {

            <span class="hljs-keyword">let</span> engine = dest.engine,
                stamp = <span class="hljs-built_in">this</span>.currentStampPosition,
                x = stamp[<span class="hljs-number">0</span>],
                y = stamp[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Get the Cell wrapper to perform required transformations on its &lt;canvas&gt; element’s 2D engine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            dest.rotateDestination(engine, x, y, <span class="hljs-built_in">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Get the Cell wrapper to update its 2D engine’s attributes to match the entity’s requirements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.noCanvasEngineUpdates) dest.setEngine(<span class="hljs-built_in">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Invoke the appropriate <strong>stamping method</strong> (below)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">this</span>[<span class="hljs-built_in">this</span>.method](engine);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h5 id="stamp-methods">Stamp methods</h5>
<p>All actual drawing is achieved using the entity’s pre-calculated <a href="https://developer.mozilla.org/en-US/docs/Web/API/Path2D">Path2D object</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p><code>draw</code> - stroke the entity outline with the entity’s <code>strokeStyle</code> color, gradient or pattern - including shadow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.draw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        engine.stroke(<span class="hljs-built_in">this</span>.pathObject);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p><code>fill</code> - fill the entity with the entity’s <code>fillStyle</code> color, gradient or pattern - including shadow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.fill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        engine.fill(<span class="hljs-built_in">this</span>.pathObject, <span class="hljs-built_in">this</span>.winding);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p><code>drawAndFill</code> - stroke the entity’s outline, remove shadow, then fill it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.drawAndFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">this</span>.pathObject;

        engine.stroke(p);
        <span class="hljs-built_in">this</span>.currentHost.clearShadow();
        engine.fill(p, <span class="hljs-built_in">this</span>.winding);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p><code>fillAndDraw</code> - fill the entity’s outline, remove shadow, then stroke it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.fillAndDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">this</span>.pathObject;

        engine.stroke(p);
        <span class="hljs-built_in">this</span>.currentHost.clearShadow();
        engine.fill(p, <span class="hljs-built_in">this</span>.winding);
        engine.stroke(p);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><code>drawThenFill</code> - stroke the entity’s outline, then fill it (shadow applied twice)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.drawThenFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">this</span>.pathObject;

        engine.stroke(p);
        engine.fill(p, <span class="hljs-built_in">this</span>.winding);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><code>fillThenDraw</code> - fill the entity’s outline, then stroke it (shadow applied twice)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.fillThenDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-built_in">this</span>.pathObject;

        engine.fill(p, <span class="hljs-built_in">this</span>.winding);
        engine.stroke(p);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p><code>clear</code> - remove everything that would have been covered if the entity had performed fill (including shadow)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.clear = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> gco = engine.globalCompositeOperation;

        engine.globalCompositeOperation = <span class="hljs-string">&#x27;destination-out&#x27;</span>;
        engine.fill(<span class="hljs-built_in">this</span>.pathObject, <span class="hljs-built_in">this</span>.winding);
        
        engine.globalCompositeOperation = gco;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><code>none</code> - perform all the calculations required, but don’t perform the final stamping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.none = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Return the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> P;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
